const a1_0x531c57=a1_0x211b;(function(_0x12f494,_0x302bd2){const _0x202c26=a1_0x211b,_0x31145e=_0x12f494();while(!![]){try{const _0x2e6076=-parseInt(_0x202c26(0x179))/0x1*(-parseInt(_0x202c26(0x184))/0x2)+parseInt(_0x202c26(0x19c))/0x3+parseInt(_0x202c26(0x1ac))/0x4*(parseInt(_0x202c26(0x19f))/0x5)+parseInt(_0x202c26(0x17c))/0x6*(-parseInt(_0x202c26(0x1ba))/0x7)+parseInt(_0x202c26(0x193))/0x8*(parseInt(_0x202c26(0x1bc))/0x9)+-parseInt(_0x202c26(0x1ad))/0xa+-parseInt(_0x202c26(0x187))/0xb*(parseInt(_0x202c26(0x18e))/0xc);if(_0x2e6076===_0x302bd2)break;else _0x31145e['push'](_0x31145e['shift']());}catch(_0xf37a65){_0x31145e['push'](_0x31145e['shift']());}}}(a1_0x2bd5,0xccb1f));const jwt=require(a1_0x531c57(0x197)),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require(a1_0x531c57(0x190)),multer=require(a1_0x531c57(0x1a8)),fs=require('fs'),verifyToken=require('../libs/jwt')[a1_0x531c57(0x176)];!fs['existsSync']('./avatars')&&fs[a1_0x531c57(0x199)](a1_0x531c57(0x182));const express=require(a1_0x531c57(0x1b9)),router=express['Router'](),{randomUUID}=require(a1_0x531c57(0x19b)),storage=multer[a1_0x531c57(0x1b8)]({'destination':function(_0x455f90,_0x125a4b,_0x3931a6){const _0x183f6f=a1_0x531c57;_0x3931a6(null,_0x183f6f(0x1b5));}}),upload=multer({'storage':storage});function a1_0x211b(_0x204787,_0x51bc6f){const _0x2bd508=a1_0x2bd5();return a1_0x211b=function(_0x211b04,_0x132ac){_0x211b04=_0x211b04-0x174;let _0x1b5586=_0x2bd508[_0x211b04];return _0x1b5586;},a1_0x211b(_0x204787,_0x51bc6f);}router[a1_0x531c57(0x178)](a1_0x531c57(0x17d),async(_0x11d78b,_0x2a551b,_0x3f5b08)=>{const _0x1178f2=a1_0x531c57;let {email:_0xbe47c0,password:_0x4aa936}=_0x11d78b['body'];console[_0x1178f2(0x185)]({'email':_0xbe47c0,'password':_0x4aa936});let _0x57267b;try{const [_0x561ed2]=await conn[_0x1178f2(0x1bd)]()['execute'](_0x1178f2(0x196),[_0xbe47c0]);_0x561ed2['length']>0x0&&(_0x57267b=_0x561ed2[0x0]);}catch(_0x54896d){console[_0x1178f2(0x185)]({'err':_0x54896d}),_0x2a551b[_0x1178f2(0x174)](0x1f4)[_0x1178f2(0x1b7)]({'error':_0x1178f2(0x181)});return;}if(!_0x57267b||!await bcrypt[_0x1178f2(0x1a6)](_0x4aa936,_0x57267b?.[_0x1178f2(0x191)])){_0x2a551b[_0x1178f2(0x174)](0x191)[_0x1178f2(0x1b7)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x3bddbf;try{_0x3bddbf=jwt[_0x1178f2(0x1ab)]({'userId':_0x57267b['id'],'email':_0x57267b[_0x1178f2(0x1a7)]},config[_0x1178f2(0x1a4)],{'expiresIn':'24h'});}catch(_0x36d251){console[_0x1178f2(0x185)](_0x36d251),_0x2a551b[_0x1178f2(0x174)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x2a551b['status'](0xc8)[_0x1178f2(0x1b7)]({'success':!![],'data':{'userId':_0x57267b['id'],'username':_0x57267b[_0x1178f2(0x19e)],'first_name':_0x57267b['first_name'],'last_name':_0x57267b[_0x1178f2(0x17a)],'email':_0x57267b[_0x1178f2(0x1a7)],'avatar_url':_0x57267b['avatar_url'],'id':_0x57267b['id'],'role':_0x57267b['role'],'token':_0x3bddbf}});}),router[a1_0x531c57(0x178)](a1_0x531c57(0x194),async(_0x94364d,_0x43af70,_0x86bedb)=>{const _0x2758aa=a1_0x531c57,{username:_0x159f76,email:_0x5861c8,password:_0x420a85}=_0x94364d[_0x2758aa(0x1b6)],[_0x302fb1]=await conn[_0x2758aa(0x1bd)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x5861c8]);if(_0x302fb1['length']>0x0){_0x43af70['status'](0x1a6)['json']({'error':_0x2758aa(0x188)});return;}const _0x4366ac=await bcrypt[_0x2758aa(0x189)](_0x420a85,0xa);let _0x59e633=null,_0x906b77=0x1;config[_0x2758aa(0x1ae)]&&(_0x59e633=randomUUID(),_0x906b77=0x0);let _0x59f46f;try{const _0x349cf6=randomUUID(),_0x17c906='./uploads/'+_0x349cf6;fs[_0x2758aa(0x199)](_0x17c906);const [_0x1e3327]=await conn[_0x2758aa(0x1bd)]()[_0x2758aa(0x1b0)](_0x2758aa(0x1b1),[_0x159f76,_0x5861c8,_0x4366ac,'demo_user',_0x906b77,_0x59e633,_0x349cf6]);if(_0x1e3327[_0x2758aa(0x1c0)]){const [_0x201edf]=await conn[_0x2758aa(0x1bd)]()['execute'](_0x2758aa(0x186),[_0x1e3327[_0x2758aa(0x1c0)]]);_0x201edf[_0x2758aa(0x183)]>0x0&&(_0x59f46f=_0x201edf[0x0]);}}catch{_0x43af70[_0x2758aa(0x174)](0x1f4)[_0x2758aa(0x1b7)]({'error':_0x2758aa(0x181)});return;}let _0x496aec;try{_0x496aec=jwt[_0x2758aa(0x1ab)]({'userId':_0x59f46f['id'],'email':_0x59f46f[_0x2758aa(0x1a7)]},config[_0x2758aa(0x1a4)],{'expiresIn':_0x2758aa(0x1a1)});}catch(_0x3d9576){_0x43af70[_0x2758aa(0x174)](0x1f4)[_0x2758aa(0x1b7)]({'error':_0x2758aa(0x181)});return;}const _0x472c10=require('../libs/mail')[_0x2758aa(0x1a9)];let _0x254630='<p>Welcome\x20to\x20CADViewer</p>';if(config['enableEmailVerification']){const _0x2bf167=config[_0x2758aa(0x19a)]+_0x2758aa(0x1af)+_0x59e633;_0x254630=_0x2758aa(0x195)+_0x2bf167+_0x2758aa(0x18c)+_0x2bf167+_0x2758aa(0x17b);const _0x2a9cad={'from':config[_0x2758aa(0x18d)],'to':_0x59f46f[_0x2758aa(0x1a7)],'subject':_0x2758aa(0x177),'text':_0x2758aa(0x177),'html':_0x254630};try{await _0x472c10[_0x2758aa(0x17f)](_0x2a9cad);}catch(_0x218788){console[_0x2758aa(0x185)]('===================error==================='),console[_0x2758aa(0x185)](_0x218788),_0x43af70[_0x2758aa(0x174)](0x1f4)[_0x2758aa(0x1b7)]({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0x218788['stack'],'message':_0x218788['message']});return;}_0x43af70[_0x2758aa(0x174)](0xc8)[_0x2758aa(0x1b7)]({'success':!![],'message':_0x2758aa(0x180)});return;}_0x43af70['status'](0xc9)[_0x2758aa(0x1b7)]({'success':!![],'data':{'userId':_0x59f46f['id'],'username':_0x59f46f[_0x2758aa(0x19e)],'first_name':_0x59f46f[_0x2758aa(0x1bf)],'last_name':_0x59f46f[_0x2758aa(0x17a)],'email':_0x59f46f[_0x2758aa(0x1a7)],'avatar_url':_0x59f46f[_0x2758aa(0x1b4)],'id':_0x59f46f['id'],'role':_0x59f46f[_0x2758aa(0x1b2)],'token':_0x496aec,'is_enabled':_0x59f46f[_0x2758aa(0x18b)]}});}),router[a1_0x531c57(0x178)](a1_0x531c57(0x1a2),async(_0x12574d,_0x297f75)=>{const _0x3b56f2=a1_0x531c57;try{const {token:_0x3e8705}=_0x12574d['params'],[_0x27da4e]=await conn['promise']()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0x3e8705]);if(_0x27da4e[_0x3b56f2(0x183)]===0x0){_0x297f75['status'](0x194)[_0x3b56f2(0x1b7)]({'error':'Invalid\x20validation\x20token'});return;}await conn[_0x3b56f2(0x1bd)]()['execute']('UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?',[_0x3e8705]);const _0x1d82c9=jwt['sign']({'id':_0x27da4e[0x0]['id'],'email':_0x27da4e[0x0][_0x3b56f2(0x1a7)]},config[_0x3b56f2(0x1a4)],{'expiresIn':_0x3b56f2(0x1a1)});_0x297f75['status'](0xc8)[_0x3b56f2(0x1b7)]({'success':!![],'message':_0x3b56f2(0x19d),'data':{'userId':_0x27da4e[0x0]['id'],'username':_0x27da4e[0x0][_0x3b56f2(0x19e)],'first_name':_0x27da4e[0x0][_0x3b56f2(0x1bf)],'last_name':_0x27da4e[0x0]['last_name'],'email':_0x27da4e[0x0]['email'],'avatar_url':_0x27da4e[0x0][_0x3b56f2(0x1b4)],'id':_0x27da4e[0x0]['id'],'role':_0x27da4e[0x0][_0x3b56f2(0x1b2)],'token':_0x1d82c9,'is_enabled':0x1}});}catch(_0x510d67){console[_0x3b56f2(0x185)]('===================error==================='),console['log'](_0x510d67),_0x297f75['status'](0x1f4)[_0x3b56f2(0x1b7)]({'error':_0x3b56f2(0x181),'stack':_0x510d67['stack'],'message':_0x510d67[_0x3b56f2(0x1a0)]});}}),router[a1_0x531c57(0x178)](a1_0x531c57(0x198),verifyToken,async(_0x5903d3,_0x5dab56,_0x26815e)=>{const _0x42f1bf=a1_0x531c57,{current_password:_0x278cc3,new_password:_0x2b08d3}=_0x5903d3[_0x42f1bf(0x1b6)];console[_0x42f1bf(0x185)]({'body':_0x5903d3[_0x42f1bf(0x1b6)]});const _0x3a52c1=_0x5903d3[_0x42f1bf(0x1aa)][_0x42f1bf(0x1a7)];let _0x249648;try{const [_0x4b0dd2]=await conn[_0x42f1bf(0x1bd)]()[_0x42f1bf(0x1b0)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x3a52c1]);if(_0x4b0dd2[_0x42f1bf(0x183)]>0x0){_0x249648=_0x4b0dd2[0x0];if(!await bcrypt[_0x42f1bf(0x1a6)](_0x278cc3,_0x249648['crypted_password'])){_0x5dab56['status'](0x191)[_0x42f1bf(0x1b7)]({'error':_0x42f1bf(0x17e)});return;}const _0x3332df=await bcrypt[_0x42f1bf(0x189)](_0x2b08d3,0xa);await conn[_0x42f1bf(0x1bd)]()[_0x42f1bf(0x1b0)]('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x3332df,_0x3a52c1]),_0x5dab56[_0x42f1bf(0x174)](0xc8)['json']({'success':!![]});}}catch(_0x130a12){console[_0x42f1bf(0x185)]({'err':_0x130a12}),_0x5dab56[_0x42f1bf(0x174)](0x1f4)[_0x42f1bf(0x1b7)]({'error':_0x42f1bf(0x181)});return;}}),router['post'](a1_0x531c57(0x18f),upload[a1_0x531c57(0x1a3)](a1_0x531c57(0x192)),verifyToken,async(_0x34525f,_0x2754f7,_0x594a75)=>{const _0x4bdcf9=a1_0x531c57,{username:_0x22dd6c,first_name:_0x10f47b,last_name:_0x56f793}=_0x34525f[_0x4bdcf9(0x1b6)],_0x518e6f=_0x34525f[_0x4bdcf9(0x1aa)][_0x4bdcf9(0x1a7)];let _0x1af280;try{const [_0x553783]=await conn[_0x4bdcf9(0x1bd)]()[_0x4bdcf9(0x1b0)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x518e6f]);_0x553783[_0x4bdcf9(0x183)]>0x0&&(_0x1af280=_0x553783[0x0]);}catch(_0x3568ee){console[_0x4bdcf9(0x185)]({'err':_0x3568ee}),_0x2754f7[_0x4bdcf9(0x174)](0x1f4)['json']({'error':_0x4bdcf9(0x181)});return;}if(!_0x1af280){_0x2754f7[_0x4bdcf9(0x174)](0x191)[_0x4bdcf9(0x1b7)]({'error':'Invalid\x20user'});return;}console[_0x4bdcf9(0x185)]({'req':_0x34525f[_0x4bdcf9(0x1b6)]});let _0xe45cb=_0x1af280[_0x4bdcf9(0x1b4)];if(_0x34525f['file']){const _0x5288ef='avatars/'+randomUUID()+_0x4bdcf9(0x1a5);fs[_0x4bdcf9(0x1be)](_0x34525f['file'][_0x4bdcf9(0x175)],'./'+_0x5288ef),fs['unlinkSync'](_0x34525f['file'][_0x4bdcf9(0x175)]),_0xe45cb=config[_0x4bdcf9(0x1bb)]+'/'+_0x5288ef;}try{await conn[_0x4bdcf9(0x1bd)]()[_0x4bdcf9(0x1b0)](_0x4bdcf9(0x1b3),[_0x22dd6c,_0x10f47b,_0x56f793,_0xe45cb,_0x518e6f]);let _0xb9f70b;try{_0xb9f70b=jwt[_0x4bdcf9(0x1ab)]({'userId':_0x1af280['id'],'email':_0x1af280[_0x4bdcf9(0x1a7)]},config['jwtSecretKey'],{'expiresIn':_0x4bdcf9(0x1a1)});}catch(_0x1a4ff9){console[_0x4bdcf9(0x185)](_0x1a4ff9),_0x2754f7[_0x4bdcf9(0x174)](0x1f4)[_0x4bdcf9(0x1b7)]({'error':_0x4bdcf9(0x181)});return;}_0x2754f7[_0x4bdcf9(0x174)](0xc8)[_0x4bdcf9(0x1b7)]({'success':!![],'data':{'userId':_0x1af280['id'],'username':_0x22dd6c,'first_name':_0x10f47b,'last_name':_0x56f793,'email':_0x1af280[_0x4bdcf9(0x1a7)],'avatar_url':_0xe45cb,'token':_0xb9f70b}});}catch(_0x2b2850){console['log']({'err':_0x2b2850}),_0x2754f7[_0x4bdcf9(0x174)](0x1f4)[_0x4bdcf9(0x1b7)]({'error':_0x4bdcf9(0x181)});return;}}),module[a1_0x531c57(0x18a)]=router;function a1_0x2bd5(){const _0x19d28e=['json','diskStorage','express','7294hMEJnG','ServerUrl','11051541QNKSDK','promise','copyFileSync','first_name','insertId','status','path','verifyToken','Welcome\x20to\x20CADViewer','post','176393ffTebt','last_name','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','3696qyOrSN','/login','Invalid\x20password','sendMail','Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account','Error!\x20Something\x20went\x20wrong.','./avatars','length','4xeMhfC','log','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','6974yrqcUH','User\x20already\x20exists','hash','exports','is_enabled','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','smtpFrom','4548oolOEZ','/update-user-info','../libs/mysql.js','crypted_password','avatar','8VSeNfG','/signup','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','jsonwebtoken','/update-password','mkdirSync','frontendUrl','crypto','17706WvkxDE','Email\x20validated\x20successfully','username','560jByRQa','message','24h','/validate-email/:token','single','jwtSecretKey','.png','compare','email','multer','transporter','user','sign','37020aroibD','9026080NUxEoI','enableEmailVerification','/validate-email/','execute','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','role','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','avatar_url','avatars','body'];a1_0x2bd5=function(){return _0x19d28e;};return a1_0x2bd5();}