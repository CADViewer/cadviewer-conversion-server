const a1_0x504b52=a1_0x1f18;(function(_0x4571ea,_0x1f57a7){const _0x3a7642=a1_0x1f18,_0x614fb8=_0x4571ea();while(!![]){try{const _0x5ad143=-parseInt(_0x3a7642(0xe4))/0x1+-parseInt(_0x3a7642(0xe3))/0x2*(-parseInt(_0x3a7642(0xb1))/0x3)+-parseInt(_0x3a7642(0xad))/0x4+parseInt(_0x3a7642(0xab))/0x5+-parseInt(_0x3a7642(0xb0))/0x6*(parseInt(_0x3a7642(0xbd))/0x7)+-parseInt(_0x3a7642(0xd4))/0x8*(-parseInt(_0x3a7642(0xcc))/0x9)+parseInt(_0x3a7642(0xca))/0xa;if(_0x5ad143===_0x1f57a7)break;else _0x614fb8['push'](_0x614fb8['shift']());}catch(_0x56fab8){_0x614fb8['push'](_0x614fb8['shift']());}}}(a1_0x31ca,0x7a51c));const jwt=require(a1_0x504b52(0x9b)),bcrypt=require(a1_0x504b52(0xdb)),config=require(a1_0x504b52(0xda)),conn=require('../libs/mysql.js'),multer=require(a1_0x504b52(0xd9)),fs=require('fs'),verifyToken=require(a1_0x504b52(0xc0))[a1_0x504b52(0xb8)];function a1_0x1f18(_0x2eb532,_0x1404a7){const _0x31ca91=a1_0x31ca();return a1_0x1f18=function(_0x1f183d,_0xe3b678){_0x1f183d=_0x1f183d-0x96;let _0x293181=_0x31ca91[_0x1f183d];return _0x293181;},a1_0x1f18(_0x2eb532,_0x1404a7);}!fs['existsSync']('./avatars')&&fs[a1_0x504b52(0x98)]('./avatars');const express=require(a1_0x504b52(0xba)),router=express['Router'](),{randomUUID}=require(a1_0x504b52(0x9c)),storage=multer[a1_0x504b52(0xdd)]({'destination':function(_0x2e8d51,_0x5c4fd5,_0x4b0d9b){const _0x137093=a1_0x504b52;_0x4b0d9b(null,_0x137093(0xe1));}}),upload=multer({'storage':storage});function a1_0x31ca(){const _0x6b840d=['19611hyZwgF','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','smtpFrom','Error!\x20Something\x20went\x20wrong.','params','/update-user-info','is_enabled','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL\x20WHERE\x20`validation_token`\x20=\x20?','1304tiKJId','role','ServerUrl','status','username','multer','../CADViewer_config.json','bcrypt','path','diskStorage','/validate-email/','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','/validate-email/:token','avatars','.png','306382zhofpB','764633RvYTQE','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','last_name','mkdirSync','24h','avatar_url','jsonwebtoken','crypto','sendMail','crypted_password','file','promise','json','message','exports','Invalid\x20password','jwtSecretKey','post','Email\x20validated\x20successfully','Welcome\x20to\x20CADViewer','user','Invalid\x20validation\x20token','1657400MycXLL','email','678136xgoPOn','avatar','../libs/mail','2820174BDotdC','9HvSsab','body','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','hash','length','===================error===================','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','verifyToken','enableEmailVerification','express','/update-password','<p>Welcome\x20to\x20CADViewer</p>','7oVmxES','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','compare','../libs/jwt','stack','log','first_name','/login','sign','insertId','avatars/','Invalid\x20email\x20or\x20password','Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','7589860OUmAay','execute'];a1_0x31ca=function(){return _0x6b840d;};return a1_0x31ca();}router[a1_0x504b52(0xa6)](a1_0x504b52(0xc4),async(_0x1b8c95,_0x3a7650,_0x477f78)=>{const _0x36838c=a1_0x504b52;let {email:_0x45b555,password:_0x37e813}=_0x1b8c95[_0x36838c(0xb2)];console[_0x36838c(0xc2)]({'email':_0x45b555,'password':_0x37e813});let _0x3dd439;try{const [_0x309f89]=await conn[_0x36838c(0xa0)]()['execute'](_0x36838c(0xdf),[_0x45b555]);_0x309f89[_0x36838c(0xb5)]>0x0&&(_0x3dd439=_0x309f89[0x0]);}catch(_0x15307d){console[_0x36838c(0xc2)]({'err':_0x15307d}),_0x3a7650[_0x36838c(0xd7)](0x1f4)[_0x36838c(0xa1)]({'error':_0x36838c(0xcf)});return;}console[_0x36838c(0xc2)](_0x3dd439),console[_0x36838c(0xc2)](_0x37e813),console['log'](_0x3dd439['crypted_password']);if(!_0x3dd439||!await bcrypt[_0x36838c(0xbf)](_0x37e813,_0x3dd439['crypted_password'])){_0x3a7650[_0x36838c(0xd7)](0x191)['json']({'error':_0x36838c(0xc8)});return;}let _0xdef094;try{_0xdef094=jwt['sign']({'userId':_0x3dd439['id'],'email':_0x3dd439['email']},config[_0x36838c(0xa5)],{'expiresIn':'24h'});}catch(_0x2170c4){console[_0x36838c(0xc2)](_0x2170c4),_0x3a7650[_0x36838c(0xd7)](0x1f4)[_0x36838c(0xa1)]({'error':_0x36838c(0xcf)});return;}_0x3a7650[_0x36838c(0xd7)](0xc8)[_0x36838c(0xa1)]({'success':!![],'data':{'userId':_0x3dd439['id'],'username':_0x3dd439[_0x36838c(0xd8)],'first_name':_0x3dd439[_0x36838c(0xc3)],'last_name':_0x3dd439[_0x36838c(0x97)],'email':_0x3dd439[_0x36838c(0xac)],'avatar_url':_0x3dd439[_0x36838c(0x9a)],'id':_0x3dd439['id'],'role':_0x3dd439[_0x36838c(0xd5)],'token':_0xdef094}});}),router[a1_0x504b52(0xa6)]('/signup',async(_0x4def14,_0x4c9e58,_0x5bce07)=>{const _0x3bd642=a1_0x504b52,{username:_0x4333fb,email:_0x503789,password:_0x4ebe82}=_0x4def14[_0x3bd642(0xb2)],[_0x20dff5]=await conn[_0x3bd642(0xa0)]()['execute'](_0x3bd642(0x96),[_0x503789]);if(_0x20dff5[_0x3bd642(0xb5)]>0x0){_0x4c9e58[_0x3bd642(0xd7)](0x1a6)[_0x3bd642(0xa1)]({'error':'User\x20already\x20exists'});return;}const _0x326b03=await bcrypt[_0x3bd642(0xb4)](_0x4ebe82,0xa);let _0x3c3183=null,_0x2d7a9e=0x1;config[_0x3bd642(0xb9)]&&(_0x3c3183=randomUUID(),_0x2d7a9e=0x0);let _0x5dc3c6;try{const [_0x188c9c]=await conn['promise']()[_0x3bd642(0xcb)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x4333fb,_0x503789,_0x326b03,'user',_0x2d7a9e,_0x3c3183]);if(_0x188c9c[_0x3bd642(0xc6)]){const [_0x582732]=await conn[_0x3bd642(0xa0)]()[_0x3bd642(0xcb)](_0x3bd642(0xb3),[_0x188c9c[_0x3bd642(0xc6)]]);_0x582732[_0x3bd642(0xb5)]>0x0&&(_0x5dc3c6=_0x582732[0x0]);}}catch{_0x4c9e58[_0x3bd642(0xd7)](0x1f4)[_0x3bd642(0xa1)]({'error':_0x3bd642(0xcf)});return;}let _0x5b964f;try{_0x5b964f=jwt[_0x3bd642(0xc5)]({'userId':_0x5dc3c6['id'],'email':_0x5dc3c6['email']},config[_0x3bd642(0xa5)],{'expiresIn':_0x3bd642(0x99)});}catch(_0x312ca3){_0x4c9e58['status'](0x1f4)[_0x3bd642(0xa1)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}const _0x3f3544=require(_0x3bd642(0xaf))['transporter'];let _0x394303=_0x3bd642(0xbc);if(config[_0x3bd642(0xb9)]){const _0x39c24b=config['frontendUrl']+_0x3bd642(0xde)+_0x3c3183;_0x394303=_0x3bd642(0xbe)+_0x39c24b+_0x3bd642(0xe5)+_0x39c24b+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20';const _0x23773d={'from':config[_0x3bd642(0xce)],'to':_0x5dc3c6['email'],'subject':'Welcome\x20to\x20CADViewer','text':_0x3bd642(0xa8),'html':_0x394303};try{await _0x3f3544[_0x3bd642(0x9d)](_0x23773d);}catch(_0x5b0c36){console['log'](_0x3bd642(0xb6)),console[_0x3bd642(0xc2)](_0x5b0c36),_0x4c9e58['status'](0x1f4)[_0x3bd642(0xa1)]({'error':_0x3bd642(0xc9),'stack':_0x5b0c36[_0x3bd642(0xc1)],'message':_0x5b0c36[_0x3bd642(0xa2)]});return;}_0x4c9e58[_0x3bd642(0xd7)](0xc8)[_0x3bd642(0xa1)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account'});return;}_0x4c9e58[_0x3bd642(0xd7)](0xc9)[_0x3bd642(0xa1)]({'success':!![],'data':{'userId':_0x5dc3c6['id'],'username':_0x5dc3c6[_0x3bd642(0xd8)],'first_name':_0x5dc3c6[_0x3bd642(0xc3)],'last_name':_0x5dc3c6['last_name'],'email':_0x5dc3c6[_0x3bd642(0xac)],'avatar_url':_0x5dc3c6['avatar_url'],'id':_0x5dc3c6['id'],'role':_0x5dc3c6[_0x3bd642(0xd5)],'token':_0x5b964f,'is_enabled':_0x5dc3c6[_0x3bd642(0xd2)]}});}),router[a1_0x504b52(0xa6)](a1_0x504b52(0xe0),async(_0xa86aaf,_0x30ea6e)=>{const _0x5b5bf6=a1_0x504b52;try{const {token:_0x3de934}=_0xa86aaf[_0x5b5bf6(0xd0)],[_0x467d44]=await conn['promise']()[_0x5b5bf6(0xcb)](_0x5b5bf6(0xcd),[_0x3de934]);if(_0x467d44[_0x5b5bf6(0xb5)]===0x0){_0x30ea6e[_0x5b5bf6(0xd7)](0x194)[_0x5b5bf6(0xa1)]({'error':_0x5b5bf6(0xaa)});return;}await conn[_0x5b5bf6(0xa0)]()[_0x5b5bf6(0xcb)](_0x5b5bf6(0xd3),[_0x3de934]);const _0x19da21=jwt[_0x5b5bf6(0xc5)]({'id':_0x467d44[0x0]['id'],'email':_0x467d44[0x0][_0x5b5bf6(0xac)]},config[_0x5b5bf6(0xa5)],{'expiresIn':_0x5b5bf6(0x99)});_0x30ea6e[_0x5b5bf6(0xd7)](0xc8)[_0x5b5bf6(0xa1)]({'success':!![],'message':_0x5b5bf6(0xa7),'data':{'userId':_0x467d44[0x0]['id'],'username':_0x467d44[0x0][_0x5b5bf6(0xd8)],'first_name':_0x467d44[0x0][_0x5b5bf6(0xc3)],'last_name':_0x467d44[0x0][_0x5b5bf6(0x97)],'email':_0x467d44[0x0][_0x5b5bf6(0xac)],'avatar_url':_0x467d44[0x0]['avatar_url'],'id':_0x467d44[0x0]['id'],'role':_0x467d44[0x0][_0x5b5bf6(0xd5)],'token':_0x19da21,'is_enabled':0x1}});}catch(_0x115ccb){console[_0x5b5bf6(0xc2)](_0x5b5bf6(0xb6)),console[_0x5b5bf6(0xc2)](_0x115ccb),_0x30ea6e[_0x5b5bf6(0xd7)](0x1f4)[_0x5b5bf6(0xa1)]({'error':_0x5b5bf6(0xcf),'stack':_0x115ccb[_0x5b5bf6(0xc1)],'message':_0x115ccb[_0x5b5bf6(0xa2)]});}}),router[a1_0x504b52(0xa6)](a1_0x504b52(0xbb),verifyToken,async(_0x5eb50f,_0x1967e2,_0x439f4b)=>{const _0x580db5=a1_0x504b52,{current_password:_0x32cf2a,new_password:_0x4d2848}=_0x5eb50f[_0x580db5(0xb2)];console['log']({'body':_0x5eb50f['body']});const _0x20df26=_0x5eb50f[_0x580db5(0xa9)][_0x580db5(0xac)];let _0x47d2b0;try{const [_0x1c9db5]=await conn[_0x580db5(0xa0)]()[_0x580db5(0xcb)](_0x580db5(0x96),[_0x20df26]);if(_0x1c9db5[_0x580db5(0xb5)]>0x0){_0x47d2b0=_0x1c9db5[0x0];if(!await bcrypt[_0x580db5(0xbf)](_0x32cf2a,_0x47d2b0[_0x580db5(0x9e)])){_0x1967e2['status'](0x191)[_0x580db5(0xa1)]({'error':_0x580db5(0xa4)});return;}const _0x3a784a=await bcrypt[_0x580db5(0xb4)](_0x4d2848,0xa);await conn['promise']()['execute']('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x3a784a,_0x20df26]),_0x1967e2[_0x580db5(0xd7)](0xc8)['json']({'success':!![]});}}catch(_0x1849f5){console[_0x580db5(0xc2)]({'err':_0x1849f5}),_0x1967e2['status'](0x1f4)['json']({'error':_0x580db5(0xcf)});return;}}),router['post'](a1_0x504b52(0xd1),upload['single'](a1_0x504b52(0xae)),verifyToken,async(_0x143e1e,_0x22def1,_0x566d0c)=>{const _0x2dd4cf=a1_0x504b52,{username:_0x1e29f7,first_name:_0x32d261,last_name:_0x3e9cf1}=_0x143e1e[_0x2dd4cf(0xb2)],_0x37b5d9=_0x143e1e[_0x2dd4cf(0xa9)]['email'];let _0x31849e;try{const [_0x1c51fb]=await conn[_0x2dd4cf(0xa0)]()[_0x2dd4cf(0xcb)](_0x2dd4cf(0x96),[_0x37b5d9]);_0x1c51fb[_0x2dd4cf(0xb5)]>0x0&&(_0x31849e=_0x1c51fb[0x0]);}catch(_0x3ab904){console[_0x2dd4cf(0xc2)]({'err':_0x3ab904}),_0x22def1[_0x2dd4cf(0xd7)](0x1f4)[_0x2dd4cf(0xa1)]({'error':_0x2dd4cf(0xcf)});return;}if(!_0x31849e){_0x22def1['status'](0x191)[_0x2dd4cf(0xa1)]({'error':'Invalid\x20user'});return;}console['log']({'req':_0x143e1e[_0x2dd4cf(0xb2)]});let _0x3ecaa9=_0x31849e['avatar_url'];if(_0x143e1e[_0x2dd4cf(0x9f)]){const _0x2659c2=_0x2dd4cf(0xc7)+randomUUID()+_0x2dd4cf(0xe2);fs['renameSync'](_0x143e1e[_0x2dd4cf(0x9f)][_0x2dd4cf(0xdc)],'./'+_0x2659c2),_0x3ecaa9=config[_0x2dd4cf(0xd6)]+'/'+_0x2659c2;}try{await conn['promise']()[_0x2dd4cf(0xcb)](_0x2dd4cf(0xb7),[_0x1e29f7,_0x32d261,_0x3e9cf1,_0x3ecaa9,_0x37b5d9]);let _0x31f6ae;try{_0x31f6ae=jwt[_0x2dd4cf(0xc5)]({'userId':_0x31849e['id'],'email':_0x31849e[_0x2dd4cf(0xac)]},config['jwtSecretKey'],{'expiresIn':_0x2dd4cf(0x99)});}catch(_0xa45e01){console[_0x2dd4cf(0xc2)](_0xa45e01),_0x22def1['status'](0x1f4)[_0x2dd4cf(0xa1)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x22def1['status'](0xc8)[_0x2dd4cf(0xa1)]({'success':!![],'data':{'userId':_0x31849e['id'],'username':_0x1e29f7,'first_name':_0x32d261,'last_name':_0x3e9cf1,'email':_0x31849e[_0x2dd4cf(0xac)],'avatar_url':_0x3ecaa9,'token':_0x31f6ae}});}catch(_0x594296){console[_0x2dd4cf(0xc2)]({'err':_0x594296}),_0x22def1[_0x2dd4cf(0xd7)](0x1f4)[_0x2dd4cf(0xa1)]({'error':_0x2dd4cf(0xcf)});return;}}),module[a1_0x504b52(0xa3)]=router;