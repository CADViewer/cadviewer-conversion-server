const a1_0x1da82d=a1_0x23ca;function a1_0x23ca(_0x7fca8b,_0x1f5d99){const _0x5539ef=a1_0x5539();return a1_0x23ca=function(_0x23ca5a,_0x30f333){_0x23ca5a=_0x23ca5a-0x108;let _0x9a9f1b=_0x5539ef[_0x23ca5a];return _0x9a9f1b;},a1_0x23ca(_0x7fca8b,_0x1f5d99);}(function(_0xb266d0,_0x387b56){const _0x36873f=a1_0x23ca,_0x3c700e=_0xb266d0();while(!![]){try{const _0xff4e78=-parseInt(_0x36873f(0x128))/0x1*(-parseInt(_0x36873f(0x15b))/0x2)+-parseInt(_0x36873f(0x136))/0x3+-parseInt(_0x36873f(0x154))/0x4*(-parseInt(_0x36873f(0x115))/0x5)+parseInt(_0x36873f(0x156))/0x6+-parseInt(_0x36873f(0x121))/0x7*(parseInt(_0x36873f(0x110))/0x8)+-parseInt(_0x36873f(0x14e))/0x9+parseInt(_0x36873f(0x12c))/0xa*(parseInt(_0x36873f(0x15a))/0xb);if(_0xff4e78===_0x387b56)break;else _0x3c700e['push'](_0x3c700e['shift']());}catch(_0x585e85){_0x3c700e['push'](_0x3c700e['shift']());}}}(a1_0x5539,0xbade2));const jwt=require(a1_0x1da82d(0x153)),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x1da82d(0x11a)),fs=require('fs'),verifyToken=require(a1_0x1da82d(0x11f))[a1_0x1da82d(0x145)];!fs[a1_0x1da82d(0x112)](a1_0x1da82d(0x138))&&fs[a1_0x1da82d(0x13c)]('./avatars');const express=require('express'),router=express[a1_0x1da82d(0x12d)](),{randomUUID}=require(a1_0x1da82d(0x151)),storage=multer[a1_0x1da82d(0x11b)]({'destination':function(_0x5c95f2,_0x1d376e,_0x1f8b39){const _0x54e165=a1_0x1da82d;_0x1f8b39(null,_0x54e165(0x144));}}),upload=multer({'storage':storage});function a1_0x5539(){const _0x574055=['Error!\x20Something\x20went\x20wrong.','/login','100Rkvpwf','Router','renameSync','execute','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','log','/validate-email/:token','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account','1554495mRUFZS','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','./avatars','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','hash','mkdirSync','Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','username','first_name','./uploads/','===================error===================','Welcome\x20to\x20CADViewer','../libs/mail','avatars','verifyToken','post','single','path','sign','sendMail','params','jwtSecretKey','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','6832647MieBjP','promise','avatar_url','crypto','user','jsonwebtoken','480540hUphVN','ServerUrl','6850794ATQgoR','avatar','Invalid\x20validation\x20token','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','824505gyQEVo','7036wbztXA','is_enabled','<p>Welcome\x20to\x20CADViewer</p>','Invalid\x20user','/update-user-info','24h','smtpFrom','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Invalid\x20password','322192FTahRI','avatars/','existsSync','length','email','15lYQRHe','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','message','demo_user','file','multer','diskStorage','compare','status','body','../libs/jwt','role','147nLyWxL','frontendUrl','stack','exports','json','crypted_password','last_name','181cnlkJU','insertId'];a1_0x5539=function(){return _0x574055;};return a1_0x5539();}router[a1_0x1da82d(0x146)](a1_0x1da82d(0x12b),async(_0x23003b,_0x2551ce,_0x5e71a9)=>{const _0x57ae19=a1_0x1da82d;let {email:_0x7e9e23,password:_0x4a0350}=_0x23003b[_0x57ae19(0x11e)];console['log']({'email':_0x7e9e23,'password':_0x4a0350});let _0x3d72f9;try{const [_0x4d322f]=await conn['promise']()[_0x57ae19(0x12f)](_0x57ae19(0x137),[_0x7e9e23]);_0x4d322f[_0x57ae19(0x113)]>0x0&&(_0x3d72f9=_0x4d322f[0x0]);}catch(_0x3d75e7){console[_0x57ae19(0x132)]({'err':_0x3d75e7}),_0x2551ce[_0x57ae19(0x11d)](0x1f4)[_0x57ae19(0x125)]({'error':_0x57ae19(0x12a)});return;}if(!_0x3d72f9||!await bcrypt['compare'](_0x4a0350,_0x3d72f9?.[_0x57ae19(0x126)])){_0x2551ce[_0x57ae19(0x11d)](0x191)[_0x57ae19(0x125)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0xf13598;try{_0xf13598=jwt['sign']({'userId':_0x3d72f9['id'],'email':_0x3d72f9[_0x57ae19(0x114)]},config['jwtSecretKey'],{'expiresIn':'24h'});}catch(_0x1145d5){console[_0x57ae19(0x132)](_0x1145d5),_0x2551ce[_0x57ae19(0x11d)](0x1f4)[_0x57ae19(0x125)]({'error':_0x57ae19(0x12a)});return;}_0x2551ce[_0x57ae19(0x11d)](0xc8)[_0x57ae19(0x125)]({'success':!![],'data':{'userId':_0x3d72f9['id'],'username':_0x3d72f9[_0x57ae19(0x13e)],'first_name':_0x3d72f9[_0x57ae19(0x13f)],'last_name':_0x3d72f9[_0x57ae19(0x127)],'email':_0x3d72f9['email'],'avatar_url':_0x3d72f9[_0x57ae19(0x150)],'id':_0x3d72f9['id'],'role':_0x3d72f9['role'],'token':_0xf13598}});}),router[a1_0x1da82d(0x146)]('/signup',async(_0x438fbe,_0x5fe483,_0x3903fd)=>{const _0x23e42b=a1_0x1da82d,{username:_0x32e040,email:_0x23baae,password:_0x2a1d12}=_0x438fbe[_0x23e42b(0x11e)],[_0x2157aa]=await conn[_0x23e42b(0x14f)]()[_0x23e42b(0x12f)](_0x23e42b(0x139),[_0x23baae]);if(_0x2157aa[_0x23e42b(0x113)]>0x0){_0x5fe483[_0x23e42b(0x11d)](0x1a6)['json']({'error':'User\x20already\x20exists'});return;}const _0x3bbfd6=await bcrypt[_0x23e42b(0x13b)](_0x2a1d12,0xa);let _0xc54473=null,_0x310468=0x1;config['enableEmailVerification']&&(_0xc54473=randomUUID(),_0x310468=0x0);let _0x254e47;try{const _0x3e2e92=randomUUID(),_0x2aceea=_0x23e42b(0x140)+_0x3e2e92;fs[_0x23e42b(0x13c)](_0x2aceea);const [_0x3c9a99]=await conn[_0x23e42b(0x14f)]()[_0x23e42b(0x12f)](_0x23e42b(0x116),[_0x32e040,_0x23baae,_0x3bbfd6,_0x23e42b(0x118),_0x310468,_0xc54473,_0x3e2e92]);if(_0x3c9a99[_0x23e42b(0x129)]){const [_0x1e3269]=await conn['promise']()[_0x23e42b(0x12f)](_0x23e42b(0x159),[_0x3c9a99['insertId']]);_0x1e3269[_0x23e42b(0x113)]>0x0&&(_0x254e47=_0x1e3269[0x0]);}}catch{_0x5fe483['status'](0x1f4)[_0x23e42b(0x125)]({'error':_0x23e42b(0x12a)});return;}let _0x53b33f;try{_0x53b33f=jwt[_0x23e42b(0x149)]({'userId':_0x254e47['id'],'email':_0x254e47['email']},config[_0x23e42b(0x14c)],{'expiresIn':_0x23e42b(0x10c)});}catch(_0x4e580d){_0x5fe483[_0x23e42b(0x11d)](0x1f4)[_0x23e42b(0x125)]({'error':_0x23e42b(0x12a)});return;}const _0x300575=require(_0x23e42b(0x143))['transporter'];let _0x139bee=_0x23e42b(0x109);if(config['enableEmailVerification']){const _0x28983a=config[_0x23e42b(0x122)]+'/validate-email/'+_0xc54473;_0x139bee=_0x23e42b(0x130)+_0x28983a+_0x23e42b(0x14d)+_0x28983a+_0x23e42b(0x13a);const _0x5048c4={'from':config[_0x23e42b(0x10d)],'to':_0x254e47['email'],'subject':_0x23e42b(0x142),'text':_0x23e42b(0x142),'html':_0x139bee};try{await _0x300575[_0x23e42b(0x14a)](_0x5048c4);}catch(_0x4ad5e7){console['log'](_0x23e42b(0x141)),console[_0x23e42b(0x132)](_0x4ad5e7),_0x5fe483[_0x23e42b(0x11d)](0x1f4)[_0x23e42b(0x125)]({'error':_0x23e42b(0x13d),'stack':_0x4ad5e7['stack'],'message':_0x4ad5e7[_0x23e42b(0x117)]});return;}_0x5fe483['status'](0xc8)[_0x23e42b(0x125)]({'success':!![],'message':_0x23e42b(0x135)});return;}_0x5fe483[_0x23e42b(0x11d)](0xc9)[_0x23e42b(0x125)]({'success':!![],'data':{'userId':_0x254e47['id'],'username':_0x254e47['username'],'first_name':_0x254e47[_0x23e42b(0x13f)],'last_name':_0x254e47['last_name'],'email':_0x254e47[_0x23e42b(0x114)],'avatar_url':_0x254e47[_0x23e42b(0x150)],'id':_0x254e47['id'],'role':_0x254e47[_0x23e42b(0x120)],'token':_0x53b33f,'is_enabled':_0x254e47[_0x23e42b(0x108)]}});}),router[a1_0x1da82d(0x146)](a1_0x1da82d(0x133),async(_0x4a0863,_0x1e5914)=>{const _0x489fb6=a1_0x1da82d;try{const {token:_0x2d7920}=_0x4a0863[_0x489fb6(0x14b)],[_0x894e6d]=await conn[_0x489fb6(0x14f)]()['execute'](_0x489fb6(0x131),[_0x2d7920]);if(_0x894e6d[_0x489fb6(0x113)]===0x0){_0x1e5914[_0x489fb6(0x11d)](0x194)[_0x489fb6(0x125)]({'error':_0x489fb6(0x158)});return;}await conn[_0x489fb6(0x14f)]()[_0x489fb6(0x12f)]('UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?',[_0x2d7920]);const _0x1838a4=jwt['sign']({'id':_0x894e6d[0x0]['id'],'email':_0x894e6d[0x0][_0x489fb6(0x114)]},config[_0x489fb6(0x14c)],{'expiresIn':_0x489fb6(0x10c)});_0x1e5914[_0x489fb6(0x11d)](0xc8)['json']({'success':!![],'message':'Email\x20validated\x20successfully','data':{'userId':_0x894e6d[0x0]['id'],'username':_0x894e6d[0x0]['username'],'first_name':_0x894e6d[0x0]['first_name'],'last_name':_0x894e6d[0x0]['last_name'],'email':_0x894e6d[0x0][_0x489fb6(0x114)],'avatar_url':_0x894e6d[0x0]['avatar_url'],'id':_0x894e6d[0x0]['id'],'role':_0x894e6d[0x0][_0x489fb6(0x120)],'token':_0x1838a4,'is_enabled':0x1}});}catch(_0x1fc37b){console['log']('===================error==================='),console[_0x489fb6(0x132)](_0x1fc37b),_0x1e5914[_0x489fb6(0x11d)](0x1f4)[_0x489fb6(0x125)]({'error':_0x489fb6(0x12a),'stack':_0x1fc37b[_0x489fb6(0x123)],'message':_0x1fc37b[_0x489fb6(0x117)]});}}),router[a1_0x1da82d(0x146)]('/update-password',verifyToken,async(_0xadb7ac,_0x2fb24f,_0x33bf1f)=>{const _0x3d0854=a1_0x1da82d,{current_password:_0x511b6f,new_password:_0x380332}=_0xadb7ac['body'];console['log']({'body':_0xadb7ac[_0x3d0854(0x11e)]});const _0x4d8066=_0xadb7ac[_0x3d0854(0x152)][_0x3d0854(0x114)];let _0x35305f;try{const [_0xdddbac]=await conn[_0x3d0854(0x14f)]()[_0x3d0854(0x12f)](_0x3d0854(0x139),[_0x4d8066]);if(_0xdddbac[_0x3d0854(0x113)]>0x0){_0x35305f=_0xdddbac[0x0];if(!await bcrypt[_0x3d0854(0x11c)](_0x511b6f,_0x35305f[_0x3d0854(0x126)])){_0x2fb24f['status'](0x191)[_0x3d0854(0x125)]({'error':_0x3d0854(0x10f)});return;}const _0x40ab43=await bcrypt['hash'](_0x380332,0xa);await conn[_0x3d0854(0x14f)]()[_0x3d0854(0x12f)](_0x3d0854(0x134),[_0x40ab43,_0x4d8066]),_0x2fb24f[_0x3d0854(0x11d)](0xc8)[_0x3d0854(0x125)]({'success':!![]});}}catch(_0xec77a4){console['log']({'err':_0xec77a4}),_0x2fb24f[_0x3d0854(0x11d)](0x1f4)[_0x3d0854(0x125)]({'error':_0x3d0854(0x12a)});return;}}),router[a1_0x1da82d(0x146)](a1_0x1da82d(0x10b),upload[a1_0x1da82d(0x147)](a1_0x1da82d(0x157)),verifyToken,async(_0x3e7360,_0x23da90,_0x2da890)=>{const _0x3ef49a=a1_0x1da82d,{username:_0x2e5894,first_name:_0x154210,last_name:_0x53f711}=_0x3e7360[_0x3ef49a(0x11e)],_0x201bda=_0x3e7360[_0x3ef49a(0x152)][_0x3ef49a(0x114)];let _0x41d265;try{const [_0x458cc6]=await conn[_0x3ef49a(0x14f)]()['execute'](_0x3ef49a(0x139),[_0x201bda]);_0x458cc6[_0x3ef49a(0x113)]>0x0&&(_0x41d265=_0x458cc6[0x0]);}catch(_0xc74206){console[_0x3ef49a(0x132)]({'err':_0xc74206}),_0x23da90[_0x3ef49a(0x11d)](0x1f4)[_0x3ef49a(0x125)]({'error':_0x3ef49a(0x12a)});return;}if(!_0x41d265){_0x23da90[_0x3ef49a(0x11d)](0x191)[_0x3ef49a(0x125)]({'error':_0x3ef49a(0x10a)});return;}console[_0x3ef49a(0x132)]({'req':_0x3e7360[_0x3ef49a(0x11e)]});let _0x2393c0=_0x41d265[_0x3ef49a(0x150)];if(_0x3e7360[_0x3ef49a(0x119)]){const _0x2955c9=_0x3ef49a(0x111)+randomUUID()+'.png';fs[_0x3ef49a(0x12e)](_0x3e7360['file'][_0x3ef49a(0x148)],'./'+_0x2955c9),_0x2393c0=config[_0x3ef49a(0x155)]+'/'+_0x2955c9;}try{await conn[_0x3ef49a(0x14f)]()[_0x3ef49a(0x12f)](_0x3ef49a(0x10e),[_0x2e5894,_0x154210,_0x53f711,_0x2393c0,_0x201bda]);let _0x42070a;try{_0x42070a=jwt['sign']({'userId':_0x41d265['id'],'email':_0x41d265[_0x3ef49a(0x114)]},config[_0x3ef49a(0x14c)],{'expiresIn':_0x3ef49a(0x10c)});}catch(_0x49660e){console[_0x3ef49a(0x132)](_0x49660e),_0x23da90['status'](0x1f4)[_0x3ef49a(0x125)]({'error':_0x3ef49a(0x12a)});return;}_0x23da90['status'](0xc8)[_0x3ef49a(0x125)]({'success':!![],'data':{'userId':_0x41d265['id'],'username':_0x2e5894,'first_name':_0x154210,'last_name':_0x53f711,'email':_0x41d265[_0x3ef49a(0x114)],'avatar_url':_0x2393c0,'token':_0x42070a}});}catch(_0x25dc23){console['log']({'err':_0x25dc23}),_0x23da90[_0x3ef49a(0x11d)](0x1f4)[_0x3ef49a(0x125)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),module[a1_0x1da82d(0x124)]=router;