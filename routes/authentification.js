const a1_0x37b5e2=a1_0x5251;(function(_0x19c9cd,_0x1b7052){const _0xa1d292=a1_0x5251,_0xb5c5dd=_0x19c9cd();while(!![]){try{const _0x29316a=-parseInt(_0xa1d292(0x14a))/0x1+parseInt(_0xa1d292(0x159))/0x2+-parseInt(_0xa1d292(0x12d))/0x3+-parseInt(_0xa1d292(0x13c))/0x4+-parseInt(_0xa1d292(0x153))/0x5+-parseInt(_0xa1d292(0x161))/0x6+parseInt(_0xa1d292(0x12c))/0x7;if(_0x29316a===_0x1b7052)break;else _0xb5c5dd['push'](_0xb5c5dd['shift']());}catch(_0x160c69){_0xb5c5dd['push'](_0xb5c5dd['shift']());}}}(a1_0x464c,0x5cfba));const jwt=require(a1_0x37b5e2(0x13d)),bcrypt=require(a1_0x37b5e2(0x135)),config=require(a1_0x37b5e2(0x160)),conn=require(a1_0x37b5e2(0x145)),multer=require(a1_0x37b5e2(0x154)),fs=require('fs'),verifyToken=require('../libs/jwt')['verifyToken'];!fs['existsSync']('./avatars')&&fs[a1_0x37b5e2(0x142)](a1_0x37b5e2(0x129));function a1_0x5251(_0x1309d4,_0x4edd5f){const _0x464cfc=a1_0x464c();return a1_0x5251=function(_0x52510d,_0x467dab){_0x52510d=_0x52510d-0x126;let _0x28222c=_0x464cfc[_0x52510d];return _0x28222c;},a1_0x5251(_0x1309d4,_0x4edd5f);}const express=require(a1_0x37b5e2(0x15f)),router=express[a1_0x37b5e2(0x157)](),{randomUUID}=require('crypto'),storage=multer[a1_0x37b5e2(0x12e)]({'destination':function(_0x322e2e,_0x266194,_0x5dc3f6){const _0x11abdf=a1_0x37b5e2;_0x5dc3f6(null,_0x11abdf(0x133));}}),upload=multer({'storage':storage});function a1_0x464c(){const _0x236d9d=['../CADViewer_config.json','22434kVfgNW','status','User\x20already\x20exists','avatars/','./avatars','/update-user-info','ServerUrl','18435298xeIObk','2027097nqWNUH','diskStorage','json','insertId','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','file','avatars','first_name','bcrypt','last_name','/login','execute','post','email','avatar_url','1053208TRzhpE','jsonwebtoken','role','user','promise','sign','mkdirSync','renameSync','avatar','../libs/mysql.js','Error!\x20Something\x20went\x20wrong.','jwtSecretKey','/update-password','body','727835hbiHZY','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','log','username','Invalid\x20user','Invalid\x20email\x20or\x20password','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x201)','single','hash','3289135LYEMUy','multer','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','Router','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','151292UDrvlF','crypted_password','compare','24h','length','.png','express'];a1_0x464c=function(){return _0x236d9d;};return a1_0x464c();}router['post'](a1_0x37b5e2(0x137),async(_0x36d40f,_0x204f82,_0xd86d36)=>{const _0x51316e=a1_0x37b5e2;let {email:_0x27aa6f,password:_0x14faae}=_0x36d40f[_0x51316e(0x149)];console[_0x51316e(0x14c)]({'email':_0x27aa6f,'password':_0x14faae});let _0x48b0ba;try{const [_0x49e9ac]=await conn['promise']()[_0x51316e(0x138)](_0x51316e(0x131),[_0x27aa6f]);_0x49e9ac[_0x51316e(0x15d)]>0x0&&(_0x48b0ba=_0x49e9ac[0x0]);}catch(_0x47f78d){console[_0x51316e(0x14c)]({'err':_0x47f78d}),_0x204f82[_0x51316e(0x126)](0x1f4)[_0x51316e(0x12f)]({'error':_0x51316e(0x146)});return;}console['log'](_0x48b0ba),console[_0x51316e(0x14c)](_0x14faae),console[_0x51316e(0x14c)](_0x48b0ba[_0x51316e(0x15a)]);if(!_0x48b0ba||!await bcrypt[_0x51316e(0x15b)](_0x14faae,_0x48b0ba['crypted_password'])){_0x204f82[_0x51316e(0x126)](0x191)['json']({'error':_0x51316e(0x14f)});return;}let _0x53f9af;try{_0x53f9af=jwt[_0x51316e(0x141)]({'userId':_0x48b0ba['id'],'email':_0x48b0ba[_0x51316e(0x13a)]},config['jwtSecretKey'],{'expiresIn':_0x51316e(0x15c)});}catch(_0x59f8e0){console[_0x51316e(0x14c)](_0x59f8e0),_0x204f82[_0x51316e(0x126)](0x1f4)['json']({'error':_0x51316e(0x146)});return;}_0x204f82[_0x51316e(0x126)](0xc8)[_0x51316e(0x12f)]({'success':!![],'data':{'userId':_0x48b0ba['id'],'username':_0x48b0ba[_0x51316e(0x14d)],'first_name':_0x48b0ba[_0x51316e(0x134)],'last_name':_0x48b0ba[_0x51316e(0x136)],'email':_0x48b0ba['email'],'avatar_url':_0x48b0ba['avatar_url'],'id':_0x48b0ba['id'],'role':_0x48b0ba[_0x51316e(0x13e)],'token':_0x53f9af}});}),router[a1_0x37b5e2(0x139)]('/signup',async(_0x41685c,_0x3ea13c,_0x3ad154)=>{const _0x131a9d=a1_0x37b5e2,{username:_0x46caa7,email:_0x33c9b0,password:_0xc6ffb5}=_0x41685c['body'],[_0x2e6d17]=await conn['promise']()[_0x131a9d(0x138)](_0x131a9d(0x156),[_0x33c9b0]);if(_0x2e6d17[_0x131a9d(0x15d)]>0x0){_0x3ea13c[_0x131a9d(0x126)](0x1a6)[_0x131a9d(0x12f)]({'error':_0x131a9d(0x127)});return;}const _0xfa2f5a=await bcrypt['hash'](_0xc6ffb5,0xa);try{const [_0x46cb36]=await conn[_0x131a9d(0x140)]()[_0x131a9d(0x138)](_0x131a9d(0x150),[_0x46caa7,_0x33c9b0,_0xfa2f5a,_0x131a9d(0x13f)]);if(_0x46cb36[_0x131a9d(0x130)]){const [_0x3ce4a5]=await conn[_0x131a9d(0x140)]()[_0x131a9d(0x138)](_0x131a9d(0x155),[_0x46cb36[_0x131a9d(0x130)]]);_0x3ce4a5['length']>0x0&&(newUser=_0x3ce4a5[0x0]);}}catch{_0x3ea13c[_0x131a9d(0x126)](0x1f4)[_0x131a9d(0x12f)]({'error':_0x131a9d(0x146)});return;}let _0x4af0a;try{_0x4af0a=jwt[_0x131a9d(0x141)]({'userId':newUser['id'],'email':newUser[_0x131a9d(0x13a)]},config[_0x131a9d(0x147)],{'expiresIn':_0x131a9d(0x15c)});}catch(_0x51aeb4){_0x3ea13c[_0x131a9d(0x126)](0x1f4)[_0x131a9d(0x12f)]({'error':_0x131a9d(0x146)});return;}_0x3ea13c[_0x131a9d(0x126)](0xc9)[_0x131a9d(0x12f)]({'success':!![],'data':{'userId':newUser['id'],'username':newUser[_0x131a9d(0x14d)],'first_name':newUser[_0x131a9d(0x134)],'last_name':newUser[_0x131a9d(0x136)],'email':newUser[_0x131a9d(0x13a)],'avatar_url':newUser[_0x131a9d(0x13b)],'id':newUser['id'],'role':newUser[_0x131a9d(0x13e)],'token':_0x4af0a}});}),router[a1_0x37b5e2(0x139)](a1_0x37b5e2(0x148),verifyToken,async(_0x4f7bca,_0x30a2a2,_0x20cc02)=>{const _0x315319=a1_0x37b5e2,{current_password:_0x2c1b53,new_password:_0x5218d0}=_0x4f7bca[_0x315319(0x149)];console[_0x315319(0x14c)]({'body':_0x4f7bca['body']});const _0x3efca3=_0x4f7bca[_0x315319(0x13f)]['email'];let _0x112ac2;try{const [_0x75c07f]=await conn[_0x315319(0x140)]()[_0x315319(0x138)](_0x315319(0x156),[_0x3efca3]);if(_0x75c07f[_0x315319(0x15d)]>0x0){_0x112ac2=_0x75c07f[0x0];if(!await bcrypt[_0x315319(0x15b)](_0x2c1b53,_0x112ac2[_0x315319(0x15a)])){_0x30a2a2['status'](0x191)[_0x315319(0x12f)]({'error':'Invalid\x20password'});return;}const _0x5f0af3=await bcrypt[_0x315319(0x152)](_0x5218d0,0xa);await conn['promise']()[_0x315319(0x138)](_0x315319(0x158),[_0x5f0af3,_0x3efca3]),_0x30a2a2[_0x315319(0x126)](0xc8)[_0x315319(0x12f)]({'success':!![]});}}catch(_0x503d0a){console[_0x315319(0x14c)]({'err':_0x503d0a}),_0x30a2a2['status'](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x37b5e2(0x139)](a1_0x37b5e2(0x12a),upload[a1_0x37b5e2(0x151)](a1_0x37b5e2(0x144)),verifyToken,async(_0x69b9bc,_0x55d3ae,_0x110e02)=>{const _0x33cdad=a1_0x37b5e2,{username:_0xc4f18b,first_name:_0x597e11,last_name:_0x3975cc}=_0x69b9bc['body'],_0xa1540e=_0x69b9bc[_0x33cdad(0x13f)][_0x33cdad(0x13a)];let _0x1801bd;try{const [_0x33b178]=await conn[_0x33cdad(0x140)]()[_0x33cdad(0x138)](_0x33cdad(0x156),[_0xa1540e]);_0x33b178['length']>0x0&&(_0x1801bd=_0x33b178[0x0]);}catch(_0x5cfa55){console[_0x33cdad(0x14c)]({'err':_0x5cfa55}),_0x55d3ae[_0x33cdad(0x126)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x1801bd){_0x55d3ae[_0x33cdad(0x126)](0x191)[_0x33cdad(0x12f)]({'error':_0x33cdad(0x14e)});return;}console[_0x33cdad(0x14c)]({'req':_0x69b9bc[_0x33cdad(0x149)]});let _0x58291c=_0x1801bd[_0x33cdad(0x13b)];if(_0x69b9bc[_0x33cdad(0x132)]){const _0x286477=_0x33cdad(0x128)+randomUUID()+_0x33cdad(0x15e);fs[_0x33cdad(0x143)](_0x69b9bc[_0x33cdad(0x132)]['path'],'./'+_0x286477),_0x58291c=config[_0x33cdad(0x12b)]+'/'+_0x286477;}try{await conn['promise']()['execute'](_0x33cdad(0x14b),[_0xc4f18b,_0x597e11,_0x3975cc,_0x58291c,_0xa1540e]);let _0x2e3bf3;try{_0x2e3bf3=jwt[_0x33cdad(0x141)]({'userId':_0x1801bd['id'],'email':_0x1801bd[_0x33cdad(0x13a)]},config[_0x33cdad(0x147)],{'expiresIn':_0x33cdad(0x15c)});}catch(_0x14ceee){console[_0x33cdad(0x14c)](_0x14ceee),_0x55d3ae[_0x33cdad(0x126)](0x1f4)['json']({'error':_0x33cdad(0x146)});return;}_0x55d3ae['status'](0xc8)[_0x33cdad(0x12f)]({'success':!![],'data':{'userId':_0x1801bd['id'],'username':_0xc4f18b,'first_name':_0x597e11,'last_name':_0x3975cc,'email':_0x1801bd['email'],'avatar_url':_0x58291c,'token':_0x2e3bf3}});}catch(_0x4a23ca){console['log']({'err':_0x4a23ca}),_0x55d3ae[_0x33cdad(0x126)](0x1f4)[_0x33cdad(0x12f)]({'error':_0x33cdad(0x146)});return;}}),module['exports']=router;