const a1_0x17ec2f=a1_0x3047;(function(_0x5ed1c0,_0x2f8141){const _0x25366a=a1_0x3047,_0x191c09=_0x5ed1c0();while(!![]){try{const _0x50c8ee=parseInt(_0x25366a(0xea))/0x1+parseInt(_0x25366a(0x105))/0x2*(parseInt(_0x25366a(0x108))/0x3)+-parseInt(_0x25366a(0xd6))/0x4+-parseInt(_0x25366a(0xeb))/0x5+-parseInt(_0x25366a(0x106))/0x6+-parseInt(_0x25366a(0xe7))/0x7+parseInt(_0x25366a(0xdf))/0x8*(parseInt(_0x25366a(0xe9))/0x9);if(_0x50c8ee===_0x2f8141)break;else _0x191c09['push'](_0x191c09['shift']());}catch(_0x4c37a1){_0x191c09['push'](_0x191c09['shift']());}}}(a1_0x37c0,0x9b8ce));const jwt=require(a1_0x17ec2f(0x101)),bcrypt=require(a1_0x17ec2f(0x107)),config=require(a1_0x17ec2f(0xf9)),conn=require('../libs/mysql.js'),multer=require(a1_0x17ec2f(0xce)),fs=require('fs'),verifyToken=require('../libs/jwt')[a1_0x17ec2f(0xd7)];function a1_0x37c0(){const _0x320c=['promise','existsSync','/update-password','avatars/','user','Invalid\x20email\x20or\x20password','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','4290144qajXwN','verifyToken','last_name','file','jwtSecretKey','log','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','email','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','16uAIhuU','ServerUrl','body','avatar','username','role','Router','/login','1506561aLhKtV','crypted_password','12716748JYrklL','105218qAMDRl','3308980NeTlCE','hash','status','length','User\x20already\x20exists','./avatars','insertId','renameSync','avatar_url','single','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','post','execute','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x201)','../CADViewer_config.json','exports','sign','compare','24h','Invalid\x20user','crypto','first_name','jsonwebtoken','json','mkdirSync','Error!\x20Something\x20went\x20wrong.','6BNyNlx','5891136yBTZfW','bcrypt','637383cbGyny','multer'];a1_0x37c0=function(){return _0x320c;};return a1_0x37c0();}function a1_0x3047(_0xa23791,_0x17ca6b){const _0x37c0d2=a1_0x37c0();return a1_0x3047=function(_0x304726,_0x51e260){_0x304726=_0x304726-0xce;let _0x56757d=_0x37c0d2[_0x304726];return _0x56757d;},a1_0x3047(_0xa23791,_0x17ca6b);}!fs[a1_0x17ec2f(0xd0)](a1_0x17ec2f(0xf0))&&fs[a1_0x17ec2f(0x103)](a1_0x17ec2f(0xf0));const express=require('express'),router=express[a1_0x17ec2f(0xe5)](),{randomUUID}=require(a1_0x17ec2f(0xff)),storage=multer['diskStorage']({'destination':function(_0x2948af,_0x877ec,_0x4420ec){_0x4420ec(null,'avatars');}}),upload=multer({'storage':storage});router[a1_0x17ec2f(0xf6)](a1_0x17ec2f(0xe6),async(_0x72b5be,_0xee32df,_0x49f609)=>{const _0x1a3300=a1_0x17ec2f;let {email:_0x301bd0,password:_0x408f85}=_0x72b5be['body'];console[_0x1a3300(0xdb)]({'email':_0x301bd0,'password':_0x408f85});let _0x1b5466;try{const [_0x2dac90]=await conn[_0x1a3300(0xcf)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x301bd0]);_0x2dac90[_0x1a3300(0xee)]>0x0&&(_0x1b5466=_0x2dac90[0x0]);}catch(_0x2af984){console['log']({'err':_0x2af984}),_0xee32df[_0x1a3300(0xed)](0x1f4)[_0x1a3300(0x102)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}console[_0x1a3300(0xdb)](_0x1b5466),console['log'](_0x408f85),console[_0x1a3300(0xdb)](_0x1b5466[_0x1a3300(0xe8)]);if(!_0x1b5466||!await bcrypt[_0x1a3300(0xfc)](_0x408f85,_0x1b5466[_0x1a3300(0xe8)])){_0xee32df[_0x1a3300(0xed)](0x191)[_0x1a3300(0x102)]({'error':_0x1a3300(0xd4)});return;}let _0x1f4847;try{_0x1f4847=jwt[_0x1a3300(0xfb)]({'userId':_0x1b5466['id'],'email':_0x1b5466[_0x1a3300(0xdd)]},config[_0x1a3300(0xda)],{'expiresIn':_0x1a3300(0xfd)});}catch(_0x46bd3c){console['log'](_0x46bd3c),_0xee32df['status'](0x1f4)[_0x1a3300(0x102)]({'error':_0x1a3300(0x104)});return;}_0xee32df[_0x1a3300(0xed)](0xc8)['json']({'success':!![],'data':{'userId':_0x1b5466['id'],'username':_0x1b5466[_0x1a3300(0xe3)],'first_name':_0x1b5466[_0x1a3300(0x100)],'last_name':_0x1b5466[_0x1a3300(0xd8)],'email':_0x1b5466['email'],'avatar_url':_0x1b5466[_0x1a3300(0xf3)],'id':_0x1b5466['id'],'role':_0x1b5466[_0x1a3300(0xe4)],'token':_0x1f4847}});}),router[a1_0x17ec2f(0xf6)]('/signup',async(_0x4aba89,_0x6df544,_0x3fd3a6)=>{const _0x33f023=a1_0x17ec2f,{username:_0x2052e0,email:_0x57f9c2,password:_0x1b3d2c}=_0x4aba89[_0x33f023(0xe1)],[_0x4a9fdd]=await conn[_0x33f023(0xcf)]()[_0x33f023(0xf7)](_0x33f023(0xd5),[_0x57f9c2]);if(_0x4a9fdd[_0x33f023(0xee)]>0x0){_0x6df544[_0x33f023(0xed)](0x1a6)[_0x33f023(0x102)]({'error':_0x33f023(0xef)});return;}const _0x534c40=await bcrypt[_0x33f023(0xec)](_0x1b3d2c,0xa);try{const [_0x3f5c83]=await conn[_0x33f023(0xcf)]()['execute'](_0x33f023(0xf8),[_0x2052e0,_0x57f9c2,_0x534c40,'user']);if(_0x3f5c83['insertId']){const [_0x2e63ff]=await conn['promise']()['execute'](_0x33f023(0xf5),[_0x3f5c83[_0x33f023(0xf1)]]);_0x2e63ff[_0x33f023(0xee)]>0x0&&(newUser=_0x2e63ff[0x0]);}}catch{_0x6df544[_0x33f023(0xed)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}let _0x2284b0;try{_0x2284b0=jwt[_0x33f023(0xfb)]({'userId':newUser['id'],'email':newUser[_0x33f023(0xdd)]},config[_0x33f023(0xda)],{'expiresIn':'24h'});}catch(_0x4e6f04){_0x6df544[_0x33f023(0xed)](0x1f4)['json']({'error':_0x33f023(0x104)});return;}_0x6df544[_0x33f023(0xed)](0xc9)[_0x33f023(0x102)]({'success':!![],'data':{'userId':newUser['id'],'username':newUser[_0x33f023(0xe3)],'first_name':newUser['first_name'],'last_name':newUser[_0x33f023(0xd8)],'email':newUser[_0x33f023(0xdd)],'avatar_url':newUser[_0x33f023(0xf3)],'id':newUser['id'],'role':newUser[_0x33f023(0xe4)],'token':_0x2284b0}});}),router[a1_0x17ec2f(0xf6)](a1_0x17ec2f(0xd1),verifyToken,async(_0x1b9aa9,_0x1b71c1,_0x1c17b1)=>{const _0x417bc2=a1_0x17ec2f,{current_password:_0x580abd,new_password:_0x250411}=_0x1b9aa9[_0x417bc2(0xe1)];console[_0x417bc2(0xdb)]({'body':_0x1b9aa9['body']});const _0x5aef74=_0x1b9aa9[_0x417bc2(0xd3)][_0x417bc2(0xdd)];let _0x3dd85b;try{const [_0x2514e5]=await conn[_0x417bc2(0xcf)]()[_0x417bc2(0xf7)](_0x417bc2(0xd5),[_0x5aef74]);if(_0x2514e5['length']>0x0){_0x3dd85b=_0x2514e5[0x0];if(!await bcrypt[_0x417bc2(0xfc)](_0x580abd,_0x3dd85b['crypted_password'])){_0x1b71c1['status'](0x191)['json']({'error':'Invalid\x20password'});return;}const _0x5e034b=await bcrypt[_0x417bc2(0xec)](_0x250411,0xa);await conn['promise']()['execute'](_0x417bc2(0xde),[_0x5e034b,_0x5aef74]),_0x1b71c1[_0x417bc2(0xed)](0xc8)['json']({'success':!![]});}}catch(_0x5719d1){console[_0x417bc2(0xdb)]({'err':_0x5719d1}),_0x1b71c1[_0x417bc2(0xed)](0x1f4)[_0x417bc2(0x102)]({'error':_0x417bc2(0x104)});return;}}),router[a1_0x17ec2f(0xf6)]('/update-user-info',upload[a1_0x17ec2f(0xf4)](a1_0x17ec2f(0xe2)),verifyToken,async(_0x2de7c8,_0x7db117,_0x5e884d)=>{const _0x2b79c8=a1_0x17ec2f,{username:_0x30b579,first_name:_0x2eff8a,last_name:_0x3ac216}=_0x2de7c8[_0x2b79c8(0xe1)],_0x4c7e0d=_0x2de7c8[_0x2b79c8(0xd3)][_0x2b79c8(0xdd)];let _0x402051;try{const [_0x427208]=await conn['promise']()[_0x2b79c8(0xf7)](_0x2b79c8(0xd5),[_0x4c7e0d]);_0x427208[_0x2b79c8(0xee)]>0x0&&(_0x402051=_0x427208[0x0]);}catch(_0x3f60ef){console['log']({'err':_0x3f60ef}),_0x7db117['status'](0x1f4)[_0x2b79c8(0x102)]({'error':_0x2b79c8(0x104)});return;}if(!_0x402051){_0x7db117[_0x2b79c8(0xed)](0x191)[_0x2b79c8(0x102)]({'error':_0x2b79c8(0xfe)});return;}console['log']({'req':_0x2de7c8[_0x2b79c8(0xe1)]});let _0x59f7c2=_0x402051[_0x2b79c8(0xf3)];if(_0x2de7c8[_0x2b79c8(0xd9)]){const _0x36969f=_0x2b79c8(0xd2)+randomUUID()+'.png';fs[_0x2b79c8(0xf2)](_0x2de7c8['file']['path'],'./'+_0x36969f),_0x59f7c2=config[_0x2b79c8(0xe0)]+'/'+_0x36969f;}try{await conn[_0x2b79c8(0xcf)]()[_0x2b79c8(0xf7)](_0x2b79c8(0xdc),[_0x30b579,_0x2eff8a,_0x3ac216,_0x59f7c2,_0x4c7e0d]);let _0x51b589;try{_0x51b589=jwt[_0x2b79c8(0xfb)]({'userId':_0x402051['id'],'email':_0x402051[_0x2b79c8(0xdd)]},config[_0x2b79c8(0xda)],{'expiresIn':_0x2b79c8(0xfd)});}catch(_0x2149b5){console[_0x2b79c8(0xdb)](_0x2149b5),_0x7db117['status'](0x1f4)[_0x2b79c8(0x102)]({'error':_0x2b79c8(0x104)});return;}_0x7db117[_0x2b79c8(0xed)](0xc8)[_0x2b79c8(0x102)]({'success':!![],'data':{'userId':_0x402051['id'],'username':_0x30b579,'first_name':_0x2eff8a,'last_name':_0x3ac216,'email':_0x402051[_0x2b79c8(0xdd)],'avatar_url':_0x59f7c2,'token':_0x51b589}});}catch(_0x113df8){console[_0x2b79c8(0xdb)]({'err':_0x113df8}),_0x7db117[_0x2b79c8(0xed)](0x1f4)[_0x2b79c8(0x102)]({'error':_0x2b79c8(0x104)});return;}}),module[a1_0x17ec2f(0xfa)]=router;