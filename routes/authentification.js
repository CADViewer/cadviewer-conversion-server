const a1_0x4de915=a1_0x1696;(function(_0x15b2dc,_0x40ed2a){const _0x5f3591=a1_0x1696,_0x9750b2=_0x15b2dc();while(!![]){try{const _0x42f46b=-parseInt(_0x5f3591(0x94))/0x1*(-parseInt(_0x5f3591(0xa4))/0x2)+parseInt(_0x5f3591(0x71))/0x3+-parseInt(_0x5f3591(0x8a))/0x4*(parseInt(_0x5f3591(0x7a))/0x5)+parseInt(_0x5f3591(0xa6))/0x6*(-parseInt(_0x5f3591(0x6f))/0x7)+-parseInt(_0x5f3591(0x8c))/0x8+parseInt(_0x5f3591(0x77))/0x9+-parseInt(_0x5f3591(0xb4))/0xa;if(_0x42f46b===_0x40ed2a)break;else _0x9750b2['push'](_0x9750b2['shift']());}catch(_0x1b38f4){_0x9750b2['push'](_0x9750b2['shift']());}}}(a1_0x54df,0x7a7ab));const jwt=require(a1_0x4de915(0xa0)),bcrypt=require(a1_0x4de915(0x82)),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x4de915(0xb3)),fs=require('fs'),verifyToken=require(a1_0x4de915(0xa2))[a1_0x4de915(0xb9)];function a1_0x54df(){const _0x1fd6a2=['enableEmailVerification','1605261kLBjqW','promise','Invalid\x20email\x20or\x20password','crypted_password','avatars/','===================error===================','664443DbmxuW','transporter','../libs/mail','611045ypllrC','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','.png','execute','insertId','avatars','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','mkdirSync','bcrypt','avatar','last_name','sendMail','Email\x20validated\x20successfully','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','/validate-email/','file','4VndsWB','avatar_url','4287104FDzPUH','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','./avatars','/signup','json','body','post','Invalid\x20user','237870PwDlYa','sign','/update-password','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','./uploads/','Error!\x20Something\x20went\x20wrong.','unlinkSync','Welcome\x20to\x20CADViewer','smtpFrom','jwtSecretKey','frontendUrl','jsonwebtoken','email','../libs/jwt','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','8CVSamS','log','12MGSYAD','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','slice','express','24h','compare','Invalid\x20password','role','hash','single','<p>Welcome\x20to\x20CADViewer</p>','length','Router','multer','1879320nuFUgn','stack','username','status','first_name','verifyToken','path','ServerUrl','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','user','744415DkpCzV'];a1_0x54df=function(){return _0x1fd6a2;};return a1_0x54df();}!fs['existsSync'](a1_0x4de915(0x8e))&&fs[a1_0x4de915(0x81)](a1_0x4de915(0x8e));function a1_0x1696(_0x538d75,_0x172cfd){const _0x54dfb0=a1_0x54df();return a1_0x1696=function(_0x16965e,_0x2b2942){_0x16965e=_0x16965e-0x6d;let _0x24015e=_0x54dfb0[_0x16965e];return _0x24015e;},a1_0x1696(_0x538d75,_0x172cfd);}const express=require(a1_0x4de915(0xa9)),router=express[a1_0x4de915(0xb2)](),{randomUUID}=require('crypto'),storage=multer['diskStorage']({'destination':function(_0x13818b,_0x14cf90,_0x51e155){const _0x429c6a=a1_0x4de915;_0x51e155(null,_0x429c6a(0x7f));}}),upload=multer({'storage':storage});router[a1_0x4de915(0x92)]('/login',async(_0x73a246,_0x2e20b3,_0x4b5768)=>{const _0xe614b2=a1_0x4de915;let {email:_0x45686b,password:_0x1da7a7}=_0x73a246[_0xe614b2(0x91)];console['log']({'email':_0x45686b,'password':_0x1da7a7});let _0x3683a2;try{const [_0x282450]=await conn[_0xe614b2(0x72)]()[_0xe614b2(0x7d)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x45686b]);_0x282450[_0xe614b2(0xb1)]>0x0&&(_0x3683a2=_0x282450[0x0]);}catch(_0x4f8684){console[_0xe614b2(0xa5)]({'err':_0x4f8684}),_0x2e20b3['status'](0x1f4)[_0xe614b2(0x90)]({'error':_0xe614b2(0x9a)});return;}if(!_0x3683a2||!await bcrypt[_0xe614b2(0xab)](_0x1da7a7,_0x3683a2?.[_0xe614b2(0x74)])){_0x2e20b3[_0xe614b2(0xb7)](0x191)[_0xe614b2(0x90)]({'error':_0xe614b2(0x73)});return;}let _0x597fb8;try{_0x597fb8=jwt[_0xe614b2(0x95)]({'userId':_0x3683a2['id'],'email':_0x3683a2[_0xe614b2(0xa1)]},config[_0xe614b2(0x9e)],{'expiresIn':_0xe614b2(0xaa)});}catch(_0x26756e){console[_0xe614b2(0xa5)](_0x26756e),_0x2e20b3[_0xe614b2(0xb7)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x2e20b3['status'](0xc8)[_0xe614b2(0x90)]({'success':!![],'data':{'userId':_0x3683a2['id'],'username':_0x3683a2[_0xe614b2(0xb6)],'first_name':_0x3683a2['first_name'],'last_name':_0x3683a2[_0xe614b2(0x84)],'email':_0x3683a2['email'],'avatar_url':_0x3683a2[_0xe614b2(0x8b)],'id':_0x3683a2['id'],'role':_0x3683a2['role'],'token':_0x597fb8}});}),router['post'](a1_0x4de915(0x8f),async(_0x2c89f6,_0x39471c,_0x469c9b)=>{const _0x131132=a1_0x4de915,{username:_0x3e9937,email:_0x4518d7,password:_0xc4da30}=_0x2c89f6['body'],[_0x49c844]=await conn['promise']()[_0x131132(0x7d)](_0x131132(0x87),[_0x4518d7]);if(_0x49c844[_0x131132(0xb1)]>0x0){_0x39471c['status'](0x1a6)[_0x131132(0x90)]({'error':'User\x20already\x20exists'});return;}const _0x564a50=await bcrypt['hash'](_0xc4da30,0xa);let _0x402145=null,_0x16a44b=0x1;config[_0x131132(0x70)]&&(_0x402145=randomUUID(),_0x16a44b=0x0);let _0x43d153;try{const _0x25002c=randomUUID(),_0x35046a=_0x131132(0x99)+_0x25002c;fs[_0x131132(0x81)](_0x35046a);const [_0x292cac]=await conn[_0x131132(0x72)]()[_0x131132(0x7d)](_0x131132(0x8d),[_0x3e9937,_0x4518d7,_0x564a50,'demo_user',_0x16a44b,_0x402145,_0x25002c]);if(_0x292cac[_0x131132(0x7e)]){const [_0xabcb1f]=await conn[_0x131132(0x72)]()[_0x131132(0x7d)](_0x131132(0x7b),[_0x292cac[_0x131132(0x7e)]]);_0xabcb1f[_0x131132(0xb1)]>0x0&&(_0x43d153=_0xabcb1f[0x0]);}}catch{_0x39471c[_0x131132(0xb7)](0x1f4)[_0x131132(0x90)]({'error':_0x131132(0x9a)});return;}let _0x54d9ee;try{_0x54d9ee=jwt[_0x131132(0x95)]({'userId':_0x43d153['id'],'email':_0x43d153[_0x131132(0xa1)]},config[_0x131132(0x9e)],{'expiresIn':_0x131132(0xaa)});}catch(_0x3d9450){_0x39471c[_0x131132(0xb7)](0x1f4)[_0x131132(0x90)]({'error':_0x131132(0x9a)});return;}const _0x497dbf=require(_0x131132(0x79))[_0x131132(0x78)];let _0x852f34=_0x131132(0xb0);if(config[_0x131132(0x70)]){var _0x5becfa=config[_0x131132(0x9f)];_0x5becfa['endsWith']('/')&&(_0x5becfa=_0x5becfa[_0x131132(0xa8)](0x0,-0x1));const _0x5eee38=_0x5becfa+_0x131132(0x88)+_0x402145;_0x852f34=_0x131132(0xa7)+_0x5eee38+_0x131132(0x98)+_0x5eee38+_0x131132(0xa3);const _0x508ea0={'from':config[_0x131132(0x9d)],'to':_0x43d153[_0x131132(0xa1)],'subject':_0x131132(0x9c),'text':_0x131132(0x9c),'html':_0x852f34};try{await _0x497dbf[_0x131132(0x85)](_0x508ea0);}catch(_0x2c24d9){console[_0x131132(0xa5)]('===================error==================='),console['log'](_0x2c24d9),_0x39471c[_0x131132(0xb7)](0x1f4)[_0x131132(0x90)]({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0x2c24d9[_0x131132(0xb5)],'message':_0x2c24d9['message']});return;}_0x39471c[_0x131132(0xb7)](0xc8)[_0x131132(0x90)]({'success':!![],'message':_0x131132(0x97)});return;}_0x39471c[_0x131132(0xb7)](0xc9)[_0x131132(0x90)]({'success':!![],'data':{'userId':_0x43d153['id'],'username':_0x43d153[_0x131132(0xb6)],'first_name':_0x43d153[_0x131132(0xb8)],'last_name':_0x43d153[_0x131132(0x84)],'email':_0x43d153['email'],'avatar_url':_0x43d153[_0x131132(0x8b)],'id':_0x43d153['id'],'role':_0x43d153[_0x131132(0xad)],'token':_0x54d9ee,'is_enabled':_0x43d153['is_enabled']}});}),router[a1_0x4de915(0x92)]('/validate-email/:token',async(_0x99cbcc,_0x3977e9)=>{const _0x33a975=a1_0x4de915;try{const {token:_0x2ea25c}=_0x99cbcc['params'],[_0x25f02f]=await conn['promise']()[_0x33a975(0x7d)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0x2ea25c]);if(_0x25f02f['length']===0x0){_0x3977e9[_0x33a975(0xb7)](0x194)['json']({'error':'Invalid\x20validation\x20token'});return;}await conn[_0x33a975(0x72)]()[_0x33a975(0x7d)](_0x33a975(0x6d),[_0x2ea25c]);const _0x4520ea=jwt['sign']({'id':_0x25f02f[0x0]['id'],'email':_0x25f02f[0x0][_0x33a975(0xa1)]},config[_0x33a975(0x9e)],{'expiresIn':_0x33a975(0xaa)});_0x3977e9[_0x33a975(0xb7)](0xc8)[_0x33a975(0x90)]({'success':!![],'message':_0x33a975(0x86),'data':{'userId':_0x25f02f[0x0]['id'],'username':_0x25f02f[0x0][_0x33a975(0xb6)],'first_name':_0x25f02f[0x0]['first_name'],'last_name':_0x25f02f[0x0]['last_name'],'email':_0x25f02f[0x0][_0x33a975(0xa1)],'avatar_url':_0x25f02f[0x0][_0x33a975(0x8b)],'id':_0x25f02f[0x0]['id'],'role':_0x25f02f[0x0][_0x33a975(0xad)],'token':_0x4520ea,'is_enabled':0x1}});}catch(_0x55cef2){console[_0x33a975(0xa5)](_0x33a975(0x76)),console['log'](_0x55cef2),_0x3977e9[_0x33a975(0xb7)](0x1f4)[_0x33a975(0x90)]({'error':_0x33a975(0x9a),'stack':_0x55cef2[_0x33a975(0xb5)],'message':_0x55cef2['message']});}}),router[a1_0x4de915(0x92)](a1_0x4de915(0x96),verifyToken,async(_0x55cd32,_0x869635,_0x3f38a3)=>{const _0x43b10c=a1_0x4de915,{current_password:_0x111eda,new_password:_0x3da22e}=_0x55cd32[_0x43b10c(0x91)];console[_0x43b10c(0xa5)]({'body':_0x55cd32[_0x43b10c(0x91)]});const _0x5f0637=_0x55cd32['user'][_0x43b10c(0xa1)];let _0x30af90;try{const [_0x1970a6]=await conn['promise']()[_0x43b10c(0x7d)](_0x43b10c(0x87),[_0x5f0637]);if(_0x1970a6[_0x43b10c(0xb1)]>0x0){_0x30af90=_0x1970a6[0x0];if(!await bcrypt[_0x43b10c(0xab)](_0x111eda,_0x30af90[_0x43b10c(0x74)])){_0x869635[_0x43b10c(0xb7)](0x191)[_0x43b10c(0x90)]({'error':_0x43b10c(0xac)});return;}const _0x596a63=await bcrypt[_0x43b10c(0xae)](_0x3da22e,0xa);await conn[_0x43b10c(0x72)]()['execute']('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x596a63,_0x5f0637]),_0x869635[_0x43b10c(0xb7)](0xc8)[_0x43b10c(0x90)]({'success':!![]});}}catch(_0x5ca956){console[_0x43b10c(0xa5)]({'err':_0x5ca956}),_0x869635[_0x43b10c(0xb7)](0x1f4)['json']({'error':_0x43b10c(0x9a)});return;}}),router[a1_0x4de915(0x92)]('/update-user-info',upload[a1_0x4de915(0xaf)](a1_0x4de915(0x83)),verifyToken,async(_0x11d17b,_0x5c826b,_0x5f2a75)=>{const _0x4d60ad=a1_0x4de915,{username:_0x24a07f,first_name:_0x129a63,last_name:_0x40c4c0}=_0x11d17b[_0x4d60ad(0x91)],_0x5e9ad9=_0x11d17b[_0x4d60ad(0x6e)][_0x4d60ad(0xa1)];let _0x1c4b84;try{const [_0x1b6ffa]=await conn['promise']()[_0x4d60ad(0x7d)](_0x4d60ad(0x87),[_0x5e9ad9]);_0x1b6ffa['length']>0x0&&(_0x1c4b84=_0x1b6ffa[0x0]);}catch(_0x478987){console[_0x4d60ad(0xa5)]({'err':_0x478987}),_0x5c826b[_0x4d60ad(0xb7)](0x1f4)[_0x4d60ad(0x90)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x1c4b84){_0x5c826b[_0x4d60ad(0xb7)](0x191)[_0x4d60ad(0x90)]({'error':_0x4d60ad(0x93)});return;}console[_0x4d60ad(0xa5)]({'req':_0x11d17b['body']});let _0x48744b=_0x1c4b84[_0x4d60ad(0x8b)];if(_0x11d17b['file']){const _0x4f7bd0=_0x4d60ad(0x75)+randomUUID()+_0x4d60ad(0x7c);fs['copyFileSync'](_0x11d17b[_0x4d60ad(0x89)]['path'],'./'+_0x4f7bd0),fs[_0x4d60ad(0x9b)](_0x11d17b['file'][_0x4d60ad(0xba)]),_0x48744b=config[_0x4d60ad(0xbb)]+'/'+_0x4f7bd0;}try{await conn[_0x4d60ad(0x72)]()[_0x4d60ad(0x7d)](_0x4d60ad(0x80),[_0x24a07f,_0x129a63,_0x40c4c0,_0x48744b,_0x5e9ad9]);let _0x33093a;try{_0x33093a=jwt['sign']({'userId':_0x1c4b84['id'],'email':_0x1c4b84[_0x4d60ad(0xa1)]},config[_0x4d60ad(0x9e)],{'expiresIn':'24h'});}catch(_0x13c5c4){console[_0x4d60ad(0xa5)](_0x13c5c4),_0x5c826b[_0x4d60ad(0xb7)](0x1f4)[_0x4d60ad(0x90)]({'error':_0x4d60ad(0x9a)});return;}_0x5c826b[_0x4d60ad(0xb7)](0xc8)[_0x4d60ad(0x90)]({'success':!![],'data':{'userId':_0x1c4b84['id'],'username':_0x24a07f,'first_name':_0x129a63,'last_name':_0x40c4c0,'email':_0x1c4b84[_0x4d60ad(0xa1)],'avatar_url':_0x48744b,'token':_0x33093a}});}catch(_0x224f27){console[_0x4d60ad(0xa5)]({'err':_0x224f27}),_0x5c826b[_0x4d60ad(0xb7)](0x1f4)[_0x4d60ad(0x90)]({'error':_0x4d60ad(0x9a)});return;}}),module['exports']=router;