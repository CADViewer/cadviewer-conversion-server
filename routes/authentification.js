const a1_0xb332d6=a1_0x2392;(function(_0x3fc4eb,_0x18969e){const _0x27b9b2=a1_0x2392,_0x2a80c2=_0x3fc4eb();while(!![]){try{const _0x2ae742=parseInt(_0x27b9b2(0xb0))/0x1*(parseInt(_0x27b9b2(0xcc))/0x2)+-parseInt(_0x27b9b2(0xdc))/0x3*(-parseInt(_0x27b9b2(0xc6))/0x4)+-parseInt(_0x27b9b2(0xe9))/0x5*(-parseInt(_0x27b9b2(0xb1))/0x6)+-parseInt(_0x27b9b2(0xcd))/0x7*(parseInt(_0x27b9b2(0x104))/0x8)+parseInt(_0x27b9b2(0xbc))/0x9+-parseInt(_0x27b9b2(0xf3))/0xa*(-parseInt(_0x27b9b2(0xdd))/0xb)+parseInt(_0x27b9b2(0xc2))/0xc*(-parseInt(_0x27b9b2(0xf1))/0xd);if(_0x2ae742===_0x18969e)break;else _0x2a80c2['push'](_0x2a80c2['shift']());}catch(_0x4fafe8){_0x2a80c2['push'](_0x2a80c2['shift']());}}}(a1_0xb831,0x430f7));const jwt=require(a1_0xb332d6(0xc3)),bcrypt=require(a1_0xb332d6(0x108)),config=require(a1_0xb332d6(0xb3)),conn=require('../libs/mysql.js'),multer=require('multer'),fs=require('fs'),verifyToken=require(a1_0xb332d6(0xe1))[a1_0xb332d6(0x107)],{sendWelcomeEmail}=require(a1_0xb332d6(0x101)),axios=require('axios');function a1_0x2392(_0x337ff9,_0x8391ab){const _0xb8314c=a1_0xb831();return a1_0x2392=function(_0x2392db,_0xeea9f9){_0x2392db=_0x2392db-0xa9;let _0x11a910=_0xb8314c[_0x2392db];return _0x11a910;},a1_0x2392(_0x337ff9,_0x8391ab);}function a1_0xb831(){const _0x3b0e3e=['276SJSfQc','Error\x20parsing\x20geolocation\x20data:','../CADViewer_config.json','Invalid\x20password','code','avatar_url','./uploads/','/validate-email/:token','role','avatar','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','1541970IUraNE','Invalid\x20email\x20or\x20password','/login','reCAPTCHA\x20verification\x20error:','insertId','crypto','13138368FKwOjz','jsonwebtoken','status','Email\x20validated\x20successfully','395868BbPeTj','unlinkSync','crypted_password','json','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','jwtSecretKey','1304YNpQnN','203GCVDzz','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','Error!\x20Something\x20went\x20wrong.','path','single','enableEmailVerification','user','recaptchaSecretKey','name','./avatars','express','avatars/','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','first_name','===================error===================','3RMaSBY','77xsTheZ','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','stack','promise','../libs/jwt','sign','recaptchaEnabled','exports','file','data','email','params','53350nFiHVW','/update-user-info','callbackMethod_gatewayUrl_flag','diskStorage','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','country_name','execute','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','13IGSROs','mkdirSync','559590PeJSXQ','copyFileSync','callbackMethod_gatewayUrl','Error\x20during\x20user\x20creation:','success','avatars','24h','username','is_enabled','length','error','hash','ServerUrl','time_zone','../libs/email-utils','last_name','Invalid\x20user','51192LXgWki','existsSync','languages','verifyToken','bcrypt','.png','log','/update-password','post','compare','body','city','617dCOMyE'];a1_0xb831=function(){return _0x3b0e3e;};return a1_0xb831();}!fs[a1_0xb332d6(0x105)](a1_0xb332d6(0xd6))&&fs[a1_0xb332d6(0xf2)]('./avatars');const express=require(a1_0xb332d6(0xd7)),router=express['Router'](),{randomUUID}=require(a1_0xb332d6(0xc1)),storage=multer[a1_0xb332d6(0xec)]({'destination':function(_0x3fa591,_0x4005b9,_0x42ffec){const _0x1f6b14=a1_0xb332d6;_0x42ffec(null,_0x1f6b14(0xf8));}}),upload=multer({'storage':storage});router['post'](a1_0xb332d6(0xbe),async(_0x8191e3,_0x139665,_0x39c4ba)=>{const _0x3ae338=a1_0xb332d6;let {email:_0x3dd4a3,password:_0x46a7ca}=_0x8191e3[_0x3ae338(0xae)];console[_0x3ae338(0xaa)]({'email':_0x3dd4a3,'password':_0x46a7ca});let _0x28c07d;try{const [_0x16aa63]=await conn[_0x3ae338(0xe0)]()['execute'](_0x3ae338(0xde),[_0x3dd4a3]);_0x16aa63[_0x3ae338(0xfc)]>0x0&&(_0x28c07d=_0x16aa63[0x0]);}catch(_0x440bfe){console[_0x3ae338(0xaa)]({'err':_0x440bfe}),_0x139665[_0x3ae338(0xc4)](0x1f4)[_0x3ae338(0xc9)]({'error':_0x3ae338(0xcf)});return;}if(!_0x28c07d||!await bcrypt[_0x3ae338(0xad)](_0x46a7ca,_0x28c07d?.[_0x3ae338(0xc8)])){_0x139665[_0x3ae338(0xc4)](0x191)[_0x3ae338(0xc9)]({'error':_0x3ae338(0xbd)});return;}let _0x24c441;try{_0x24c441=jwt[_0x3ae338(0xe2)]({'userId':_0x28c07d['id'],'email':_0x28c07d[_0x3ae338(0xe7)]},config[_0x3ae338(0xcb)],{'expiresIn':'24h'});}catch(_0x44bc37){console[_0x3ae338(0xaa)](_0x44bc37),_0x139665['status'](0x1f4)[_0x3ae338(0xc9)]({'error':_0x3ae338(0xcf)});return;}_0x139665['status'](0xc8)[_0x3ae338(0xc9)]({'success':!![],'data':{'userId':_0x28c07d['id'],'username':_0x28c07d['username'],'first_name':_0x28c07d[_0x3ae338(0xda)],'last_name':_0x28c07d[_0x3ae338(0x102)],'email':_0x28c07d[_0x3ae338(0xe7)],'avatar_url':_0x28c07d['avatar_url'],'id':_0x28c07d['id'],'role':_0x28c07d[_0x3ae338(0xb9)],'token':_0x24c441}});}),router['post']('/signup',async(_0x2cc7f8,_0x4ac563,_0x55f790)=>{const _0x3de717=a1_0xb332d6,{username:_0x2a0644,email:_0x267267,password:_0x2bc121,geolocation:_0x49006a,recaptchaToken:_0x1e75ae}=_0x2cc7f8[_0x3de717(0xae)];if(config[_0x3de717(0xe3)]){if(!_0x1e75ae)return _0x4ac563['status'](0x190)[_0x3de717(0xc9)]({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.'});try{const _0x30d8ac=await axios[_0x3de717(0xac)]('https://www.google.com/recaptcha/api/siteverify',null,{'params':{'secret':config[_0x3de717(0xd4)],'response':_0x1e75ae}});if(!_0x30d8ac[_0x3de717(0xe6)][_0x3de717(0xf7)])return _0x4ac563['status'](0x190)[_0x3de717(0xc9)]({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','recaptchaErrors':_0x30d8ac[_0x3de717(0xe6)]['error-codes']});}catch(_0x254c93){return console[_0x3de717(0xfd)](_0x3de717(0xbf),_0x254c93),_0x4ac563[_0x3de717(0xc4)](0x1f4)[_0x3de717(0xc9)]({'error':'Error\x20during\x20reCAPTCHA\x20verification.'});}}const [_0x317148]=await conn[_0x3de717(0xe0)]()[_0x3de717(0xef)](_0x3de717(0xbb),[_0x267267]);if(_0x317148['length']>0x0){_0x4ac563[_0x3de717(0xc4)](0x1a6)[_0x3de717(0xc9)]({'error':'User\x20already\x20exists'});return;}const _0x3a8ca5=await bcrypt[_0x3de717(0xfe)](_0x2bc121,0xa);let _0x3d7acd=null,_0x43c44c=0x1;config[_0x3de717(0xd2)]&&(_0x3d7acd=randomUUID(),_0x43c44c=0x0);let _0x2da326=null,_0x5dd0ed=null,_0x4ff3f0=null,_0x377e5d=null,_0x4028a2=null,_0x4a9af7=null;if(_0x49006a)try{const _0x579fbc=_0x49006a;_0x2da326=_0x579fbc[_0x3de717(0xaf)]||null,_0x5dd0ed=_0x579fbc['region']||null,_0x4ff3f0=_0x579fbc[_0x3de717(0xee)]||null,_0x579fbc[_0x3de717(0x106)]&&_0x579fbc[_0x3de717(0x106)]['length']>0x0&&(_0x377e5d=_0x579fbc['languages'][0x0][_0x3de717(0xb5)]||null,_0x4028a2=_0x579fbc[_0x3de717(0x106)][0x0][_0x3de717(0xd5)]||null),_0x579fbc[_0x3de717(0x100)]&&(_0x4a9af7=_0x579fbc[_0x3de717(0x100)]['name']||null);}catch(_0x115d86){console[_0x3de717(0xaa)](_0x3de717(0xb2),_0x115d86);}let _0xb2a5f3;try{const _0x82f36d=randomUUID(),_0x7e9978=_0x3de717(0xb7)+_0x82f36d;fs[_0x3de717(0xf2)](_0x7e9978);const [_0x3b8fe3]=await conn[_0x3de717(0xe0)]()['execute'](_0x3de717(0xca),[_0x2a0644,_0x267267,_0x3a8ca5,'demo_user',_0x43c44c,_0x3d7acd,_0x82f36d,_0x2da326,_0x5dd0ed,_0x4ff3f0,_0x377e5d,_0x4028a2,_0x4a9af7]);if(_0x3b8fe3[_0x3de717(0xc0)]){const [_0x41432d]=await conn['promise']()['execute'](_0x3de717(0xf0),[_0x3b8fe3[_0x3de717(0xc0)]]);_0x41432d[_0x3de717(0xfc)]>0x0&&(_0xb2a5f3=_0x41432d[0x0]);}}catch(_0x3b0292){console[_0x3de717(0xaa)](_0x3de717(0xf6),_0x3b0292),_0x4ac563[_0x3de717(0xc4)](0x1f4)['json']({'error':_0x3de717(0xcf)});return;}let _0x536543;try{_0x536543=jwt['sign']({'userId':_0xb2a5f3['id'],'email':_0xb2a5f3['email']},config[_0x3de717(0xcb)],{'expiresIn':_0x3de717(0xf9)});}catch(_0x5d4463){_0x4ac563[_0x3de717(0xc4)](0x1f4)[_0x3de717(0xc9)]({'error':_0x3de717(0xcf)});return;}if(config[_0x3de717(0xd2)]){try{await sendWelcomeEmail(_0xb2a5f3,_0x3d7acd);}catch(_0x2c400a){console[_0x3de717(0xaa)](_0x3de717(0xdb)),console[_0x3de717(0xaa)](_0x2c400a);}_0x4ac563['status'](0xc8)[_0x3de717(0xc9)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.'});return;}_0x4ac563[_0x3de717(0xc4)](0xc9)[_0x3de717(0xc9)]({'success':!![],'data':{'userId':_0xb2a5f3['id'],'username':_0xb2a5f3[_0x3de717(0xfa)],'first_name':_0xb2a5f3[_0x3de717(0xda)],'last_name':_0xb2a5f3[_0x3de717(0x102)],'email':_0xb2a5f3[_0x3de717(0xe7)],'avatar_url':_0xb2a5f3[_0x3de717(0xb6)],'id':_0xb2a5f3['id'],'role':_0xb2a5f3[_0x3de717(0xb9)],'token':_0x536543,'is_enabled':_0xb2a5f3[_0x3de717(0xfb)]}});}),router[a1_0xb332d6(0xac)](a1_0xb332d6(0xb8),async(_0x5dd9fc,_0x1f0a8c)=>{const _0x3c8a00=a1_0xb332d6;try{const {token:_0x1ae22b}=_0x5dd9fc[_0x3c8a00(0xe8)],[_0x3f0c70]=await conn[_0x3c8a00(0xe0)]()[_0x3c8a00(0xef)](_0x3c8a00(0xce),[_0x1ae22b]);if(_0x3f0c70[_0x3c8a00(0xfc)]===0x0){_0x1f0a8c['status'](0x194)[_0x3c8a00(0xc9)]({'error':'Invalid\x20validation\x20token'});return;}await conn[_0x3c8a00(0xe0)]()[_0x3c8a00(0xef)](_0x3c8a00(0xd9),[_0x1ae22b]);const _0x5757b0=jwt['sign']({'id':_0x3f0c70[0x0]['id'],'email':_0x3f0c70[0x0][_0x3c8a00(0xe7)]},config['jwtSecretKey'],{'expiresIn':'24h'});_0x1f0a8c[_0x3c8a00(0xc4)](0xc8)[_0x3c8a00(0xc9)]({'success':!![],'message':_0x3c8a00(0xc5),'data':{'userId':_0x3f0c70[0x0]['id'],'username':_0x3f0c70[0x0]['username'],'first_name':_0x3f0c70[0x0][_0x3c8a00(0xda)],'last_name':_0x3f0c70[0x0][_0x3c8a00(0x102)],'email':_0x3f0c70[0x0][_0x3c8a00(0xe7)],'avatar_url':_0x3f0c70[0x0][_0x3c8a00(0xb6)],'id':_0x3f0c70[0x0]['id'],'role':_0x3f0c70[0x0][_0x3c8a00(0xb9)],'token':_0x5757b0,'is_enabled':0x1}});}catch(_0x541dce){console[_0x3c8a00(0xaa)]('===================error==================='),console[_0x3c8a00(0xaa)](_0x541dce),_0x1f0a8c[_0x3c8a00(0xc4)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.','stack':_0x541dce[_0x3c8a00(0xdf)],'message':_0x541dce['message']});}}),router[a1_0xb332d6(0xac)](a1_0xb332d6(0xab),verifyToken,async(_0x4179c2,_0x4a58cd,_0x54bd37)=>{const _0x5a6e0a=a1_0xb332d6,{current_password:_0xdc321,new_password:_0x3d1b82}=_0x4179c2[_0x5a6e0a(0xae)];console['log']({'body':_0x4179c2[_0x5a6e0a(0xae)]});const _0x4241d5=_0x4179c2[_0x5a6e0a(0xd3)][_0x5a6e0a(0xe7)];let _0x19e860;try{const [_0x4e9bc6]=await conn[_0x5a6e0a(0xe0)]()['execute'](_0x5a6e0a(0xbb),[_0x4241d5]);if(_0x4e9bc6['length']>0x0){_0x19e860=_0x4e9bc6[0x0];if(!await bcrypt[_0x5a6e0a(0xad)](_0xdc321,_0x19e860['crypted_password'])){_0x4a58cd[_0x5a6e0a(0xc4)](0x191)[_0x5a6e0a(0xc9)]({'error':_0x5a6e0a(0xb4)});return;}const _0x2ceb37=await bcrypt['hash'](_0x3d1b82,0xa);await conn[_0x5a6e0a(0xe0)]()['execute'](_0x5a6e0a(0xed),[_0x2ceb37,_0x4241d5]),_0x4a58cd[_0x5a6e0a(0xc4)](0xc8)['json']({'success':!![]});}}catch(_0x17985d){console['log']({'err':_0x17985d}),_0x4a58cd['status'](0x1f4)[_0x5a6e0a(0xc9)]({'error':_0x5a6e0a(0xcf)});return;}}),router['post'](a1_0xb332d6(0xea),upload[a1_0xb332d6(0xd1)](a1_0xb332d6(0xba)),verifyToken,async(_0x2b3837,_0x42cfbe,_0x23cab1)=>{const _0xc2ff30=a1_0xb332d6,{username:_0x36adcc,first_name:_0x13c624,last_name:_0x8d11af}=_0x2b3837[_0xc2ff30(0xae)],_0x11873e=_0x2b3837[_0xc2ff30(0xd3)]['email'];let _0xd8a114;try{const [_0x546c9e]=await conn[_0xc2ff30(0xe0)]()[_0xc2ff30(0xef)](_0xc2ff30(0xbb),[_0x11873e]);_0x546c9e[_0xc2ff30(0xfc)]>0x0&&(_0xd8a114=_0x546c9e[0x0]);}catch(_0x5a2c5c){console[_0xc2ff30(0xaa)]({'err':_0x5a2c5c}),_0x42cfbe[_0xc2ff30(0xc4)](0x1f4)[_0xc2ff30(0xc9)]({'error':_0xc2ff30(0xcf)});return;}if(!_0xd8a114){_0x42cfbe[_0xc2ff30(0xc4)](0x191)[_0xc2ff30(0xc9)]({'error':_0xc2ff30(0x103)});return;}console[_0xc2ff30(0xaa)]({'req':_0x2b3837[_0xc2ff30(0xae)]});let _0xb81930=_0xd8a114[_0xc2ff30(0xb6)];if(_0x2b3837[_0xc2ff30(0xe5)]){const _0x44e9e4=_0xc2ff30(0xd8)+randomUUID()+_0xc2ff30(0xa9);fs[_0xc2ff30(0xf4)](_0x2b3837[_0xc2ff30(0xe5)]['path'],'./'+_0x44e9e4),fs[_0xc2ff30(0xc7)](_0x2b3837[_0xc2ff30(0xe5)][_0xc2ff30(0xd0)]),config[_0xc2ff30(0xeb)]?_0xb81930=config[_0xc2ff30(0xf5)]+'/'+_0x44e9e4:_0xb81930=config[_0xc2ff30(0xff)]+'/'+_0x44e9e4;}try{await conn[_0xc2ff30(0xe0)]()['execute']('UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x36adcc,_0x13c624,_0x8d11af,_0xb81930,_0x11873e]);let _0x47be83;try{_0x47be83=jwt[_0xc2ff30(0xe2)]({'userId':_0xd8a114['id'],'email':_0xd8a114[_0xc2ff30(0xe7)]},config[_0xc2ff30(0xcb)],{'expiresIn':_0xc2ff30(0xf9)});}catch(_0x5beb76){console[_0xc2ff30(0xaa)](_0x5beb76),_0x42cfbe[_0xc2ff30(0xc4)](0x1f4)[_0xc2ff30(0xc9)]({'error':_0xc2ff30(0xcf)});return;}_0x42cfbe['status'](0xc8)[_0xc2ff30(0xc9)]({'success':!![],'data':{'userId':_0xd8a114['id'],'username':_0x36adcc,'first_name':_0x13c624,'last_name':_0x8d11af,'email':_0xd8a114[_0xc2ff30(0xe7)],'avatar_url':_0xb81930,'token':_0x47be83}});}catch(_0x38edb6){console[_0xc2ff30(0xaa)]({'err':_0x38edb6}),_0x42cfbe[_0xc2ff30(0xc4)](0x1f4)[_0xc2ff30(0xc9)]({'error':_0xc2ff30(0xcf)});return;}}),module[a1_0xb332d6(0xe4)]=router;