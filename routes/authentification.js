const a1_0x16920b=a1_0x45a8;(function(_0x3d82f4,_0x1dd1aa){const _0x8e3ddb=a1_0x45a8,_0x5d9786=_0x3d82f4();while(!![]){try{const _0xd80d9b=parseInt(_0x8e3ddb(0x19a))/0x1+-parseInt(_0x8e3ddb(0x1a3))/0x2*(-parseInt(_0x8e3ddb(0x19d))/0x3)+parseInt(_0x8e3ddb(0x1aa))/0x4+-parseInt(_0x8e3ddb(0x1c0))/0x5*(-parseInt(_0x8e3ddb(0x18d))/0x6)+-parseInt(_0x8e3ddb(0x190))/0x7+-parseInt(_0x8e3ddb(0x19b))/0x8+-parseInt(_0x8e3ddb(0x1be))/0x9*(parseInt(_0x8e3ddb(0x195))/0xa);if(_0xd80d9b===_0x1dd1aa)break;else _0x5d9786['push'](_0x5d9786['shift']());}catch(_0x14f0d3){_0x5d9786['push'](_0x5d9786['shift']());}}}(a1_0xd7e4,0x684d9));const jwt=require('jsonwebtoken'),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require(a1_0x16920b(0x1d3)),multer=require(a1_0x16920b(0x1b0)),fs=require('fs'),verifyToken=require('../libs/jwt')['verifyToken'],{sendWelcomeEmail}=require('../libs/email-utils'),axios=require(a1_0x16920b(0x1b2));function a1_0xd7e4(){const _0x4f378e=['success','stack','json','exports','mkdirSync','sign','single','226062srpVYy','post','93950FgpDhU','/update-password','ServerUrl','.png','role','compare','city','Error\x20during\x20reCAPTCHA\x20verification.','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','name','callbackMethod_gatewayUrl','path','/signup','jwtSecretKey','Invalid\x20email\x20or\x20password','Error\x20during\x20user\x20creation:','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','is_enabled','===================error===================','../libs/mysql.js','email','params','country_name','Error!\x20Something\x20went\x20wrong.','24h','hash','Invalid\x20validation\x20token','error','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','message','username','first_name','/validate-email/:token','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','https://www.google.com/recaptcha/api/siteverify','status','region','222thKths','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','insertId','3451007bmxmPW','recaptchaSecretKey','reCAPTCHA\x20verification\x20error:','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','body','110RQuaYm','crypted_password','languages','diskStorage','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','198201KnDLfd','5710128nsCAqE','user','962007piQSjK','file','data','execute','avatar_url','avatar','2PTIqMz','express','/login','unlinkSync','existsSync','/update-user-info','length','2784760GZqQEi','log','copyFileSync','Invalid\x20user','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','last_name','multer','./avatars','axios','promise','avatars','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','time_zone'];a1_0xd7e4=function(){return _0x4f378e;};return a1_0xd7e4();}!fs[a1_0x16920b(0x1a7)](a1_0x16920b(0x1b1))&&fs[a1_0x16920b(0x1bb)](a1_0x16920b(0x1b1));const express=require(a1_0x16920b(0x1a4)),router=express['Router'](),{randomUUID}=require('crypto'),storage=multer[a1_0x16920b(0x198)]({'destination':function(_0x2c948a,_0x96f9b7,_0x1644da){const _0x2bca4a=a1_0x16920b;_0x1644da(null,_0x2bca4a(0x1b4));}}),upload=multer({'storage':storage});function a1_0x45a8(_0x4dcf28,_0x1fee7e){const _0xd7e443=a1_0xd7e4();return a1_0x45a8=function(_0x45a84d,_0x334f47){_0x45a84d=_0x45a84d-0x183;let _0x41522f=_0xd7e443[_0x45a84d];return _0x41522f;},a1_0x45a8(_0x4dcf28,_0x1fee7e);}router[a1_0x16920b(0x1bf)](a1_0x16920b(0x1a5),async(_0x23f8eb,_0x3739ce,_0x382a84)=>{const _0x51c553=a1_0x16920b;let {email:_0x3a50b7,password:_0xf4a5ad}=_0x23f8eb[_0x51c553(0x194)];console[_0x51c553(0x1ab)]({'email':_0x3a50b7,'password':_0xf4a5ad});let _0x452c2f;try{const [_0x2c34fc]=await conn[_0x51c553(0x1b3)]()[_0x51c553(0x1a0)](_0x51c553(0x18e),[_0x3a50b7]);_0x2c34fc[_0x51c553(0x1a9)]>0x0&&(_0x452c2f=_0x2c34fc[0x0]);}catch(_0x474c90){console['log']({'err':_0x474c90}),_0x3739ce[_0x51c553(0x18b)](0x1f4)[_0x51c553(0x1b9)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x452c2f||!await bcrypt[_0x51c553(0x1c5)](_0xf4a5ad,_0x452c2f?.['crypted_password'])){_0x3739ce[_0x51c553(0x18b)](0x191)['json']({'error':_0x51c553(0x1ce)});return;}let _0x394785;try{_0x394785=jwt[_0x51c553(0x1bc)]({'userId':_0x452c2f['id'],'email':_0x452c2f['email']},config[_0x51c553(0x1cd)],{'expiresIn':_0x51c553(0x1d8)});}catch(_0x299f97){console[_0x51c553(0x1ab)](_0x299f97),_0x3739ce[_0x51c553(0x18b)](0x1f4)[_0x51c553(0x1b9)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x3739ce[_0x51c553(0x18b)](0xc8)[_0x51c553(0x1b9)]({'success':!![],'data':{'userId':_0x452c2f['id'],'username':_0x452c2f['username'],'first_name':_0x452c2f[_0x51c553(0x187)],'last_name':_0x452c2f[_0x51c553(0x1af)],'email':_0x452c2f['email'],'avatar_url':_0x452c2f['avatar_url'],'id':_0x452c2f['id'],'role':_0x452c2f[_0x51c553(0x1c4)],'token':_0x394785}});}),router[a1_0x16920b(0x1bf)](a1_0x16920b(0x1cc),async(_0x3136ce,_0x21a0c6,_0x13e0cb)=>{const _0x288950=a1_0x16920b,{username:_0x555cd4,email:_0x2cba27,password:_0x27e42b,geolocation:_0x305d62,recaptchaToken:_0x3ecf9b}=_0x3136ce[_0x288950(0x194)];if(config['recaptchaEnabled']){if(!_0x3ecf9b)return _0x21a0c6[_0x288950(0x18b)](0x190)[_0x288950(0x1b9)]({'error':_0x288950(0x184)});try{const _0x873ea8=await axios[_0x288950(0x1bf)](_0x288950(0x18a),null,{'params':{'secret':config[_0x288950(0x191)],'response':_0x3ecf9b}});if(!_0x873ea8[_0x288950(0x19f)][_0x288950(0x1b7)])return _0x21a0c6[_0x288950(0x18b)](0x190)[_0x288950(0x1b9)]({'error':_0x288950(0x184),'recaptchaErrors':_0x873ea8[_0x288950(0x19f)]['error-codes']});}catch(_0x57eaa3){return console[_0x288950(0x183)](_0x288950(0x192),_0x57eaa3),_0x21a0c6[_0x288950(0x18b)](0x1f4)[_0x288950(0x1b9)]({'error':_0x288950(0x1c7)});}}const [_0x1420bc]=await conn[_0x288950(0x1b3)]()[_0x288950(0x1a0)](_0x288950(0x1b5),[_0x2cba27]);if(_0x1420bc['length']>0x0){_0x21a0c6['status'](0x1a6)[_0x288950(0x1b9)]({'error':'User\x20already\x20exists'});return;}const _0x39ac0f=await bcrypt[_0x288950(0x1d9)](_0x27e42b,0xa);let _0x2275e6=null,_0xf2ef86=0x1;config['enableEmailVerification']&&(_0x2275e6=randomUUID(),_0xf2ef86=0x0);let _0x4533c3=null,_0xf248da=null,_0x10f237=null,_0x55777a=null,_0x3454d6=null,_0x511f21=null;if(_0x305d62)try{const _0x2342f4=_0x305d62;_0x4533c3=_0x2342f4[_0x288950(0x1c6)]||null,_0xf248da=_0x2342f4[_0x288950(0x18c)]||null,_0x10f237=_0x2342f4[_0x288950(0x1d6)]||null,_0x2342f4[_0x288950(0x197)]&&_0x2342f4['languages'][_0x288950(0x1a9)]>0x0&&(_0x55777a=_0x2342f4['languages'][0x0]['code']||null,_0x3454d6=_0x2342f4[_0x288950(0x197)][0x0]['name']||null),_0x2342f4[_0x288950(0x1b6)]&&(_0x511f21=_0x2342f4[_0x288950(0x1b6)][_0x288950(0x1c9)]||null);}catch(_0xc32529){console[_0x288950(0x1ab)]('Error\x20parsing\x20geolocation\x20data:',_0xc32529);}let _0x262d2a;try{const _0x35919a=randomUUID(),_0xb89f7b='./uploads/'+_0x35919a;fs[_0x288950(0x1bb)](_0xb89f7b);const [_0x547d49]=await conn[_0x288950(0x1b3)]()[_0x288950(0x1a0)](_0x288950(0x193),[_0x555cd4,_0x2cba27,_0x39ac0f,'demo_user',_0xf2ef86,_0x2275e6,_0x35919a,_0x4533c3,_0xf248da,_0x10f237,_0x55777a,_0x3454d6,_0x511f21]);if(_0x547d49[_0x288950(0x18f)]){const [_0x50dbfc]=await conn[_0x288950(0x1b3)]()[_0x288950(0x1a0)](_0x288950(0x199),[_0x547d49[_0x288950(0x18f)]]);_0x50dbfc[_0x288950(0x1a9)]>0x0&&(_0x262d2a=_0x50dbfc[0x0]);}}catch(_0x4bbb06){console[_0x288950(0x1ab)](_0x288950(0x1cf),_0x4bbb06),_0x21a0c6[_0x288950(0x18b)](0x1f4)[_0x288950(0x1b9)]({'error':_0x288950(0x1d7)});return;}let _0x372fb7;try{_0x372fb7=jwt[_0x288950(0x1bc)]({'userId':_0x262d2a['id'],'email':_0x262d2a[_0x288950(0x1d4)]},config[_0x288950(0x1cd)],{'expiresIn':'24h'});}catch(_0x7b639){_0x21a0c6[_0x288950(0x18b)](0x1f4)[_0x288950(0x1b9)]({'error':_0x288950(0x1d7)});return;}if(config['enableEmailVerification']){try{await sendWelcomeEmail(_0x262d2a,_0x2275e6);}catch(_0x5a2d24){console[_0x288950(0x1ab)](_0x288950(0x1d2)),console[_0x288950(0x1ab)](_0x5a2d24);}_0x21a0c6[_0x288950(0x18b)](0xc8)[_0x288950(0x1b9)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.'});return;}_0x21a0c6['status'](0xc9)[_0x288950(0x1b9)]({'success':!![],'data':{'userId':_0x262d2a['id'],'username':_0x262d2a['username'],'first_name':_0x262d2a[_0x288950(0x187)],'last_name':_0x262d2a['last_name'],'email':_0x262d2a['email'],'avatar_url':_0x262d2a[_0x288950(0x1a1)],'id':_0x262d2a['id'],'role':_0x262d2a['role'],'token':_0x372fb7,'is_enabled':_0x262d2a[_0x288950(0x1d1)]}});}),router[a1_0x16920b(0x1bf)](a1_0x16920b(0x188),async(_0x358b1e,_0x55d6b6)=>{const _0x42fde0=a1_0x16920b;try{const {token:_0x577121}=_0x358b1e[_0x42fde0(0x1d5)],[_0x2b5870]=await conn[_0x42fde0(0x1b3)]()[_0x42fde0(0x1a0)](_0x42fde0(0x1ae),[_0x577121]);if(_0x2b5870[_0x42fde0(0x1a9)]===0x0){_0x55d6b6[_0x42fde0(0x18b)](0x194)[_0x42fde0(0x1b9)]({'error':_0x42fde0(0x1da)});return;}await conn[_0x42fde0(0x1b3)]()['execute'](_0x42fde0(0x1d0),[_0x577121]);const _0x252c41=jwt['sign']({'id':_0x2b5870[0x0]['id'],'email':_0x2b5870[0x0]['email']},config[_0x42fde0(0x1cd)],{'expiresIn':'24h'});_0x55d6b6[_0x42fde0(0x18b)](0xc8)['json']({'success':!![],'message':'Email\x20validated\x20successfully','data':{'userId':_0x2b5870[0x0]['id'],'username':_0x2b5870[0x0][_0x42fde0(0x186)],'first_name':_0x2b5870[0x0][_0x42fde0(0x187)],'last_name':_0x2b5870[0x0]['last_name'],'email':_0x2b5870[0x0]['email'],'avatar_url':_0x2b5870[0x0][_0x42fde0(0x1a1)],'id':_0x2b5870[0x0]['id'],'role':_0x2b5870[0x0]['role'],'token':_0x252c41,'is_enabled':0x1}});}catch(_0x2361b5){console[_0x42fde0(0x1ab)](_0x42fde0(0x1d2)),console['log'](_0x2361b5),_0x55d6b6[_0x42fde0(0x18b)](0x1f4)['json']({'error':_0x42fde0(0x1d7),'stack':_0x2361b5[_0x42fde0(0x1b8)],'message':_0x2361b5[_0x42fde0(0x185)]});}}),router['post'](a1_0x16920b(0x1c1),verifyToken,async(_0xc314c7,_0x2138cd,_0x45a961)=>{const _0x57aaef=a1_0x16920b,{current_password:_0x3ef115,new_password:_0x1ffd5a}=_0xc314c7[_0x57aaef(0x194)];console[_0x57aaef(0x1ab)]({'body':_0xc314c7[_0x57aaef(0x194)]});const _0x158420=_0xc314c7[_0x57aaef(0x19c)]['email'];let _0x3e82df;try{const [_0x40ef0]=await conn[_0x57aaef(0x1b3)]()[_0x57aaef(0x1a0)](_0x57aaef(0x1b5),[_0x158420]);if(_0x40ef0[_0x57aaef(0x1a9)]>0x0){_0x3e82df=_0x40ef0[0x0];if(!await bcrypt[_0x57aaef(0x1c5)](_0x3ef115,_0x3e82df[_0x57aaef(0x196)])){_0x2138cd[_0x57aaef(0x18b)](0x191)[_0x57aaef(0x1b9)]({'error':'Invalid\x20password'});return;}const _0x41f031=await bcrypt[_0x57aaef(0x1d9)](_0x1ffd5a,0xa);await conn['promise']()[_0x57aaef(0x1a0)](_0x57aaef(0x189),[_0x41f031,_0x158420]),_0x2138cd[_0x57aaef(0x18b)](0xc8)[_0x57aaef(0x1b9)]({'success':!![]});}}catch(_0x132b1c){console[_0x57aaef(0x1ab)]({'err':_0x132b1c}),_0x2138cd['status'](0x1f4)[_0x57aaef(0x1b9)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router['post'](a1_0x16920b(0x1a8),upload[a1_0x16920b(0x1bd)](a1_0x16920b(0x1a2)),verifyToken,async(_0x195e65,_0x21f24a,_0x2dd5b7)=>{const _0x4fef8e=a1_0x16920b,{username:_0x437e71,first_name:_0x1a0a3c,last_name:_0x4d489f}=_0x195e65[_0x4fef8e(0x194)],_0x45251d=_0x195e65['user'][_0x4fef8e(0x1d4)];let _0x2b0ab7;try{const [_0x5f4115]=await conn['promise']()[_0x4fef8e(0x1a0)](_0x4fef8e(0x1b5),[_0x45251d]);_0x5f4115[_0x4fef8e(0x1a9)]>0x0&&(_0x2b0ab7=_0x5f4115[0x0]);}catch(_0x4440d9){console[_0x4fef8e(0x1ab)]({'err':_0x4440d9}),_0x21f24a['status'](0x1f4)[_0x4fef8e(0x1b9)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x2b0ab7){_0x21f24a[_0x4fef8e(0x18b)](0x191)[_0x4fef8e(0x1b9)]({'error':_0x4fef8e(0x1ad)});return;}console[_0x4fef8e(0x1ab)]({'req':_0x195e65[_0x4fef8e(0x194)]});let _0x3d568c=_0x2b0ab7[_0x4fef8e(0x1a1)];if(_0x195e65[_0x4fef8e(0x19e)]){const _0x4bda42='avatars/'+randomUUID()+_0x4fef8e(0x1c3);fs[_0x4fef8e(0x1ac)](_0x195e65[_0x4fef8e(0x19e)][_0x4fef8e(0x1cb)],'./'+_0x4bda42),fs[_0x4fef8e(0x1a6)](_0x195e65[_0x4fef8e(0x19e)][_0x4fef8e(0x1cb)]),config['callbackMethod_gatewayUrl_flag']?_0x3d568c=config[_0x4fef8e(0x1ca)]+'/'+_0x4bda42:_0x3d568c=config[_0x4fef8e(0x1c2)]+'/'+_0x4bda42;}try{await conn[_0x4fef8e(0x1b3)]()['execute'](_0x4fef8e(0x1c8),[_0x437e71,_0x1a0a3c,_0x4d489f,_0x3d568c,_0x45251d]);let _0x127101;try{_0x127101=jwt[_0x4fef8e(0x1bc)]({'userId':_0x2b0ab7['id'],'email':_0x2b0ab7[_0x4fef8e(0x1d4)]},config[_0x4fef8e(0x1cd)],{'expiresIn':_0x4fef8e(0x1d8)});}catch(_0x17d8b2){console[_0x4fef8e(0x1ab)](_0x17d8b2),_0x21f24a['status'](0x1f4)[_0x4fef8e(0x1b9)]({'error':_0x4fef8e(0x1d7)});return;}_0x21f24a['status'](0xc8)[_0x4fef8e(0x1b9)]({'success':!![],'data':{'userId':_0x2b0ab7['id'],'username':_0x437e71,'first_name':_0x1a0a3c,'last_name':_0x4d489f,'email':_0x2b0ab7[_0x4fef8e(0x1d4)],'avatar_url':_0x3d568c,'token':_0x127101}});}catch(_0x163fb9){console['log']({'err':_0x163fb9}),_0x21f24a[_0x4fef8e(0x18b)](0x1f4)[_0x4fef8e(0x1b9)]({'error':_0x4fef8e(0x1d7)});return;}}),module[a1_0x16920b(0x1ba)]=router;