const a1_0x321ab4=a1_0x4b1d;function a1_0x4b1d(_0x25d943,_0xc8df30){const _0x45a0c5=a1_0x45a0();return a1_0x4b1d=function(_0x4b1d29,_0x4915cd){_0x4b1d29=_0x4b1d29-0x65;let _0x25915e=_0x45a0c5[_0x4b1d29];return _0x25915e;},a1_0x4b1d(_0x25d943,_0xc8df30);}(function(_0x472f79,_0x129493){const _0x156e89=a1_0x4b1d,_0x463a14=_0x472f79();while(!![]){try{const _0x4f6c19=parseInt(_0x156e89(0x71))/0x1*(parseInt(_0x156e89(0x78))/0x2)+-parseInt(_0x156e89(0x7a))/0x3+-parseInt(_0x156e89(0x7e))/0x4+parseInt(_0x156e89(0xa7))/0x5+-parseInt(_0x156e89(0xab))/0x6*(-parseInt(_0x156e89(0xb2))/0x7)+parseInt(_0x156e89(0x8c))/0x8+-parseInt(_0x156e89(0xa1))/0x9;if(_0x4f6c19===_0x129493)break;else _0x463a14['push'](_0x463a14['shift']());}catch(_0xf68440){_0x463a14['push'](_0x463a14['shift']());}}}(a1_0x45a0,0xb6095));function a1_0x45a0(){const _0x277cd7=['./uploads/','===================error===================','body','User\x20already\x20exists','smtpFrom','message','95823MnKSDX','Invalid\x20email\x20or\x20password','avatar_url','/login','/validate-email/','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','insertId','user','/signup','stack','compare','/update-user-info','execute','log','39bDflgu','/validate-email/:token','avatars','./avatars','Error!\x20Something\x20went\x20wrong.','.png','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','63242BoprZb','is_enabled','2539935ktIwRN','Welcome\x20to\x20CADViewer','single','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','4911492RlzEzW','sign','enableEmailVerification','ServerUrl','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','email','<p>Welcome\x20to\x20CADViewer</p>','24h','json','path','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Email\x20validated\x20successfully','sendMail','last_name','4078184JNahqm','multer','transporter','first_name','jwtSecretKey','hash','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','renameSync','username','mkdirSync','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','existsSync','crypted_password','frontendUrl','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','Invalid\x20password','post','Router','promise','demo_user','length','555696xaEZFe','status','diskStorage','crypto','role','jsonwebtoken','424190hQLCVK','params','../libs/mail','Invalid\x20validation\x20token','462BSTMjG'];a1_0x45a0=function(){return _0x277cd7;};return a1_0x45a0();}const jwt=require(a1_0x321ab4(0xa6)),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x321ab4(0x8d)),fs=require('fs'),verifyToken=require('../libs/jwt')['verifyToken'];!fs[a1_0x321ab4(0x97)](a1_0x321ab4(0x74))&&fs[a1_0x321ab4(0x95)](a1_0x321ab4(0x74));const express=require('express'),router=express[a1_0x321ab4(0x9d)](),{randomUUID}=require(a1_0x321ab4(0xa4)),storage=multer[a1_0x321ab4(0xa3)]({'destination':function(_0xfcdc02,_0x20a151,_0x11170b){const _0x53c46b=a1_0x321ab4;_0x11170b(null,_0x53c46b(0x73));}}),upload=multer({'storage':storage});router[a1_0x321ab4(0x9c)](a1_0x321ab4(0x66),async(_0x5117bb,_0x1e8e08,_0x4b7764)=>{const _0x13e3fa=a1_0x321ab4;let {email:_0x280028,password:_0x546e8c}=_0x5117bb[_0x13e3fa(0xae)];console[_0x13e3fa(0x70)]({'email':_0x280028,'password':_0x546e8c});let _0x39e8ee;try{const [_0x5d24ea]=await conn[_0x13e3fa(0x9e)]()[_0x13e3fa(0x6f)](_0x13e3fa(0x68),[_0x280028]);_0x5d24ea[_0x13e3fa(0xa0)]>0x0&&(_0x39e8ee=_0x5d24ea[0x0]);}catch(_0x4f7caf){console[_0x13e3fa(0x70)]({'err':_0x4f7caf}),_0x1e8e08[_0x13e3fa(0xa2)](0x1f4)[_0x13e3fa(0x86)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}console[_0x13e3fa(0x70)](_0x39e8ee),console[_0x13e3fa(0x70)](_0x546e8c),console['log'](_0x39e8ee[_0x13e3fa(0x98)]);if(!_0x39e8ee||!await bcrypt[_0x13e3fa(0x6d)](_0x546e8c,_0x39e8ee[_0x13e3fa(0x98)])){_0x1e8e08[_0x13e3fa(0xa2)](0x191)[_0x13e3fa(0x86)]({'error':_0x13e3fa(0xb3)});return;}let _0x1761a8;try{_0x1761a8=jwt[_0x13e3fa(0x7f)]({'userId':_0x39e8ee['id'],'email':_0x39e8ee[_0x13e3fa(0x83)]},config[_0x13e3fa(0x90)],{'expiresIn':_0x13e3fa(0x85)});}catch(_0x4db8ec){console[_0x13e3fa(0x70)](_0x4db8ec),_0x1e8e08[_0x13e3fa(0xa2)](0x1f4)[_0x13e3fa(0x86)]({'error':_0x13e3fa(0x75)});return;}_0x1e8e08[_0x13e3fa(0xa2)](0xc8)[_0x13e3fa(0x86)]({'success':!![],'data':{'userId':_0x39e8ee['id'],'username':_0x39e8ee[_0x13e3fa(0x94)],'first_name':_0x39e8ee[_0x13e3fa(0x8f)],'last_name':_0x39e8ee['last_name'],'email':_0x39e8ee[_0x13e3fa(0x83)],'avatar_url':_0x39e8ee[_0x13e3fa(0x65)],'id':_0x39e8ee['id'],'role':_0x39e8ee[_0x13e3fa(0xa5)],'token':_0x1761a8}});}),router[a1_0x321ab4(0x9c)](a1_0x321ab4(0x6b),async(_0x30bda0,_0x1db010,_0x4204a8)=>{const _0x333a7b=a1_0x321ab4,{username:_0x5c4082,email:_0x6ef957,password:_0x242596}=_0x30bda0['body'],[_0x2b6f44]=await conn['promise']()[_0x333a7b(0x6f)](_0x333a7b(0x82),[_0x6ef957]);if(_0x2b6f44[_0x333a7b(0xa0)]>0x0){_0x1db010[_0x333a7b(0xa2)](0x1a6)[_0x333a7b(0x86)]({'error':_0x333a7b(0xaf)});return;}const _0x148b1a=await bcrypt[_0x333a7b(0x91)](_0x242596,0xa);let _0x50e112=null,_0x64c130=0x1;config[_0x333a7b(0x80)]&&(_0x50e112=randomUUID(),_0x64c130=0x0);let _0x381a9f;try{const _0x33dfde=randomUUID(),_0x34c9e5=_0x333a7b(0xac)+_0x33dfde;fs[_0x333a7b(0x95)](_0x34c9e5);const [_0x56adea]=await conn[_0x333a7b(0x9e)]()['execute'](_0x333a7b(0x96),[_0x5c4082,_0x6ef957,_0x148b1a,_0x333a7b(0x9f),_0x64c130,_0x50e112,_0x33dfde]);if(_0x56adea[_0x333a7b(0x69)]){const [_0xcef4cb]=await conn[_0x333a7b(0x9e)]()[_0x333a7b(0x6f)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x56adea[_0x333a7b(0x69)]]);_0xcef4cb['length']>0x0&&(_0x381a9f=_0xcef4cb[0x0]);}}catch{_0x1db010['status'](0x1f4)[_0x333a7b(0x86)]({'error':_0x333a7b(0x75)});return;}let _0x3037eb;try{_0x3037eb=jwt[_0x333a7b(0x7f)]({'userId':_0x381a9f['id'],'email':_0x381a9f['email']},config[_0x333a7b(0x90)],{'expiresIn':_0x333a7b(0x85)});}catch(_0x2516c4){_0x1db010['status'](0x1f4)['json']({'error':_0x333a7b(0x75)});return;}const _0x27636b=require(_0x333a7b(0xa9))[_0x333a7b(0x8e)];let _0x3e8ce5=_0x333a7b(0x84);if(config[_0x333a7b(0x80)]){const _0x106560=config[_0x333a7b(0x99)]+_0x333a7b(0x67)+_0x50e112;_0x3e8ce5=_0x333a7b(0x7d)+_0x106560+'\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>'+_0x106560+_0x333a7b(0x9a);const _0x36554c={'from':config[_0x333a7b(0xb0)],'to':_0x381a9f[_0x333a7b(0x83)],'subject':_0x333a7b(0x7b),'text':_0x333a7b(0x7b),'html':_0x3e8ce5};try{await _0x27636b[_0x333a7b(0x8a)](_0x36554c);}catch(_0x7a091e){console[_0x333a7b(0x70)]('===================error==================='),console['log'](_0x7a091e),_0x1db010['status'](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0x7a091e[_0x333a7b(0x6c)],'message':_0x7a091e['message']});return;}_0x1db010['status'](0xc8)[_0x333a7b(0x86)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account'});return;}_0x1db010[_0x333a7b(0xa2)](0xc9)[_0x333a7b(0x86)]({'success':!![],'data':{'userId':_0x381a9f['id'],'username':_0x381a9f['username'],'first_name':_0x381a9f['first_name'],'last_name':_0x381a9f[_0x333a7b(0x8b)],'email':_0x381a9f['email'],'avatar_url':_0x381a9f[_0x333a7b(0x65)],'id':_0x381a9f['id'],'role':_0x381a9f['role'],'token':_0x3037eb,'is_enabled':_0x381a9f[_0x333a7b(0x79)]}});}),router[a1_0x321ab4(0x9c)](a1_0x321ab4(0x72),async(_0xb6d3c3,_0x5d2dc3)=>{const _0x50f6f3=a1_0x321ab4;try{const {token:_0x46a96a}=_0xb6d3c3[_0x50f6f3(0xa8)],[_0x46d346]=await conn['promise']()[_0x50f6f3(0x6f)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0x46a96a]);if(_0x46d346[_0x50f6f3(0xa0)]===0x0){_0x5d2dc3[_0x50f6f3(0xa2)](0x194)[_0x50f6f3(0x86)]({'error':_0x50f6f3(0xaa)});return;}await conn[_0x50f6f3(0x9e)]()[_0x50f6f3(0x6f)](_0x50f6f3(0x92),[_0x46a96a]);const _0x4342e8=jwt['sign']({'id':_0x46d346[0x0]['id'],'email':_0x46d346[0x0][_0x50f6f3(0x83)]},config[_0x50f6f3(0x90)],{'expiresIn':'24h'});_0x5d2dc3['status'](0xc8)[_0x50f6f3(0x86)]({'success':!![],'message':_0x50f6f3(0x89),'data':{'userId':_0x46d346[0x0]['id'],'username':_0x46d346[0x0][_0x50f6f3(0x94)],'first_name':_0x46d346[0x0][_0x50f6f3(0x8f)],'last_name':_0x46d346[0x0]['last_name'],'email':_0x46d346[0x0][_0x50f6f3(0x83)],'avatar_url':_0x46d346[0x0][_0x50f6f3(0x65)],'id':_0x46d346[0x0]['id'],'role':_0x46d346[0x0]['role'],'token':_0x4342e8,'is_enabled':0x1}});}catch(_0x19250c){console['log'](_0x50f6f3(0xad)),console['log'](_0x19250c),_0x5d2dc3['status'](0x1f4)[_0x50f6f3(0x86)]({'error':_0x50f6f3(0x75),'stack':_0x19250c['stack'],'message':_0x19250c[_0x50f6f3(0xb1)]});}}),router[a1_0x321ab4(0x9c)]('/update-password',verifyToken,async(_0x44c680,_0x2d10f9,_0x99cf50)=>{const _0x20cb03=a1_0x321ab4,{current_password:_0x1aa6d9,new_password:_0x369394}=_0x44c680[_0x20cb03(0xae)];console[_0x20cb03(0x70)]({'body':_0x44c680[_0x20cb03(0xae)]});const _0xf51e9f=_0x44c680[_0x20cb03(0x6a)][_0x20cb03(0x83)];let _0x14932f;try{const [_0x964d49]=await conn[_0x20cb03(0x9e)]()[_0x20cb03(0x6f)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0xf51e9f]);if(_0x964d49['length']>0x0){_0x14932f=_0x964d49[0x0];if(!await bcrypt[_0x20cb03(0x6d)](_0x1aa6d9,_0x14932f[_0x20cb03(0x98)])){_0x2d10f9[_0x20cb03(0xa2)](0x191)[_0x20cb03(0x86)]({'error':_0x20cb03(0x9b)});return;}const _0x3f3a1d=await bcrypt[_0x20cb03(0x91)](_0x369394,0xa);await conn[_0x20cb03(0x9e)]()[_0x20cb03(0x6f)](_0x20cb03(0x77),[_0x3f3a1d,_0xf51e9f]),_0x2d10f9['status'](0xc8)[_0x20cb03(0x86)]({'success':!![]});}}catch(_0x14d0cd){console[_0x20cb03(0x70)]({'err':_0x14d0cd}),_0x2d10f9[_0x20cb03(0xa2)](0x1f4)[_0x20cb03(0x86)]({'error':_0x20cb03(0x75)});return;}}),router['post'](a1_0x321ab4(0x6e),upload[a1_0x321ab4(0x7c)]('avatar'),verifyToken,async(_0x506750,_0x37b61d,_0x1720db)=>{const _0x279d5c=a1_0x321ab4,{username:_0x39190a,first_name:_0x25833c,last_name:_0x7ca42c}=_0x506750[_0x279d5c(0xae)],_0x2d3b77=_0x506750[_0x279d5c(0x6a)][_0x279d5c(0x83)];let _0x297a55;try{const [_0x12af21]=await conn[_0x279d5c(0x9e)]()[_0x279d5c(0x6f)](_0x279d5c(0x82),[_0x2d3b77]);_0x12af21[_0x279d5c(0xa0)]>0x0&&(_0x297a55=_0x12af21[0x0]);}catch(_0x50f9b4){console['log']({'err':_0x50f9b4}),_0x37b61d['status'](0x1f4)['json']({'error':_0x279d5c(0x75)});return;}if(!_0x297a55){_0x37b61d[_0x279d5c(0xa2)](0x191)[_0x279d5c(0x86)]({'error':'Invalid\x20user'});return;}console[_0x279d5c(0x70)]({'req':_0x506750['body']});let _0x18f270=_0x297a55['avatar_url'];if(_0x506750['file']){const _0x2807ad='avatars/'+randomUUID()+_0x279d5c(0x76);fs[_0x279d5c(0x93)](_0x506750['file'][_0x279d5c(0x87)],'./'+_0x2807ad),_0x18f270=config[_0x279d5c(0x81)]+'/'+_0x2807ad;}try{await conn['promise']()[_0x279d5c(0x6f)](_0x279d5c(0x88),[_0x39190a,_0x25833c,_0x7ca42c,_0x18f270,_0x2d3b77]);let _0x4c3e1a;try{_0x4c3e1a=jwt[_0x279d5c(0x7f)]({'userId':_0x297a55['id'],'email':_0x297a55[_0x279d5c(0x83)]},config['jwtSecretKey'],{'expiresIn':'24h'});}catch(_0x295032){console[_0x279d5c(0x70)](_0x295032),_0x37b61d[_0x279d5c(0xa2)](0x1f4)[_0x279d5c(0x86)]({'error':_0x279d5c(0x75)});return;}_0x37b61d[_0x279d5c(0xa2)](0xc8)[_0x279d5c(0x86)]({'success':!![],'data':{'userId':_0x297a55['id'],'username':_0x39190a,'first_name':_0x25833c,'last_name':_0x7ca42c,'email':_0x297a55[_0x279d5c(0x83)],'avatar_url':_0x18f270,'token':_0x4c3e1a}});}catch(_0x5d151f){console[_0x279d5c(0x70)]({'err':_0x5d151f}),_0x37b61d[_0x279d5c(0xa2)](0x1f4)[_0x279d5c(0x86)]({'error':_0x279d5c(0x75)});return;}}),module['exports']=router;