const a1_0x1b9564=a1_0x5cd3;function a1_0x5cd3(_0x38e048,_0x199c33){const _0x3e7809=a1_0x3e78();return a1_0x5cd3=function(_0x5cd343,_0x922691){_0x5cd343=_0x5cd343-0x96;let _0x41c19c=_0x3e7809[_0x5cd343];return _0x41c19c;},a1_0x5cd3(_0x38e048,_0x199c33);}(function(_0x2a2efc,_0xbebb3b){const _0x55eb3e=a1_0x5cd3,_0x3aa7e7=_0x2a2efc();while(!![]){try{const _0x4d4999=parseInt(_0x55eb3e(0xaf))/0x1+parseInt(_0x55eb3e(0xe2))/0x2*(-parseInt(_0x55eb3e(0xd5))/0x3)+parseInt(_0x55eb3e(0xcd))/0x4*(parseInt(_0x55eb3e(0xeb))/0x5)+parseInt(_0x55eb3e(0xc8))/0x6*(-parseInt(_0x55eb3e(0xae))/0x7)+-parseInt(_0x55eb3e(0xb7))/0x8+parseInt(_0x55eb3e(0xbb))/0x9+parseInt(_0x55eb3e(0xaa))/0xa*(parseInt(_0x55eb3e(0xdc))/0xb);if(_0x4d4999===_0xbebb3b)break;else _0x3aa7e7['push'](_0x3aa7e7['shift']());}catch(_0x10a832){_0x3aa7e7['push'](_0x3aa7e7['shift']());}}}(a1_0x3e78,0xc81b8));const jwt=require(a1_0x1b9564(0xec)),bcrypt=require(a1_0x1b9564(0xef)),config=require('../CADViewer_config.json'),conn=require(a1_0x1b9564(0xbc)),multer=require(a1_0x1b9564(0xa1)),fs=require('fs'),verifyToken=require('../libs/jwt')[a1_0x1b9564(0xd0)],{sendWelcomeEmail}=require(a1_0x1b9564(0x99)),axios=require(a1_0x1b9564(0xbe));!fs[a1_0x1b9564(0x9b)](a1_0x1b9564(0xdf))&&fs[a1_0x1b9564(0xcb)]('./avatars');function a1_0x3e78(){const _0x535953=['log','file','recaptchaSecretKey','is_enabled','182775ygfsXV','jsonwebtoken','===================error===================','crypted_password','bcrypt','callbackMethod_gatewayUrl','callbackMethod_gatewayUrl_flag','Invalid\x20user','/validate-email/:token','Error!\x20Something\x20went\x20wrong.','ServerUrl','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Invalid\x20validation\x20token','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','./uploads/','unlinkSync','promise','recaptchaEnabled','../libs/email-utils','sign','existsSync','/update-password','email','Error\x20during\x20reCAPTCHA\x20verification.','status','stack','multer','post','User\x20already\x20exists','/login','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','last_name','avatar_url','role','data','60aDLMZT','body','/update-user-info','Error\x20parsing\x20geolocation\x20data:','28eAsQdM','251904mOPSoK','compare','country_name','params','hash','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','jwtSecretKey','enableEmailVerification','11667328BOfZnn','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','reCAPTCHA\x20verification\x20error:','code','10756863srixuo','../libs/mysql.js','username','axios','/signup','name','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','success','error-codes','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Email\x20validated\x20successfully','avatar','avatars/','2017242cChunQ','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','message','mkdirSync','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','156OMhNGH','city','copyFileSync','verifyToken','Router','json','diskStorage','error','15JaFcFI','languages','user','insertId','first_name','Error\x20during\x20user\x20creation:','execute','3484613gknAft','single','https://www.google.com/recaptcha/api/siteverify','./avatars','.png','time_zone','460228qcYUPx','Invalid\x20email\x20or\x20password','path','24h','length'];a1_0x3e78=function(){return _0x535953;};return a1_0x3e78();}const express=require('express'),router=express[a1_0x1b9564(0xd1)](),{randomUUID}=require('crypto'),storage=multer[a1_0x1b9564(0xd3)]({'destination':function(_0x3cc715,_0x53ba11,_0x156742){_0x156742(null,'avatars');}}),upload=multer({'storage':storage});router['post'](a1_0x1b9564(0xa4),async(_0x9cb302,_0x8f6fd1,_0x1136cc)=>{const _0x9ed0d5=a1_0x1b9564;let {email:_0x1dd54e,password:_0x55e3a6}=_0x9cb302[_0x9ed0d5(0xab)];console[_0x9ed0d5(0xe7)]({'email':_0x1dd54e,'password':_0x55e3a6});let _0x2a2d79;try{const [_0x5c39d0]=await conn[_0x9ed0d5(0x97)]()['execute'](_0x9ed0d5(0xcc),[_0x1dd54e]);_0x5c39d0[_0x9ed0d5(0xe6)]>0x0&&(_0x2a2d79=_0x5c39d0[0x0]);}catch(_0x2bac02){console['log']({'err':_0x2bac02}),_0x8f6fd1[_0x9ed0d5(0x9f)](0x1f4)[_0x9ed0d5(0xd2)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x2a2d79||!await bcrypt[_0x9ed0d5(0xb0)](_0x55e3a6,_0x2a2d79?.[_0x9ed0d5(0xee)])){_0x8f6fd1[_0x9ed0d5(0x9f)](0x191)['json']({'error':_0x9ed0d5(0xe3)});return;}let _0x41dda6;try{_0x41dda6=jwt[_0x9ed0d5(0x9a)]({'userId':_0x2a2d79['id'],'email':_0x2a2d79[_0x9ed0d5(0x9d)]},config[_0x9ed0d5(0xb5)],{'expiresIn':_0x9ed0d5(0xe5)});}catch(_0x57c4f2){console['log'](_0x57c4f2),_0x8f6fd1[_0x9ed0d5(0x9f)](0x1f4)[_0x9ed0d5(0xd2)]({'error':_0x9ed0d5(0xf4)});return;}_0x8f6fd1[_0x9ed0d5(0x9f)](0xc8)[_0x9ed0d5(0xd2)]({'success':!![],'data':{'userId':_0x2a2d79['id'],'username':_0x2a2d79[_0x9ed0d5(0xbd)],'first_name':_0x2a2d79['first_name'],'last_name':_0x2a2d79[_0x9ed0d5(0xa6)],'email':_0x2a2d79[_0x9ed0d5(0x9d)],'avatar_url':_0x2a2d79[_0x9ed0d5(0xa7)],'id':_0x2a2d79['id'],'role':_0x2a2d79[_0x9ed0d5(0xa8)],'token':_0x41dda6}});}),router['post'](a1_0x1b9564(0xbf),async(_0x287ed2,_0x35afba,_0x3af400)=>{const _0x24f6e7=a1_0x1b9564,{username:_0x5e0891,email:_0x419171,password:_0x5cde81,geolocation:_0x47a790,recaptchaToken:_0x561fa2}=_0x287ed2[_0x24f6e7(0xab)];if(config[_0x24f6e7(0x98)]){if(!_0x561fa2)return _0x35afba['status'](0x190)[_0x24f6e7(0xd2)]({'error':_0x24f6e7(0xa5)});try{const _0x57fc4a=await axios[_0x24f6e7(0xa2)](_0x24f6e7(0xde),null,{'params':{'secret':config[_0x24f6e7(0xe9)],'response':_0x561fa2}});if(!_0x57fc4a[_0x24f6e7(0xa9)][_0x24f6e7(0xc2)])return _0x35afba[_0x24f6e7(0x9f)](0x190)[_0x24f6e7(0xd2)]({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','recaptchaErrors':_0x57fc4a['data'][_0x24f6e7(0xc3)]});}catch(_0x4d86b3){return console[_0x24f6e7(0xd4)](_0x24f6e7(0xb9),_0x4d86b3),_0x35afba[_0x24f6e7(0x9f)](0x1f4)['json']({'error':_0x24f6e7(0x9e)});}}const [_0x2e2f85]=await conn[_0x24f6e7(0x97)]()['execute'](_0x24f6e7(0xb8),[_0x419171]);if(_0x2e2f85[_0x24f6e7(0xe6)]>0x0){_0x35afba[_0x24f6e7(0x9f)](0x1a6)[_0x24f6e7(0xd2)]({'error':_0x24f6e7(0xa3)});return;}const _0x32e0c0=await bcrypt[_0x24f6e7(0xb3)](_0x5cde81,0xa);let _0x1cab69=null,_0x5d81aa=0x1;config[_0x24f6e7(0xb6)]&&(_0x1cab69=randomUUID(),_0x5d81aa=0x0);let _0x528172=null,_0xdc7ac9=null,_0x447bcf=null,_0x5a3d9b=null,_0x2a27d0=null,_0x4d1c13=null;if(_0x47a790)try{const _0x183d07=_0x47a790;_0x528172=_0x183d07[_0x24f6e7(0xce)]||null,_0xdc7ac9=_0x183d07['region']||null,_0x447bcf=_0x183d07[_0x24f6e7(0xb1)]||null,_0x183d07[_0x24f6e7(0xd6)]&&_0x183d07[_0x24f6e7(0xd6)][_0x24f6e7(0xe6)]>0x0&&(_0x5a3d9b=_0x183d07[_0x24f6e7(0xd6)][0x0][_0x24f6e7(0xba)]||null,_0x2a27d0=_0x183d07[_0x24f6e7(0xd6)][0x0]['name']||null),_0x183d07['time_zone']&&(_0x4d1c13=_0x183d07[_0x24f6e7(0xe1)][_0x24f6e7(0xc0)]||null);}catch(_0x292543){console['log'](_0x24f6e7(0xad),_0x292543);}let _0x555253;try{const _0x4991ff=randomUUID(),_0x35ac5f=_0x24f6e7(0xf9)+_0x4991ff;fs[_0x24f6e7(0xcb)](_0x35ac5f);const [_0x457837]=await conn[_0x24f6e7(0x97)]()[_0x24f6e7(0xdb)](_0x24f6e7(0xc9),[_0x5e0891,_0x419171,_0x32e0c0,'demo_user',_0x5d81aa,_0x1cab69,_0x4991ff,_0x528172,_0xdc7ac9,_0x447bcf,_0x5a3d9b,_0x2a27d0,_0x4d1c13]);if(_0x457837[_0x24f6e7(0xd8)]){const [_0x7bb761]=await conn[_0x24f6e7(0x97)]()[_0x24f6e7(0xdb)](_0x24f6e7(0xf8),[_0x457837[_0x24f6e7(0xd8)]]);_0x7bb761[_0x24f6e7(0xe6)]>0x0&&(_0x555253=_0x7bb761[0x0]);}}catch(_0x1ecf07){console[_0x24f6e7(0xe7)](_0x24f6e7(0xda),_0x1ecf07),_0x35afba['status'](0x1f4)['json']({'error':_0x24f6e7(0xf4)});return;}let _0x259fb7;try{_0x259fb7=jwt['sign']({'userId':_0x555253['id'],'email':_0x555253['email']},config[_0x24f6e7(0xb5)],{'expiresIn':_0x24f6e7(0xe5)});}catch(_0x496af1){_0x35afba[_0x24f6e7(0x9f)](0x1f4)[_0x24f6e7(0xd2)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(config[_0x24f6e7(0xb6)]){try{await sendWelcomeEmail(_0x555253,_0x1cab69);}catch(_0x48120e){console[_0x24f6e7(0xe7)](_0x24f6e7(0xed)),console[_0x24f6e7(0xe7)](_0x48120e);}_0x35afba[_0x24f6e7(0x9f)](0xc8)[_0x24f6e7(0xd2)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.'});return;}_0x35afba[_0x24f6e7(0x9f)](0xc9)[_0x24f6e7(0xd2)]({'success':!![],'data':{'userId':_0x555253['id'],'username':_0x555253[_0x24f6e7(0xbd)],'first_name':_0x555253[_0x24f6e7(0xd9)],'last_name':_0x555253['last_name'],'email':_0x555253[_0x24f6e7(0x9d)],'avatar_url':_0x555253[_0x24f6e7(0xa7)],'id':_0x555253['id'],'role':_0x555253['role'],'token':_0x259fb7,'is_enabled':_0x555253[_0x24f6e7(0xea)]}});}),router[a1_0x1b9564(0xa2)](a1_0x1b9564(0xf3),async(_0x24e2f8,_0x241660)=>{const _0x48beb0=a1_0x1b9564;try{const {token:_0x58f56d}=_0x24e2f8[_0x48beb0(0xb2)],[_0x4ecd35]=await conn['promise']()[_0x48beb0(0xdb)](_0x48beb0(0xb4),[_0x58f56d]);if(_0x4ecd35[_0x48beb0(0xe6)]===0x0){_0x241660[_0x48beb0(0x9f)](0x194)[_0x48beb0(0xd2)]({'error':_0x48beb0(0xf7)});return;}await conn[_0x48beb0(0x97)]()[_0x48beb0(0xdb)](_0x48beb0(0xc1),[_0x58f56d]);const _0x4d9540=jwt['sign']({'id':_0x4ecd35[0x0]['id'],'email':_0x4ecd35[0x0]['email']},config[_0x48beb0(0xb5)],{'expiresIn':_0x48beb0(0xe5)});_0x241660[_0x48beb0(0x9f)](0xc8)['json']({'success':!![],'message':_0x48beb0(0xc5),'data':{'userId':_0x4ecd35[0x0]['id'],'username':_0x4ecd35[0x0][_0x48beb0(0xbd)],'first_name':_0x4ecd35[0x0][_0x48beb0(0xd9)],'last_name':_0x4ecd35[0x0]['last_name'],'email':_0x4ecd35[0x0][_0x48beb0(0x9d)],'avatar_url':_0x4ecd35[0x0][_0x48beb0(0xa7)],'id':_0x4ecd35[0x0]['id'],'role':_0x4ecd35[0x0][_0x48beb0(0xa8)],'token':_0x4d9540,'is_enabled':0x1}});}catch(_0x32f327){console[_0x48beb0(0xe7)](_0x48beb0(0xed)),console['log'](_0x32f327),_0x241660[_0x48beb0(0x9f)](0x1f4)[_0x48beb0(0xd2)]({'error':_0x48beb0(0xf4),'stack':_0x32f327[_0x48beb0(0xa0)],'message':_0x32f327[_0x48beb0(0xca)]});}}),router[a1_0x1b9564(0xa2)](a1_0x1b9564(0x9c),verifyToken,async(_0x66e47f,_0x28e53e,_0x1ae75d)=>{const _0x1e16e1=a1_0x1b9564,{current_password:_0x2bddaa,new_password:_0x1a04b9}=_0x66e47f[_0x1e16e1(0xab)];console[_0x1e16e1(0xe7)]({'body':_0x66e47f[_0x1e16e1(0xab)]});const _0x240d8b=_0x66e47f[_0x1e16e1(0xd7)][_0x1e16e1(0x9d)];let _0x541bb3;try{const [_0xeba6f8]=await conn['promise']()[_0x1e16e1(0xdb)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x240d8b]);if(_0xeba6f8['length']>0x0){_0x541bb3=_0xeba6f8[0x0];if(!await bcrypt[_0x1e16e1(0xb0)](_0x2bddaa,_0x541bb3[_0x1e16e1(0xee)])){_0x28e53e[_0x1e16e1(0x9f)](0x191)[_0x1e16e1(0xd2)]({'error':'Invalid\x20password'});return;}const _0x136a73=await bcrypt[_0x1e16e1(0xb3)](_0x1a04b9,0xa);await conn[_0x1e16e1(0x97)]()[_0x1e16e1(0xdb)](_0x1e16e1(0xc4),[_0x136a73,_0x240d8b]),_0x28e53e[_0x1e16e1(0x9f)](0xc8)[_0x1e16e1(0xd2)]({'success':!![]});}}catch(_0x52906c){console[_0x1e16e1(0xe7)]({'err':_0x52906c}),_0x28e53e[_0x1e16e1(0x9f)](0x1f4)[_0x1e16e1(0xd2)]({'error':_0x1e16e1(0xf4)});return;}}),router[a1_0x1b9564(0xa2)](a1_0x1b9564(0xac),upload[a1_0x1b9564(0xdd)](a1_0x1b9564(0xc6)),verifyToken,async(_0x4ad55b,_0x1d3c21,_0x1ca54f)=>{const _0x2d1298=a1_0x1b9564,{username:_0x4d9e6a,first_name:_0x285f89,last_name:_0x140b94}=_0x4ad55b[_0x2d1298(0xab)],_0x131666=_0x4ad55b[_0x2d1298(0xd7)]['email'];let _0x1e72ef;try{const [_0x412758]=await conn[_0x2d1298(0x97)]()[_0x2d1298(0xdb)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x131666]);_0x412758['length']>0x0&&(_0x1e72ef=_0x412758[0x0]);}catch(_0xbe9014){console[_0x2d1298(0xe7)]({'err':_0xbe9014}),_0x1d3c21[_0x2d1298(0x9f)](0x1f4)[_0x2d1298(0xd2)]({'error':_0x2d1298(0xf4)});return;}if(!_0x1e72ef){_0x1d3c21['status'](0x191)[_0x2d1298(0xd2)]({'error':_0x2d1298(0xf2)});return;}console[_0x2d1298(0xe7)]({'req':_0x4ad55b[_0x2d1298(0xab)]});let _0x4eea7b=_0x1e72ef['avatar_url'];if(_0x4ad55b[_0x2d1298(0xe8)]){const _0x54b920=_0x2d1298(0xc7)+randomUUID()+_0x2d1298(0xe0);fs[_0x2d1298(0xcf)](_0x4ad55b[_0x2d1298(0xe8)][_0x2d1298(0xe4)],'./'+_0x54b920),fs[_0x2d1298(0x96)](_0x4ad55b[_0x2d1298(0xe8)][_0x2d1298(0xe4)]),config[_0x2d1298(0xf1)]?_0x4eea7b=config[_0x2d1298(0xf0)]+'/'+_0x54b920:_0x4eea7b=config[_0x2d1298(0xf5)]+'/'+_0x54b920;}try{await conn[_0x2d1298(0x97)]()[_0x2d1298(0xdb)](_0x2d1298(0xf6),[_0x4d9e6a,_0x285f89,_0x140b94,_0x4eea7b,_0x131666]);let _0x55e227;try{_0x55e227=jwt['sign']({'userId':_0x1e72ef['id'],'email':_0x1e72ef[_0x2d1298(0x9d)]},config[_0x2d1298(0xb5)],{'expiresIn':_0x2d1298(0xe5)});}catch(_0x16c794){console['log'](_0x16c794),_0x1d3c21['status'](0x1f4)[_0x2d1298(0xd2)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x1d3c21[_0x2d1298(0x9f)](0xc8)[_0x2d1298(0xd2)]({'success':!![],'data':{'userId':_0x1e72ef['id'],'username':_0x4d9e6a,'first_name':_0x285f89,'last_name':_0x140b94,'email':_0x1e72ef[_0x2d1298(0x9d)],'avatar_url':_0x4eea7b,'token':_0x55e227}});}catch(_0x5606eb){console['log']({'err':_0x5606eb}),_0x1d3c21[_0x2d1298(0x9f)](0x1f4)[_0x2d1298(0xd2)]({'error':_0x2d1298(0xf4)});return;}}),module['exports']=router;