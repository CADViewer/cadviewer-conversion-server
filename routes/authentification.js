const a1_0x567659=a1_0x1565;(function(_0x223850,_0x4ecf62){const _0x4a6fd6=a1_0x1565,_0x262b6b=_0x223850();while(!![]){try{const _0x172d0d=parseInt(_0x4a6fd6(0xe5))/0x1*(-parseInt(_0x4a6fd6(0xce))/0x2)+parseInt(_0x4a6fd6(0xc1))/0x3*(parseInt(_0x4a6fd6(0xe1))/0x4)+parseInt(_0x4a6fd6(0x109))/0x5+-parseInt(_0x4a6fd6(0xd2))/0x6*(parseInt(_0x4a6fd6(0xde))/0x7)+parseInt(_0x4a6fd6(0xf4))/0x8*(-parseInt(_0x4a6fd6(0x102))/0x9)+parseInt(_0x4a6fd6(0x107))/0xa+parseInt(_0x4a6fd6(0x105))/0xb*(parseInt(_0x4a6fd6(0xeb))/0xc);if(_0x172d0d===_0x4ecf62)break;else _0x262b6b['push'](_0x262b6b['shift']());}catch(_0x5eabad){_0x262b6b['push'](_0x262b6b['shift']());}}}(a1_0x3bda,0x3ffc8));const jwt=require(a1_0x567659(0xf1)),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x567659(0x10e)),fs=require('fs'),verifyToken=require(a1_0x567659(0xc0))[a1_0x567659(0xef)];!fs[a1_0x567659(0xf2)]('./avatars')&&fs[a1_0x567659(0xdf)](a1_0x567659(0xf7));const express=require(a1_0x567659(0xc8)),router=express[a1_0x567659(0xc9)](),{randomUUID}=require(a1_0x567659(0xdb)),storage=multer[a1_0x567659(0xe7)]({'destination':function(_0x44089d,_0x405461,_0x49ca21){const _0x32b428=a1_0x567659;_0x49ca21(null,_0x32b428(0x104));}}),upload=multer({'storage':storage});function a1_0x1565(_0x426f54,_0x2062d2){const _0x3bdac0=a1_0x3bda();return a1_0x1565=function(_0x1565d2,_0x4c64b0){_0x1565d2=_0x1565d2-0xbb;let _0x32cfb4=_0x3bdac0[_0x1565d2];return _0x32cfb4;},a1_0x1565(_0x426f54,_0x2062d2);}function a1_0x3bda(){const _0x2a4088=['length','multer','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','renameSync','message','../libs/mail','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','../libs/jwt','411087hUDqEw','smtpFrom','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','sendMail','Invalid\x20user','json','execute','express','Router','sign','Invalid\x20password','./uploads/','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','8CDiAcZ','/signup','file','24h','163182BOTbGa','insertId','avatar_url','Welcome\x20to\x20CADViewer','params','===================error===================','promise','/validate-email/','frontendUrl','crypto','crypted_password','stack','91sXFvEw','mkdirSync','/update-password','4ZbTqQX','demo_user','Invalid\x20validation\x20token','email','129289meCsxe','avatar','diskStorage','log','user','<p>Welcome\x20to\x20CADViewer</p>','3314484VqgVPa','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','username','verifyToken','body','jsonwebtoken','existsSync','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','24UWlSDD','post','enableEmailVerification','./avatars','/update-user-info','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','/login','first_name','status','jwtSecretKey','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','last_name','User\x20already\x20exists','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','746307HGgpBA','Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','avatars','11OPzfdW','role','4515430WhMgao','Error!\x20Something\x20went\x20wrong.','2583975SpTbrl','hash','Email\x20validated\x20successfully','is_enabled'];a1_0x3bda=function(){return _0x2a4088;};return a1_0x3bda();}router[a1_0x567659(0xf5)](a1_0x567659(0xfa),async(_0x112fb0,_0x4a5414,_0x25344b)=>{const _0x4bb85d=a1_0x567659;let {email:_0x1293a7,password:_0x32a274}=_0x112fb0['body'];console[_0x4bb85d(0xe8)]({'email':_0x1293a7,'password':_0x32a274});let _0x3e02f0;try{const [_0xdacaf6]=await conn['promise']()['execute'](_0x4bb85d(0x101),[_0x1293a7]);_0xdacaf6[_0x4bb85d(0x10d)]>0x0&&(_0x3e02f0=_0xdacaf6[0x0]);}catch(_0x416797){console['log']({'err':_0x416797}),_0x4a5414[_0x4bb85d(0xfc)](0x1f4)['json']({'error':_0x4bb85d(0x108)});return;}if(!_0x3e02f0||!await bcrypt['compare'](_0x32a274,_0x3e02f0?.[_0x4bb85d(0xdc)])){_0x4a5414[_0x4bb85d(0xfc)](0x191)[_0x4bb85d(0xc6)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x400db7;try{_0x400db7=jwt[_0x4bb85d(0xca)]({'userId':_0x3e02f0['id'],'email':_0x3e02f0[_0x4bb85d(0xe4)]},config[_0x4bb85d(0xfd)],{'expiresIn':_0x4bb85d(0xd1)});}catch(_0x2f8608){console[_0x4bb85d(0xe8)](_0x2f8608),_0x4a5414['status'](0x1f4)[_0x4bb85d(0xc6)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x4a5414['status'](0xc8)[_0x4bb85d(0xc6)]({'success':!![],'data':{'userId':_0x3e02f0['id'],'username':_0x3e02f0[_0x4bb85d(0xee)],'first_name':_0x3e02f0[_0x4bb85d(0xfb)],'last_name':_0x3e02f0[_0x4bb85d(0xff)],'email':_0x3e02f0[_0x4bb85d(0xe4)],'avatar_url':_0x3e02f0['avatar_url'],'id':_0x3e02f0['id'],'role':_0x3e02f0[_0x4bb85d(0x106)],'token':_0x400db7}});}),router[a1_0x567659(0xf5)](a1_0x567659(0xcf),async(_0x3d67ed,_0x4a20aa,_0x10bfc1)=>{const _0x3e7d6f=a1_0x567659,{username:_0x12eda5,email:_0x49fae9,password:_0x45667a}=_0x3d67ed[_0x3e7d6f(0xf0)],[_0x50ec23]=await conn['promise']()[_0x3e7d6f(0xc7)](_0x3e7d6f(0xbb),[_0x49fae9]);if(_0x50ec23[_0x3e7d6f(0x10d)]>0x0){_0x4a20aa['status'](0x1a6)[_0x3e7d6f(0xc6)]({'error':_0x3e7d6f(0x100)});return;}const _0x12fa52=await bcrypt[_0x3e7d6f(0x10a)](_0x45667a,0xa);let _0x27b400=null,_0x27afb0=0x1;config[_0x3e7d6f(0xf6)]&&(_0x27b400=randomUUID(),_0x27afb0=0x0);let _0x39ee5a;try{const _0x5b845a=randomUUID(),_0x25b1e2=_0x3e7d6f(0xcc)+_0x5b845a;fs[_0x3e7d6f(0xdf)](_0x25b1e2);const [_0x3336ff]=await conn[_0x3e7d6f(0xd8)]()[_0x3e7d6f(0xc7)](_0x3e7d6f(0xec),[_0x12eda5,_0x49fae9,_0x12fa52,_0x3e7d6f(0xe2),_0x27afb0,_0x27b400,_0x5b845a]);if(_0x3336ff[_0x3e7d6f(0xd3)]){const [_0x59fd2b]=await conn[_0x3e7d6f(0xd8)]()[_0x3e7d6f(0xc7)](_0x3e7d6f(0xf9),[_0x3336ff['insertId']]);_0x59fd2b[_0x3e7d6f(0x10d)]>0x0&&(_0x39ee5a=_0x59fd2b[0x0]);}}catch{_0x4a20aa[_0x3e7d6f(0xfc)](0x1f4)[_0x3e7d6f(0xc6)]({'error':_0x3e7d6f(0x108)});return;}let _0x42d4db;try{_0x42d4db=jwt[_0x3e7d6f(0xca)]({'userId':_0x39ee5a['id'],'email':_0x39ee5a[_0x3e7d6f(0xe4)]},config[_0x3e7d6f(0xfd)],{'expiresIn':_0x3e7d6f(0xd1)});}catch(_0x22cfee){_0x4a20aa[_0x3e7d6f(0xfc)](0x1f4)[_0x3e7d6f(0xc6)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}const _0x2d1c7c=require(_0x3e7d6f(0xbe))['transporter'];let _0x2450f4=_0x3e7d6f(0xea);if(config[_0x3e7d6f(0xf6)]){const _0x2b1bf7=config[_0x3e7d6f(0xda)]+_0x3e7d6f(0xd9)+_0x27b400;_0x2450f4='\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22'+_0x2b1bf7+_0x3e7d6f(0xcd)+_0x2b1bf7+_0x3e7d6f(0xfe);const _0x456896={'from':config[_0x3e7d6f(0xc2)],'to':_0x39ee5a[_0x3e7d6f(0xe4)],'subject':_0x3e7d6f(0xd5),'text':_0x3e7d6f(0xd5),'html':_0x2450f4};try{await _0x2d1c7c[_0x3e7d6f(0xc4)](_0x456896);}catch(_0x5562f3){console[_0x3e7d6f(0xe8)](_0x3e7d6f(0xd7)),console[_0x3e7d6f(0xe8)](_0x5562f3),_0x4a20aa[_0x3e7d6f(0xfc)](0x1f4)['json']({'error':_0x3e7d6f(0x103),'stack':_0x5562f3[_0x3e7d6f(0xdd)],'message':_0x5562f3['message']});return;}_0x4a20aa[_0x3e7d6f(0xfc)](0xc8)['json']({'success':!![],'message':'Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account'});return;}_0x4a20aa['status'](0xc9)['json']({'success':!![],'data':{'userId':_0x39ee5a['id'],'username':_0x39ee5a[_0x3e7d6f(0xee)],'first_name':_0x39ee5a[_0x3e7d6f(0xfb)],'last_name':_0x39ee5a[_0x3e7d6f(0xff)],'email':_0x39ee5a[_0x3e7d6f(0xe4)],'avatar_url':_0x39ee5a[_0x3e7d6f(0xd4)],'id':_0x39ee5a['id'],'role':_0x39ee5a[_0x3e7d6f(0x106)],'token':_0x42d4db,'is_enabled':_0x39ee5a[_0x3e7d6f(0x10c)]}});}),router[a1_0x567659(0xf5)]('/validate-email/:token',async(_0x40bb1d,_0x3ce7d5)=>{const _0x19591e=a1_0x567659;try{const {token:_0x47160d}=_0x40bb1d[_0x19591e(0xd6)],[_0x242440]=await conn[_0x19591e(0xd8)]()['execute'](_0x19591e(0xed),[_0x47160d]);if(_0x242440[_0x19591e(0x10d)]===0x0){_0x3ce7d5[_0x19591e(0xfc)](0x194)[_0x19591e(0xc6)]({'error':_0x19591e(0xe3)});return;}await conn[_0x19591e(0xd8)]()[_0x19591e(0xc7)](_0x19591e(0xf3),[_0x47160d]);const _0x364ceb=jwt[_0x19591e(0xca)]({'id':_0x242440[0x0]['id'],'email':_0x242440[0x0]['email']},config[_0x19591e(0xfd)],{'expiresIn':_0x19591e(0xd1)});_0x3ce7d5[_0x19591e(0xfc)](0xc8)[_0x19591e(0xc6)]({'success':!![],'message':_0x19591e(0x10b),'data':{'userId':_0x242440[0x0]['id'],'username':_0x242440[0x0][_0x19591e(0xee)],'first_name':_0x242440[0x0][_0x19591e(0xfb)],'last_name':_0x242440[0x0][_0x19591e(0xff)],'email':_0x242440[0x0][_0x19591e(0xe4)],'avatar_url':_0x242440[0x0][_0x19591e(0xd4)],'id':_0x242440[0x0]['id'],'role':_0x242440[0x0][_0x19591e(0x106)],'token':_0x364ceb,'is_enabled':0x1}});}catch(_0x354312){console['log'](_0x19591e(0xd7)),console[_0x19591e(0xe8)](_0x354312),_0x3ce7d5[_0x19591e(0xfc)](0x1f4)[_0x19591e(0xc6)]({'error':_0x19591e(0x108),'stack':_0x354312[_0x19591e(0xdd)],'message':_0x354312[_0x19591e(0xbd)]});}}),router['post'](a1_0x567659(0xe0),verifyToken,async(_0x3e8278,_0x51ad1e,_0x2a9112)=>{const _0x506531=a1_0x567659,{current_password:_0x2fdf37,new_password:_0x1d350e}=_0x3e8278[_0x506531(0xf0)];console[_0x506531(0xe8)]({'body':_0x3e8278[_0x506531(0xf0)]});const _0x4f7c35=_0x3e8278['user'][_0x506531(0xe4)];let _0xc621a1;try{const [_0x119a52]=await conn[_0x506531(0xd8)]()[_0x506531(0xc7)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x4f7c35]);if(_0x119a52[_0x506531(0x10d)]>0x0){_0xc621a1=_0x119a52[0x0];if(!await bcrypt['compare'](_0x2fdf37,_0xc621a1[_0x506531(0xdc)])){_0x51ad1e[_0x506531(0xfc)](0x191)['json']({'error':_0x506531(0xcb)});return;}const _0x5f3757=await bcrypt[_0x506531(0x10a)](_0x1d350e,0xa);await conn['promise']()[_0x506531(0xc7)](_0x506531(0xc3),[_0x5f3757,_0x4f7c35]),_0x51ad1e[_0x506531(0xfc)](0xc8)[_0x506531(0xc6)]({'success':!![]});}}catch(_0x36c788){console[_0x506531(0xe8)]({'err':_0x36c788}),_0x51ad1e[_0x506531(0xfc)](0x1f4)[_0x506531(0xc6)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router['post'](a1_0x567659(0xf8),upload['single'](a1_0x567659(0xe6)),verifyToken,async(_0x14e320,_0x46696b,_0x4e0baf)=>{const _0x51ffa3=a1_0x567659,{username:_0x56d42c,first_name:_0xa936a5,last_name:_0x23c85c}=_0x14e320['body'],_0x535405=_0x14e320[_0x51ffa3(0xe9)][_0x51ffa3(0xe4)];let _0x36c548;try{const [_0x9dd077]=await conn[_0x51ffa3(0xd8)]()[_0x51ffa3(0xc7)](_0x51ffa3(0xbb),[_0x535405]);_0x9dd077['length']>0x0&&(_0x36c548=_0x9dd077[0x0]);}catch(_0x561174){console['log']({'err':_0x561174}),_0x46696b[_0x51ffa3(0xfc)](0x1f4)[_0x51ffa3(0xc6)]({'error':_0x51ffa3(0x108)});return;}if(!_0x36c548){_0x46696b['status'](0x191)[_0x51ffa3(0xc6)]({'error':_0x51ffa3(0xc5)});return;}console[_0x51ffa3(0xe8)]({'req':_0x14e320['body']});let _0x2c440f=_0x36c548[_0x51ffa3(0xd4)];if(_0x14e320[_0x51ffa3(0xd0)]){const _0x4fefad='avatars/'+randomUUID()+'.png';fs[_0x51ffa3(0xbc)](_0x14e320['file']['path'],'./'+_0x4fefad),_0x2c440f=config['ServerUrl']+'/'+_0x4fefad;}try{await conn['promise']()[_0x51ffa3(0xc7)](_0x51ffa3(0xbf),[_0x56d42c,_0xa936a5,_0x23c85c,_0x2c440f,_0x535405]);let _0x4547f4;try{_0x4547f4=jwt[_0x51ffa3(0xca)]({'userId':_0x36c548['id'],'email':_0x36c548[_0x51ffa3(0xe4)]},config[_0x51ffa3(0xfd)],{'expiresIn':_0x51ffa3(0xd1)});}catch(_0x3a0e75){console[_0x51ffa3(0xe8)](_0x3a0e75),_0x46696b[_0x51ffa3(0xfc)](0x1f4)[_0x51ffa3(0xc6)]({'error':_0x51ffa3(0x108)});return;}_0x46696b[_0x51ffa3(0xfc)](0xc8)[_0x51ffa3(0xc6)]({'success':!![],'data':{'userId':_0x36c548['id'],'username':_0x56d42c,'first_name':_0xa936a5,'last_name':_0x23c85c,'email':_0x36c548[_0x51ffa3(0xe4)],'avatar_url':_0x2c440f,'token':_0x4547f4}});}catch(_0x5ad684){console[_0x51ffa3(0xe8)]({'err':_0x5ad684}),_0x46696b['status'](0x1f4)[_0x51ffa3(0xc6)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),module['exports']=router;