const a1_0x3f1143=a1_0x2e27;(function(_0x437887,_0x422bc3){const _0x3b27d0=a1_0x2e27,_0x2e7900=_0x437887();while(!![]){try{const _0x275360=-parseInt(_0x3b27d0(0x14c))/0x1*(-parseInt(_0x3b27d0(0x123))/0x2)+-parseInt(_0x3b27d0(0x163))/0x3+-parseInt(_0x3b27d0(0x155))/0x4*(parseInt(_0x3b27d0(0x145))/0x5)+-parseInt(_0x3b27d0(0x159))/0x6*(parseInt(_0x3b27d0(0x14f))/0x7)+parseInt(_0x3b27d0(0x171))/0x8*(parseInt(_0x3b27d0(0x178))/0x9)+-parseInt(_0x3b27d0(0x147))/0xa+parseInt(_0x3b27d0(0x15b))/0xb;if(_0x275360===_0x422bc3)break;else _0x2e7900['push'](_0x2e7900['shift']());}catch(_0x2473e5){_0x2e7900['push'](_0x2e7900['shift']());}}}(a1_0x51b2,0xdfc90));const jwt=require('jsonwebtoken'),bcrypt=require(a1_0x3f1143(0x14b)),config=require(a1_0x3f1143(0x11c)),conn=require(a1_0x3f1143(0x13d)),multer=require(a1_0x3f1143(0x129)),fs=require('fs'),verifyToken=require(a1_0x3f1143(0x130))[a1_0x3f1143(0x160)],{sendWelcomeEmail}=require(a1_0x3f1143(0x143)),axios=require(a1_0x3f1143(0x161));function a1_0x2e27(_0x1bcdcb,_0x4f0408){const _0x51b2aa=a1_0x51b2();return a1_0x2e27=function(_0x2e2778,_0x531029){_0x2e2778=_0x2e2778-0x11c;let _0x1c0692=_0x51b2aa[_0x2e2778];return _0x1c0692;},a1_0x2e27(_0x1bcdcb,_0x4f0408);}!fs[a1_0x3f1143(0x136)]('./avatars')&&fs[a1_0x3f1143(0x169)](a1_0x3f1143(0x144));const express=require(a1_0x3f1143(0x16d)),router=express[a1_0x3f1143(0x16b)](),{randomUUID}=require('crypto'),storage=multer['diskStorage']({'destination':function(_0x2a472a,_0xd63f5b,_0x12c58d){const _0x1ceca5=a1_0x3f1143;_0x12c58d(null,_0x1ceca5(0x16a));}}),upload=multer({'storage':storage});function a1_0x51b2(){const _0x4d0041=['UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','city','region','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','mkdirSync','avatars','Router','recaptchaSecretKey','express','sign','log','json','280200BFkWXV','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','username','role','demo_user','/validate-email/:token','Invalid\x20validation\x20token','396cFypER','Error\x20during\x20reCAPTCHA\x20verification.','../CADViewer_config.json','reCAPTCHA\x20verification\x20error:','status','exports','callbackMethod_gatewayUrl_flag','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','compare','2804ncArCi','Error\x20during\x20user\x20creation:','file','post','recaptchaEnabled','time_zone','multer','message','country_name','callbackMethod_gatewayUrl','single','last_name','email','../libs/jwt','length','Error!\x20Something\x20went\x20wrong.','crypted_password','body','Invalid\x20user','existsSync','data','execute','code','jwtSecretKey','first_name','error','../libs/mysql.js','success','/login','user','Error\x20parsing\x20geolocation\x20data:','avatar_url','../libs/email-utils','./avatars','30Jlessg','error-codes','1781650LSFmcj','.png','===================error===================','name','bcrypt','1054bgHDLt','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','insertId','477778XDzYIW','enableEmailVerification','./uploads/','Invalid\x20password','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','promise','1101096HTbczT','hash','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','24YYfqwp','stack','15965576hOfbRY','ServerUrl','24h','https://www.google.com/recaptcha/api/siteverify','unlinkSync','verifyToken','axios','languages','4352325APMEXl','avatars/'];a1_0x51b2=function(){return _0x4d0041;};return a1_0x51b2();}router['post'](a1_0x3f1143(0x13f),async(_0x516258,_0x511ae5,_0x671e1b)=>{const _0x4963b3=a1_0x3f1143;let {email:_0x214b13,password:_0x5b774f}=_0x516258[_0x4963b3(0x134)];console[_0x4963b3(0x16f)]({'email':_0x214b13,'password':_0x5b774f});let _0x358453;try{const [_0x578fa6]=await conn[_0x4963b3(0x154)]()[_0x4963b3(0x138)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x214b13]);_0x578fa6[_0x4963b3(0x131)]>0x0&&(_0x358453=_0x578fa6[0x0]);}catch(_0x5c5219){console[_0x4963b3(0x16f)]({'err':_0x5c5219}),_0x511ae5['status'](0x1f4)[_0x4963b3(0x170)]({'error':_0x4963b3(0x132)});return;}if(!_0x358453||!await bcrypt[_0x4963b3(0x122)](_0x5b774f,_0x358453?.[_0x4963b3(0x133)])){_0x511ae5[_0x4963b3(0x11e)](0x191)[_0x4963b3(0x170)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x2fc293;try{_0x2fc293=jwt[_0x4963b3(0x16e)]({'userId':_0x358453['id'],'email':_0x358453['email']},config['jwtSecretKey'],{'expiresIn':_0x4963b3(0x15d)});}catch(_0x3a6a59){console[_0x4963b3(0x16f)](_0x3a6a59),_0x511ae5[_0x4963b3(0x11e)](0x1f4)['json']({'error':_0x4963b3(0x132)});return;}_0x511ae5[_0x4963b3(0x11e)](0xc8)[_0x4963b3(0x170)]({'success':!![],'data':{'userId':_0x358453['id'],'username':_0x358453[_0x4963b3(0x173)],'first_name':_0x358453[_0x4963b3(0x13b)],'last_name':_0x358453[_0x4963b3(0x12e)],'email':_0x358453[_0x4963b3(0x12f)],'avatar_url':_0x358453[_0x4963b3(0x142)],'id':_0x358453['id'],'role':_0x358453[_0x4963b3(0x174)],'token':_0x2fc293}});}),router[a1_0x3f1143(0x126)]('/signup',async(_0x5e3ef2,_0x1d797d,_0x33b591)=>{const _0x5835f8=a1_0x3f1143,{username:_0x35631b,email:_0x5e970d,password:_0x1c79d8,geolocation:_0x5b6606,recaptchaToken:_0x1610e2}=_0x5e3ef2[_0x5835f8(0x134)];if(config[_0x5835f8(0x127)]){if(!_0x1610e2)return _0x1d797d[_0x5835f8(0x11e)](0x190)['json']({'error':_0x5835f8(0x14d)});try{const _0x585eb7=await axios[_0x5835f8(0x126)](_0x5835f8(0x15e),null,{'params':{'secret':config[_0x5835f8(0x16c)],'response':_0x1610e2}});if(!_0x585eb7[_0x5835f8(0x137)][_0x5835f8(0x13e)])return _0x1d797d[_0x5835f8(0x11e)](0x190)['json']({'error':_0x5835f8(0x14d),'recaptchaErrors':_0x585eb7[_0x5835f8(0x137)][_0x5835f8(0x146)]});}catch(_0x1e91e1){return console[_0x5835f8(0x13c)](_0x5835f8(0x11d),_0x1e91e1),_0x1d797d[_0x5835f8(0x11e)](0x1f4)['json']({'error':_0x5835f8(0x179)});}}const [_0x1f2910]=await conn[_0x5835f8(0x154)]()[_0x5835f8(0x138)](_0x5835f8(0x153),[_0x5e970d]);if(_0x1f2910[_0x5835f8(0x131)]>0x0){_0x1d797d[_0x5835f8(0x11e)](0x1a6)['json']({'error':'User\x20already\x20exists'});return;}const _0x7d28ba=await bcrypt[_0x5835f8(0x156)](_0x1c79d8,0xa);let _0x4fcf6d=null,_0x298766=0x1;config[_0x5835f8(0x150)]&&(_0x4fcf6d=randomUUID(),_0x298766=0x0);let _0xb9b065=null,_0x1369f5=null,_0x40b22f=null,_0x2ae610=null,_0xd33085=null,_0x44ac46=null;if(_0x5b6606)try{const _0x37d27d=_0x5b6606;_0xb9b065=_0x37d27d[_0x5835f8(0x166)]||null,_0x1369f5=_0x37d27d[_0x5835f8(0x167)]||null,_0x40b22f=_0x37d27d[_0x5835f8(0x12b)]||null,_0x37d27d[_0x5835f8(0x162)]&&_0x37d27d[_0x5835f8(0x162)][_0x5835f8(0x131)]>0x0&&(_0x2ae610=_0x37d27d['languages'][0x0][_0x5835f8(0x139)]||null,_0xd33085=_0x37d27d[_0x5835f8(0x162)][0x0][_0x5835f8(0x14a)]||null),_0x37d27d[_0x5835f8(0x128)]&&(_0x44ac46=_0x37d27d[_0x5835f8(0x128)][_0x5835f8(0x14a)]||null);}catch(_0x3e7175){console[_0x5835f8(0x16f)](_0x5835f8(0x141),_0x3e7175);}let _0x4262e4;try{const _0x13e99c=randomUUID(),_0x56d911=_0x5835f8(0x151)+_0x13e99c;fs[_0x5835f8(0x169)](_0x56d911);const [_0x366812]=await conn[_0x5835f8(0x154)]()['execute'](_0x5835f8(0x168),[_0x35631b,_0x5e970d,_0x7d28ba,_0x5835f8(0x175),_0x298766,_0x4fcf6d,_0x13e99c,_0xb9b065,_0x1369f5,_0x40b22f,_0x2ae610,_0xd33085,_0x44ac46]);if(_0x366812[_0x5835f8(0x14e)]){const [_0x4b5eea]=await conn['promise']()[_0x5835f8(0x138)](_0x5835f8(0x172),[_0x366812[_0x5835f8(0x14e)]]);_0x4b5eea[_0x5835f8(0x131)]>0x0&&(_0x4262e4=_0x4b5eea[0x0]);}}catch(_0x3ffb5f){console[_0x5835f8(0x16f)](_0x5835f8(0x124),_0x3ffb5f),_0x1d797d[_0x5835f8(0x11e)](0x1f4)[_0x5835f8(0x170)]({'error':_0x5835f8(0x132)});return;}let _0x2520ea;try{_0x2520ea=jwt[_0x5835f8(0x16e)]({'userId':_0x4262e4['id'],'email':_0x4262e4[_0x5835f8(0x12f)]},config['jwtSecretKey'],{'expiresIn':_0x5835f8(0x15d)});}catch(_0x54e19f){_0x1d797d[_0x5835f8(0x11e)](0x1f4)[_0x5835f8(0x170)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(config[_0x5835f8(0x150)]){try{await sendWelcomeEmail(_0x4262e4,_0x4fcf6d);}catch(_0x563e84){console[_0x5835f8(0x16f)]('===================error==================='),console[_0x5835f8(0x16f)](_0x563e84);}_0x1d797d[_0x5835f8(0x11e)](0xc8)['json']({'success':!![],'message':_0x5835f8(0x157)});return;}_0x1d797d[_0x5835f8(0x11e)](0xc9)[_0x5835f8(0x170)]({'success':!![],'data':{'userId':_0x4262e4['id'],'username':_0x4262e4['username'],'first_name':_0x4262e4[_0x5835f8(0x13b)],'last_name':_0x4262e4[_0x5835f8(0x12e)],'email':_0x4262e4[_0x5835f8(0x12f)],'avatar_url':_0x4262e4[_0x5835f8(0x142)],'id':_0x4262e4['id'],'role':_0x4262e4[_0x5835f8(0x174)],'token':_0x2520ea,'is_enabled':_0x4262e4['is_enabled']}});}),router[a1_0x3f1143(0x126)](a1_0x3f1143(0x176),async(_0x3f94f3,_0x25cd1a)=>{const _0x376b1f=a1_0x3f1143;try{const {token:_0xc31770}=_0x3f94f3['params'],[_0x4ab266]=await conn['promise']()[_0x376b1f(0x138)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0xc31770]);if(_0x4ab266[_0x376b1f(0x131)]===0x0){_0x25cd1a[_0x376b1f(0x11e)](0x194)[_0x376b1f(0x170)]({'error':_0x376b1f(0x177)});return;}await conn['promise']()['execute'](_0x376b1f(0x158),[_0xc31770]);const _0xb8be20=jwt[_0x376b1f(0x16e)]({'id':_0x4ab266[0x0]['id'],'email':_0x4ab266[0x0][_0x376b1f(0x12f)]},config[_0x376b1f(0x13a)],{'expiresIn':_0x376b1f(0x15d)});_0x25cd1a[_0x376b1f(0x11e)](0xc8)[_0x376b1f(0x170)]({'success':!![],'message':'Email\x20validated\x20successfully','data':{'userId':_0x4ab266[0x0]['id'],'username':_0x4ab266[0x0][_0x376b1f(0x173)],'first_name':_0x4ab266[0x0][_0x376b1f(0x13b)],'last_name':_0x4ab266[0x0]['last_name'],'email':_0x4ab266[0x0][_0x376b1f(0x12f)],'avatar_url':_0x4ab266[0x0][_0x376b1f(0x142)],'id':_0x4ab266[0x0]['id'],'role':_0x4ab266[0x0][_0x376b1f(0x174)],'token':_0xb8be20,'is_enabled':0x1}});}catch(_0x2c4d80){console[_0x376b1f(0x16f)](_0x376b1f(0x149)),console[_0x376b1f(0x16f)](_0x2c4d80),_0x25cd1a[_0x376b1f(0x11e)](0x1f4)[_0x376b1f(0x170)]({'error':'Error!\x20Something\x20went\x20wrong.','stack':_0x2c4d80[_0x376b1f(0x15a)],'message':_0x2c4d80[_0x376b1f(0x12a)]});}}),router[a1_0x3f1143(0x126)]('/update-password',verifyToken,async(_0x346002,_0x5e2eed,_0x5a641e)=>{const _0x59ba1d=a1_0x3f1143,{current_password:_0xe51850,new_password:_0x4271c4}=_0x346002[_0x59ba1d(0x134)];console[_0x59ba1d(0x16f)]({'body':_0x346002[_0x59ba1d(0x134)]});const _0x20e70d=_0x346002[_0x59ba1d(0x140)][_0x59ba1d(0x12f)];let _0x24d9b0;try{const [_0x3005c0]=await conn[_0x59ba1d(0x154)]()[_0x59ba1d(0x138)](_0x59ba1d(0x153),[_0x20e70d]);if(_0x3005c0[_0x59ba1d(0x131)]>0x0){_0x24d9b0=_0x3005c0[0x0];if(!await bcrypt['compare'](_0xe51850,_0x24d9b0['crypted_password'])){_0x5e2eed[_0x59ba1d(0x11e)](0x191)['json']({'error':_0x59ba1d(0x152)});return;}const _0x22bbd4=await bcrypt[_0x59ba1d(0x156)](_0x4271c4,0xa);await conn[_0x59ba1d(0x154)]()[_0x59ba1d(0x138)](_0x59ba1d(0x121),[_0x22bbd4,_0x20e70d]),_0x5e2eed['status'](0xc8)[_0x59ba1d(0x170)]({'success':!![]});}}catch(_0xbfc20a){console[_0x59ba1d(0x16f)]({'err':_0xbfc20a}),_0x5e2eed[_0x59ba1d(0x11e)](0x1f4)[_0x59ba1d(0x170)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x3f1143(0x126)]('/update-user-info',upload[a1_0x3f1143(0x12d)]('avatar'),verifyToken,async(_0x224a9d,_0x1d2924,_0x50d9a5)=>{const _0x43ca3b=a1_0x3f1143,{username:_0x321ff3,first_name:_0x4c98f8,last_name:_0xac6510}=_0x224a9d[_0x43ca3b(0x134)],_0x3a4e38=_0x224a9d[_0x43ca3b(0x140)][_0x43ca3b(0x12f)];let _0x191ebe;try{const [_0x325843]=await conn[_0x43ca3b(0x154)]()['execute'](_0x43ca3b(0x153),[_0x3a4e38]);_0x325843['length']>0x0&&(_0x191ebe=_0x325843[0x0]);}catch(_0x4a4dd0){console[_0x43ca3b(0x16f)]({'err':_0x4a4dd0}),_0x1d2924[_0x43ca3b(0x11e)](0x1f4)[_0x43ca3b(0x170)]({'error':_0x43ca3b(0x132)});return;}if(!_0x191ebe){_0x1d2924[_0x43ca3b(0x11e)](0x191)['json']({'error':_0x43ca3b(0x135)});return;}console[_0x43ca3b(0x16f)]({'req':_0x224a9d[_0x43ca3b(0x134)]});let _0x349585=_0x191ebe['avatar_url'];if(_0x224a9d[_0x43ca3b(0x125)]){const _0x4ee644=_0x43ca3b(0x164)+randomUUID()+_0x43ca3b(0x148);fs['copyFileSync'](_0x224a9d['file']['path'],'./'+_0x4ee644),fs[_0x43ca3b(0x15f)](_0x224a9d[_0x43ca3b(0x125)]['path']),config[_0x43ca3b(0x120)]?_0x349585=config[_0x43ca3b(0x12c)]+'/'+_0x4ee644:_0x349585=config[_0x43ca3b(0x15c)]+'/'+_0x4ee644;}try{await conn[_0x43ca3b(0x154)]()[_0x43ca3b(0x138)](_0x43ca3b(0x165),[_0x321ff3,_0x4c98f8,_0xac6510,_0x349585,_0x3a4e38]);let _0x3578c6;try{_0x3578c6=jwt[_0x43ca3b(0x16e)]({'userId':_0x191ebe['id'],'email':_0x191ebe[_0x43ca3b(0x12f)]},config[_0x43ca3b(0x13a)],{'expiresIn':'24h'});}catch(_0x4fa17d){console['log'](_0x4fa17d),_0x1d2924[_0x43ca3b(0x11e)](0x1f4)[_0x43ca3b(0x170)]({'error':_0x43ca3b(0x132)});return;}_0x1d2924[_0x43ca3b(0x11e)](0xc8)[_0x43ca3b(0x170)]({'success':!![],'data':{'userId':_0x191ebe['id'],'username':_0x321ff3,'first_name':_0x4c98f8,'last_name':_0xac6510,'email':_0x191ebe[_0x43ca3b(0x12f)],'avatar_url':_0x349585,'token':_0x3578c6}});}catch(_0x409396){console[_0x43ca3b(0x16f)]({'err':_0x409396}),_0x1d2924[_0x43ca3b(0x11e)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),module[a1_0x3f1143(0x11f)]=router;