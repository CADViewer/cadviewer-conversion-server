const a1_0x9da8a0=a1_0x1a43;function a1_0x391b(){const _0xf12e6f=['3297776FlSQfX','city','../libs/email-utils','Router','params','./avatars','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','jsonwebtoken','multer','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','===================error===================','./uploads/','jwtSecretKey','first_name','region','avatar_url','existsSync','stack','json','Error\x20parsing\x20geolocation\x20data:','error-codes','sign','hash','crypted_password','10550VzlGXA','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','/update-user-info','compare','https://www.google.com/recaptcha/api/siteverify','data','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','status','message','body','exports','promise','post','/validate-email/:token','unlinkSync','Invalid\x20validation\x20token','User\x20already\x20exists','21jQNVVl','country_name','../libs/jwt','file','single','../CADViewer_config.json','code','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','reCAPTCHA\x20verification\x20error:','log','511176cLPYOf','success','mkdirSync','time_zone','8997822YhsvKB','user','Error\x20during\x20user\x20creation:','avatars/','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','/login','/signup','Invalid\x20email\x20or\x20password','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','Email\x20validated\x20successfully','.png','insertId','recaptchaEnabled','enableEmailVerification','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','email','bcrypt','username','role','verifyToken','last_name','languages','path','express','4545itBLDl','/update-password','Error\x20during\x20reCAPTCHA\x20verification.','recaptchaSecretKey','5RGiWXM','diskStorage','name','118425ikXRlA','callbackMethod_gatewayUrl_flag','error','42824364nvxeQQ','763984eJuIDO','avatars','24h','Error!\x20Something\x20went\x20wrong.','10SEKpGQ','length','execute','Invalid\x20user'];a1_0x391b=function(){return _0xf12e6f;};return a1_0x391b();}(function(_0x4f59bd,_0x15ee38){const _0x226fdf=a1_0x1a43,_0x442b33=_0x4f59bd();while(!![]){try{const _0x34a68e=-parseInt(_0x226fdf(0x20f))/0x1+-parseInt(_0x226fdf(0x1d8))/0x2*(parseInt(_0x226fdf(0x1d0))/0x3)+-parseInt(_0x226fdf(0x1d4))/0x4+-parseInt(_0x226fdf(0x1cd))/0x5*(parseInt(_0x226fdf(0x213))/0x6)+-parseInt(_0x226fdf(0x205))/0x7*(parseInt(_0x226fdf(0x1dc))/0x8)+parseInt(_0x226fdf(0x22b))/0x9*(parseInt(_0x226fdf(0x1f4))/0xa)+parseInt(_0x226fdf(0x1d3))/0xb;if(_0x34a68e===_0x15ee38)break;else _0x442b33['push'](_0x442b33['shift']());}catch(_0x435c39){_0x442b33['push'](_0x442b33['shift']());}}}(a1_0x391b,0xc0e21));function a1_0x1a43(_0x30924a,_0x3dec5a){const _0x391b45=a1_0x391b();return a1_0x1a43=function(_0x1a4342,_0x489358){_0x1a4342=_0x1a4342-0x1ca;let _0x4bc2b8=_0x391b45[_0x1a4342];return _0x4bc2b8;},a1_0x1a43(_0x30924a,_0x3dec5a);}const jwt=require(a1_0x9da8a0(0x1e3)),bcrypt=require(a1_0x9da8a0(0x223)),config=require(a1_0x9da8a0(0x20a)),conn=require('../libs/mysql.js'),multer=require(a1_0x9da8a0(0x1e4)),fs=require('fs'),verifyToken=require(a1_0x9da8a0(0x207))[a1_0x9da8a0(0x226)],{sendWelcomeEmail}=require(a1_0x9da8a0(0x1de)),axios=require('axios');!fs[a1_0x9da8a0(0x1ec)](a1_0x9da8a0(0x1e1))&&fs['mkdirSync'](a1_0x9da8a0(0x1e1));const express=require(a1_0x9da8a0(0x22a)),router=express[a1_0x9da8a0(0x1df)](),{randomUUID}=require('crypto'),storage=multer[a1_0x9da8a0(0x1ce)]({'destination':function(_0x3e1b5b,_0x150249,_0xac4651){const _0x479b8e=a1_0x9da8a0;_0xac4651(null,_0x479b8e(0x1d5));}}),upload=multer({'storage':storage});router['post'](a1_0x9da8a0(0x218),async(_0x1994da,_0x5c2dca,_0x20460c)=>{const _0x397615=a1_0x9da8a0;let {email:_0x2d0903,password:_0x5f1c13}=_0x1994da['body'];console[_0x397615(0x20e)]({'email':_0x2d0903,'password':_0x5f1c13});let _0x32076a;try{const [_0x530e8f]=await conn[_0x397615(0x1ff)]()[_0x397615(0x1da)](_0x397615(0x1fa),[_0x2d0903]);_0x530e8f[_0x397615(0x1d9)]>0x0&&(_0x32076a=_0x530e8f[0x0]);}catch(_0x58d309){console['log']({'err':_0x58d309}),_0x5c2dca['status'](0x1f4)[_0x397615(0x1ee)]({'error':_0x397615(0x1d7)});return;}if(!_0x32076a||!await bcrypt[_0x397615(0x1f7)](_0x5f1c13,_0x32076a?.[_0x397615(0x1f3)])){_0x5c2dca[_0x397615(0x1fb)](0x191)[_0x397615(0x1ee)]({'error':_0x397615(0x21a)});return;}let _0x2adcc6;try{_0x2adcc6=jwt[_0x397615(0x1f1)]({'userId':_0x32076a['id'],'email':_0x32076a[_0x397615(0x222)]},config[_0x397615(0x1e8)],{'expiresIn':_0x397615(0x1d6)});}catch(_0x55cda3){console[_0x397615(0x20e)](_0x55cda3),_0x5c2dca['status'](0x1f4)[_0x397615(0x1ee)]({'error':_0x397615(0x1d7)});return;}_0x5c2dca[_0x397615(0x1fb)](0xc8)[_0x397615(0x1ee)]({'success':!![],'data':{'userId':_0x32076a['id'],'username':_0x32076a[_0x397615(0x224)],'first_name':_0x32076a[_0x397615(0x1e9)],'last_name':_0x32076a[_0x397615(0x227)],'email':_0x32076a[_0x397615(0x222)],'avatar_url':_0x32076a[_0x397615(0x1eb)],'id':_0x32076a['id'],'role':_0x32076a[_0x397615(0x225)],'token':_0x2adcc6}});}),router[a1_0x9da8a0(0x200)](a1_0x9da8a0(0x219),async(_0x16c34f,_0x5d3bd4,_0x4b4fe4)=>{const _0x8e3785=a1_0x9da8a0,{username:_0x378455,email:_0xbba5fe,password:_0x23c28b,geolocation:_0xb8dbe,recaptchaToken:_0x4da6aa}=_0x16c34f[_0x8e3785(0x1fd)];if(config[_0x8e3785(0x21f)]){if(!_0x4da6aa)return _0x5d3bd4['status'](0x190)['json']({'error':_0x8e3785(0x1f5)});try{const _0x111338=await axios['post'](_0x8e3785(0x1f8),null,{'params':{'secret':config[_0x8e3785(0x1cc)],'response':_0x4da6aa}});if(!_0x111338[_0x8e3785(0x1f9)][_0x8e3785(0x210)])return _0x5d3bd4[_0x8e3785(0x1fb)](0x190)[_0x8e3785(0x1ee)]({'error':_0x8e3785(0x1f5),'recaptchaErrors':_0x111338['data'][_0x8e3785(0x1f0)]});}catch(_0x1906dd){return console[_0x8e3785(0x1d2)](_0x8e3785(0x20d),_0x1906dd),_0x5d3bd4[_0x8e3785(0x1fb)](0x1f4)[_0x8e3785(0x1ee)]({'error':_0x8e3785(0x1cb)});}}const [_0x33d135]=await conn[_0x8e3785(0x1ff)]()['execute'](_0x8e3785(0x1e5),[_0xbba5fe]);if(_0x33d135[_0x8e3785(0x1d9)]>0x0){_0x5d3bd4[_0x8e3785(0x1fb)](0x1a6)[_0x8e3785(0x1ee)]({'error':_0x8e3785(0x204)});return;}const _0x45ae33=await bcrypt[_0x8e3785(0x1f2)](_0x23c28b,0xa);let _0x5e1973=null,_0x337c26=0x1;config[_0x8e3785(0x220)]&&(_0x5e1973=randomUUID(),_0x337c26=0x0);let _0x5c7c9b=null,_0x2c0cfb=null,_0x5316f4=null,_0x95721d=null,_0x8d8579=null,_0x46ecf4=null;if(_0xb8dbe)try{const _0x4e4308=_0xb8dbe;_0x5c7c9b=_0x4e4308[_0x8e3785(0x1dd)]||null,_0x2c0cfb=_0x4e4308[_0x8e3785(0x1ea)]||null,_0x5316f4=_0x4e4308[_0x8e3785(0x206)]||null,_0x4e4308[_0x8e3785(0x228)]&&_0x4e4308[_0x8e3785(0x228)][_0x8e3785(0x1d9)]>0x0&&(_0x95721d=_0x4e4308[_0x8e3785(0x228)][0x0][_0x8e3785(0x20b)]||null,_0x8d8579=_0x4e4308[_0x8e3785(0x228)][0x0][_0x8e3785(0x1cf)]||null),_0x4e4308[_0x8e3785(0x212)]&&(_0x46ecf4=_0x4e4308['time_zone'][_0x8e3785(0x1cf)]||null);}catch(_0x4ffe20){console[_0x8e3785(0x20e)](_0x8e3785(0x1ef),_0x4ffe20);}let _0xcfe393;try{const _0x4908da=randomUUID(),_0x1703e5=_0x8e3785(0x1e7)+_0x4908da;fs[_0x8e3785(0x211)](_0x1703e5);const [_0x5d1a6a]=await conn[_0x8e3785(0x1ff)]()[_0x8e3785(0x1da)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x378455,_0xbba5fe,_0x45ae33,'demo_user',_0x337c26,_0x5e1973,_0x4908da,_0x5c7c9b,_0x2c0cfb,_0x5316f4,_0x95721d,_0x8d8579,_0x46ecf4]);if(_0x5d1a6a[_0x8e3785(0x21e)]){const [_0xf7a80a]=await conn[_0x8e3785(0x1ff)]()[_0x8e3785(0x1da)](_0x8e3785(0x21b),[_0x5d1a6a[_0x8e3785(0x21e)]]);_0xf7a80a[_0x8e3785(0x1d9)]>0x0&&(_0xcfe393=_0xf7a80a[0x0]);}}catch(_0xd66d3e){console['log'](_0x8e3785(0x215),_0xd66d3e),_0x5d3bd4[_0x8e3785(0x1fb)](0x1f4)[_0x8e3785(0x1ee)]({'error':_0x8e3785(0x1d7)});return;}let _0x3e6329;try{_0x3e6329=jwt[_0x8e3785(0x1f1)]({'userId':_0xcfe393['id'],'email':_0xcfe393[_0x8e3785(0x222)]},config[_0x8e3785(0x1e8)],{'expiresIn':_0x8e3785(0x1d6)});}catch(_0x269393){_0x5d3bd4['status'](0x1f4)[_0x8e3785(0x1ee)]({'error':_0x8e3785(0x1d7)});return;}if(config[_0x8e3785(0x220)]){try{await sendWelcomeEmail(_0xcfe393,_0x5e1973);}catch(_0x155116){console[_0x8e3785(0x20e)](_0x8e3785(0x1e6)),console['log'](_0x155116);}_0x5d3bd4[_0x8e3785(0x1fb)](0xc8)[_0x8e3785(0x1ee)]({'success':!![],'message':_0x8e3785(0x221)});return;}_0x5d3bd4[_0x8e3785(0x1fb)](0xc9)[_0x8e3785(0x1ee)]({'success':!![],'data':{'userId':_0xcfe393['id'],'username':_0xcfe393[_0x8e3785(0x224)],'first_name':_0xcfe393[_0x8e3785(0x1e9)],'last_name':_0xcfe393[_0x8e3785(0x227)],'email':_0xcfe393[_0x8e3785(0x222)],'avatar_url':_0xcfe393[_0x8e3785(0x1eb)],'id':_0xcfe393['id'],'role':_0xcfe393[_0x8e3785(0x225)],'token':_0x3e6329,'is_enabled':_0xcfe393['is_enabled']}});}),router[a1_0x9da8a0(0x200)](a1_0x9da8a0(0x201),async(_0x11c6ec,_0xf8d140)=>{const _0x22b99c=a1_0x9da8a0;try{const {token:_0x515930}=_0x11c6ec[_0x22b99c(0x1e0)],[_0x1c00d3]=await conn[_0x22b99c(0x1ff)]()[_0x22b99c(0x1da)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0x515930]);if(_0x1c00d3['length']===0x0){_0xf8d140[_0x22b99c(0x1fb)](0x194)[_0x22b99c(0x1ee)]({'error':_0x22b99c(0x203)});return;}await conn[_0x22b99c(0x1ff)]()[_0x22b99c(0x1da)](_0x22b99c(0x217),[_0x515930]);const _0x1f16ea=jwt[_0x22b99c(0x1f1)]({'id':_0x1c00d3[0x0]['id'],'email':_0x1c00d3[0x0]['email']},config['jwtSecretKey'],{'expiresIn':_0x22b99c(0x1d6)});_0xf8d140['status'](0xc8)[_0x22b99c(0x1ee)]({'success':!![],'message':_0x22b99c(0x21c),'data':{'userId':_0x1c00d3[0x0]['id'],'username':_0x1c00d3[0x0][_0x22b99c(0x224)],'first_name':_0x1c00d3[0x0][_0x22b99c(0x1e9)],'last_name':_0x1c00d3[0x0][_0x22b99c(0x227)],'email':_0x1c00d3[0x0][_0x22b99c(0x222)],'avatar_url':_0x1c00d3[0x0][_0x22b99c(0x1eb)],'id':_0x1c00d3[0x0]['id'],'role':_0x1c00d3[0x0]['role'],'token':_0x1f16ea,'is_enabled':0x1}});}catch(_0x3bf78b){console[_0x22b99c(0x20e)](_0x22b99c(0x1e6)),console[_0x22b99c(0x20e)](_0x3bf78b),_0xf8d140['status'](0x1f4)['json']({'error':_0x22b99c(0x1d7),'stack':_0x3bf78b[_0x22b99c(0x1ed)],'message':_0x3bf78b[_0x22b99c(0x1fc)]});}}),router['post'](a1_0x9da8a0(0x1ca),verifyToken,async(_0x3e1e4e,_0x4b1bb3,_0x40d23e)=>{const _0x2b7fc0=a1_0x9da8a0,{current_password:_0x1b5d8f,new_password:_0x1561c5}=_0x3e1e4e[_0x2b7fc0(0x1fd)];console['log']({'body':_0x3e1e4e[_0x2b7fc0(0x1fd)]});const _0x21d84d=_0x3e1e4e['user'][_0x2b7fc0(0x222)];let _0x2cb89a;try{const [_0x4cc26b]=await conn[_0x2b7fc0(0x1ff)]()['execute'](_0x2b7fc0(0x1e5),[_0x21d84d]);if(_0x4cc26b[_0x2b7fc0(0x1d9)]>0x0){_0x2cb89a=_0x4cc26b[0x0];if(!await bcrypt[_0x2b7fc0(0x1f7)](_0x1b5d8f,_0x2cb89a[_0x2b7fc0(0x1f3)])){_0x4b1bb3[_0x2b7fc0(0x1fb)](0x191)[_0x2b7fc0(0x1ee)]({'error':'Invalid\x20password'});return;}const _0x2f7fa2=await bcrypt[_0x2b7fc0(0x1f2)](_0x1561c5,0xa);await conn[_0x2b7fc0(0x1ff)]()['execute'](_0x2b7fc0(0x1e2),[_0x2f7fa2,_0x21d84d]),_0x4b1bb3[_0x2b7fc0(0x1fb)](0xc8)['json']({'success':!![]});}}catch(_0xca35b4){console[_0x2b7fc0(0x20e)]({'err':_0xca35b4}),_0x4b1bb3[_0x2b7fc0(0x1fb)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x9da8a0(0x200)](a1_0x9da8a0(0x1f6),upload[a1_0x9da8a0(0x209)]('avatar'),verifyToken,async(_0x343ca0,_0x20e1db,_0x189203)=>{const _0x454731=a1_0x9da8a0,{username:_0x1f993e,first_name:_0x2de281,last_name:_0x64ced6}=_0x343ca0[_0x454731(0x1fd)],_0x450eca=_0x343ca0[_0x454731(0x214)][_0x454731(0x222)];let _0x323ef5;try{const [_0x2979e9]=await conn[_0x454731(0x1ff)]()[_0x454731(0x1da)](_0x454731(0x1e5),[_0x450eca]);_0x2979e9[_0x454731(0x1d9)]>0x0&&(_0x323ef5=_0x2979e9[0x0]);}catch(_0x2efcfe){console[_0x454731(0x20e)]({'err':_0x2efcfe}),_0x20e1db['status'](0x1f4)[_0x454731(0x1ee)]({'error':_0x454731(0x1d7)});return;}if(!_0x323ef5){_0x20e1db['status'](0x191)[_0x454731(0x1ee)]({'error':_0x454731(0x1db)});return;}console['log']({'req':_0x343ca0['body']});let _0x360183=_0x323ef5['avatar_url'];if(_0x343ca0[_0x454731(0x208)]){const _0x29f8dc=_0x454731(0x216)+randomUUID()+_0x454731(0x21d);fs['copyFileSync'](_0x343ca0['file'][_0x454731(0x229)],'./'+_0x29f8dc),fs[_0x454731(0x202)](_0x343ca0[_0x454731(0x208)][_0x454731(0x229)]),config[_0x454731(0x1d1)]?_0x360183=config['callbackMethod_gatewayUrl']+'/'+_0x29f8dc:_0x360183=config['ServerUrl']+'/'+_0x29f8dc;}try{await conn[_0x454731(0x1ff)]()[_0x454731(0x1da)](_0x454731(0x20c),[_0x1f993e,_0x2de281,_0x64ced6,_0x360183,_0x450eca]);let _0x7fcc23;try{_0x7fcc23=jwt['sign']({'userId':_0x323ef5['id'],'email':_0x323ef5[_0x454731(0x222)]},config[_0x454731(0x1e8)],{'expiresIn':'24h'});}catch(_0xaa72f3){console['log'](_0xaa72f3),_0x20e1db['status'](0x1f4)[_0x454731(0x1ee)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x20e1db[_0x454731(0x1fb)](0xc8)['json']({'success':!![],'data':{'userId':_0x323ef5['id'],'username':_0x1f993e,'first_name':_0x2de281,'last_name':_0x64ced6,'email':_0x323ef5[_0x454731(0x222)],'avatar_url':_0x360183,'token':_0x7fcc23}});}catch(_0x57a727){console['log']({'err':_0x57a727}),_0x20e1db[_0x454731(0x1fb)](0x1f4)[_0x454731(0x1ee)]({'error':_0x454731(0x1d7)});return;}}),module[a1_0x9da8a0(0x1fe)]=router;