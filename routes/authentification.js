const a1_0x201dad=a1_0x37e1;function a1_0x34a0(){const _0x23f8b8=['email','file','.png','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','compare','/update-user-info','multer','username','path','verifyToken','Email\x20validated\x20successfully','first_name','hash','sendMail','avatar_url','execute','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','smtpFrom','./uploads/','24h','transporter','992380udrjlV','message','2442824WmkeEP','role','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','stack','slice','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','single','366714vEGVpw','avatars','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','13139evfgnA','/signup','crypted_password','../libs/mysql.js','endsWith','status','77MvgReY','1FZgrHu','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','Error!\x20Something\x20went\x20wrong.','./avatars','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','post','log','demo_user','Invalid\x20user','frontendUrl','avatars/','===================error===================','../libs/jwt','body','120TElMZV','promise','is_enabled','Invalid\x20validation\x20token','length','express','jwtSecretKey','558837fbcTAf','Invalid\x20email\x20or\x20password','Invalid\x20password','params','json','Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','Welcome\x20to\x20CADViewer','1464uoJLSN','1298370DaIbNF','/validate-email/','enableEmailVerification','user','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','/update-password','sign','User\x20already\x20exists','last_name','1283286OfeUZI','mkdirSync'];a1_0x34a0=function(){return _0x23f8b8;};return a1_0x34a0();}(function(_0xf5dc15,_0x107931){const _0xa745cb=a1_0x37e1,_0x4c9c75=_0xf5dc15();while(!![]){try{const _0x5c7caa=parseInt(_0xa745cb(0x202))/0x1*(parseInt(_0xa745cb(0x228))/0x2)+parseInt(_0xa745cb(0x1f8))/0x3+parseInt(_0xa745cb(0x1f1))/0x4+parseInt(_0xa745cb(0x21f))/0x5+parseInt(_0xa745cb(0x21e))/0x6*(parseInt(_0xa745cb(0x1fb))/0x7)+-parseInt(_0xa745cb(0x210))/0x8*(parseInt(_0xa745cb(0x217))/0x9)+-parseInt(_0xa745cb(0x1ef))/0xa*(parseInt(_0xa745cb(0x201))/0xb);if(_0x5c7caa===_0x107931)break;else _0x4c9c75['push'](_0x4c9c75['shift']());}catch(_0xe583bc){_0x4c9c75['push'](_0x4c9c75['shift']());}}}(a1_0x34a0,0x71d0c));function a1_0x37e1(_0xfa5ce1,_0x225e63){const _0x34a0ad=a1_0x34a0();return a1_0x37e1=function(_0x37e15d,_0x40af16){_0x37e15d=_0x37e15d-0x1dd;let _0x45c6ec=_0x34a0ad[_0x37e15d];return _0x45c6ec;},a1_0x37e1(_0xfa5ce1,_0x225e63);}const jwt=require('jsonwebtoken'),bcrypt=require('bcrypt'),config=require('../CADViewer_config.json'),conn=require(a1_0x201dad(0x1fe)),multer=require(a1_0x201dad(0x1e0)),fs=require('fs'),verifyToken=require(a1_0x201dad(0x20e))[a1_0x201dad(0x1e3)];!fs['existsSync'](a1_0x201dad(0x205))&&fs[a1_0x201dad(0x229)](a1_0x201dad(0x205));const express=require(a1_0x201dad(0x215)),router=express['Router'](),{randomUUID}=require('crypto'),storage=multer['diskStorage']({'destination':function(_0x2d2f59,_0x38f1f4,_0x555c5f){const _0x1571c6=a1_0x201dad;_0x555c5f(null,_0x1571c6(0x1f9));}}),upload=multer({'storage':storage});router['post']('/login',async(_0x1eac17,_0x712bed,_0x116ca6)=>{const _0x6613e2=a1_0x201dad;let {email:_0x1b1abd,password:_0x46b23c}=_0x1eac17[_0x6613e2(0x20f)];console[_0x6613e2(0x208)]({'email':_0x1b1abd,'password':_0x46b23c});let _0x4a21ef;try{const [_0x54dba2]=await conn[_0x6613e2(0x211)]()[_0x6613e2(0x1e9)](_0x6613e2(0x1f6),[_0x1b1abd]);_0x54dba2['length']>0x0&&(_0x4a21ef=_0x54dba2[0x0]);}catch(_0x21afde){console[_0x6613e2(0x208)]({'err':_0x21afde}),_0x712bed[_0x6613e2(0x200)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x4a21ef||!await bcrypt[_0x6613e2(0x1de)](_0x46b23c,_0x4a21ef?.[_0x6613e2(0x1fd)])){_0x712bed[_0x6613e2(0x200)](0x191)[_0x6613e2(0x21b)]({'error':_0x6613e2(0x218)});return;}let _0x407eda;try{_0x407eda=jwt[_0x6613e2(0x225)]({'userId':_0x4a21ef['id'],'email':_0x4a21ef[_0x6613e2(0x22a)]},config[_0x6613e2(0x216)],{'expiresIn':_0x6613e2(0x1ed)});}catch(_0x127f01){console[_0x6613e2(0x208)](_0x127f01),_0x712bed['status'](0x1f4)[_0x6613e2(0x21b)]({'error':_0x6613e2(0x204)});return;}_0x712bed[_0x6613e2(0x200)](0xc8)[_0x6613e2(0x21b)]({'success':!![],'data':{'userId':_0x4a21ef['id'],'username':_0x4a21ef[_0x6613e2(0x1e1)],'first_name':_0x4a21ef['first_name'],'last_name':_0x4a21ef[_0x6613e2(0x227)],'email':_0x4a21ef[_0x6613e2(0x22a)],'avatar_url':_0x4a21ef['avatar_url'],'id':_0x4a21ef['id'],'role':_0x4a21ef[_0x6613e2(0x1f2)],'token':_0x407eda}});}),router[a1_0x201dad(0x207)](a1_0x201dad(0x1fc),async(_0x2b2d16,_0x13beaf,_0x46f312)=>{const _0x54db56=a1_0x201dad,{username:_0x2548a0,email:_0x354397,password:_0x2c0bdf}=_0x2b2d16[_0x54db56(0x20f)],[_0xd24e47]=await conn[_0x54db56(0x211)]()[_0x54db56(0x1e9)](_0x54db56(0x1fa),[_0x354397]);if(_0xd24e47[_0x54db56(0x214)]>0x0){_0x13beaf[_0x54db56(0x200)](0x1a6)[_0x54db56(0x21b)]({'error':_0x54db56(0x226)});return;}const _0x41c696=await bcrypt[_0x54db56(0x1e6)](_0x2c0bdf,0xa);let _0x9bd704=null,_0x42bd9e=0x1;config[_0x54db56(0x221)]&&(_0x9bd704=randomUUID(),_0x42bd9e=0x0);let _0x148aee;try{const _0x55f5ad=randomUUID(),_0x10a654=_0x54db56(0x1ec)+_0x55f5ad;fs['mkdirSync'](_0x10a654);const [_0x1e5c4d]=await conn[_0x54db56(0x211)]()[_0x54db56(0x1e9)](_0x54db56(0x1f3),[_0x2548a0,_0x354397,_0x41c696,_0x54db56(0x209),_0x42bd9e,_0x9bd704,_0x55f5ad]);if(_0x1e5c4d['insertId']){const [_0x25e938]=await conn['promise']()[_0x54db56(0x1e9)](_0x54db56(0x1ea),[_0x1e5c4d['insertId']]);_0x25e938[_0x54db56(0x214)]>0x0&&(_0x148aee=_0x25e938[0x0]);}}catch{_0x13beaf[_0x54db56(0x200)](0x1f4)[_0x54db56(0x21b)]({'error':_0x54db56(0x204)});return;}let _0x4fefe3;try{_0x4fefe3=jwt[_0x54db56(0x225)]({'userId':_0x148aee['id'],'email':_0x148aee['email']},config[_0x54db56(0x216)],{'expiresIn':'24h'});}catch(_0x3a301a){_0x13beaf['status'](0x1f4)[_0x54db56(0x21b)]({'error':_0x54db56(0x204)});return;}const _0x4698ea=require('../libs/mail')[_0x54db56(0x1ee)];let _0x4d7040='<p>Welcome\x20to\x20CADViewer</p>';if(config[_0x54db56(0x221)]){var _0xfdb5bb=config[_0x54db56(0x20b)];_0xfdb5bb[_0x54db56(0x1ff)]('/')&&(_0xfdb5bb=_0xfdb5bb[_0x54db56(0x1f5)](0x0,-0x1));const _0x477943=_0xfdb5bb+_0x54db56(0x220)+_0x9bd704;_0x4d7040='\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22'+_0x477943+'\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>'+_0x477943+_0x54db56(0x203);const _0x9bb41={'from':config[_0x54db56(0x1eb)],'to':_0x148aee[_0x54db56(0x22a)],'subject':_0x54db56(0x21d),'text':'Welcome\x20to\x20CADViewer','html':_0x4d7040};try{await _0x4698ea[_0x54db56(0x1e7)](_0x9bb41);}catch(_0x3b26c5){console[_0x54db56(0x208)](_0x54db56(0x20d)),console[_0x54db56(0x208)](_0x3b26c5),_0x13beaf['status'](0x1f4)[_0x54db56(0x21b)]({'error':_0x54db56(0x21c),'stack':_0x3b26c5[_0x54db56(0x1f4)],'message':_0x3b26c5[_0x54db56(0x1f0)]});return;}_0x13beaf[_0x54db56(0x200)](0xc8)[_0x54db56(0x21b)]({'success':!![],'message':_0x54db56(0x223)});return;}_0x13beaf[_0x54db56(0x200)](0xc9)[_0x54db56(0x21b)]({'success':!![],'data':{'userId':_0x148aee['id'],'username':_0x148aee[_0x54db56(0x1e1)],'first_name':_0x148aee[_0x54db56(0x1e5)],'last_name':_0x148aee[_0x54db56(0x227)],'email':_0x148aee[_0x54db56(0x22a)],'avatar_url':_0x148aee['avatar_url'],'id':_0x148aee['id'],'role':_0x148aee['role'],'token':_0x4fefe3,'is_enabled':_0x148aee[_0x54db56(0x212)]}});}),router[a1_0x201dad(0x207)]('/validate-email/:token',async(_0x50d842,_0x3d811f)=>{const _0x548acb=a1_0x201dad;try{const {token:_0x292391}=_0x50d842[_0x548acb(0x21a)],[_0x574451]=await conn['promise']()[_0x548acb(0x1e9)](_0x548acb(0x206),[_0x292391]);if(_0x574451[_0x548acb(0x214)]===0x0){_0x3d811f['status'](0x194)[_0x548acb(0x21b)]({'error':_0x548acb(0x213)});return;}await conn['promise']()[_0x548acb(0x1e9)]('UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?',[_0x292391]);const _0x4f888f=jwt['sign']({'id':_0x574451[0x0]['id'],'email':_0x574451[0x0][_0x548acb(0x22a)]},config[_0x548acb(0x216)],{'expiresIn':'24h'});_0x3d811f[_0x548acb(0x200)](0xc8)[_0x548acb(0x21b)]({'success':!![],'message':_0x548acb(0x1e4),'data':{'userId':_0x574451[0x0]['id'],'username':_0x574451[0x0][_0x548acb(0x1e1)],'first_name':_0x574451[0x0]['first_name'],'last_name':_0x574451[0x0][_0x548acb(0x227)],'email':_0x574451[0x0][_0x548acb(0x22a)],'avatar_url':_0x574451[0x0][_0x548acb(0x1e8)],'id':_0x574451[0x0]['id'],'role':_0x574451[0x0][_0x548acb(0x1f2)],'token':_0x4f888f,'is_enabled':0x1}});}catch(_0x5bc1b6){console[_0x548acb(0x208)](_0x548acb(0x20d)),console[_0x548acb(0x208)](_0x5bc1b6),_0x3d811f[_0x548acb(0x200)](0x1f4)[_0x548acb(0x21b)]({'error':'Error!\x20Something\x20went\x20wrong.','stack':_0x5bc1b6[_0x548acb(0x1f4)],'message':_0x5bc1b6[_0x548acb(0x1f0)]});}}),router[a1_0x201dad(0x207)](a1_0x201dad(0x224),verifyToken,async(_0x48e23f,_0x5262e9,_0x2dbcda)=>{const _0x43b8ab=a1_0x201dad,{current_password:_0x471942,new_password:_0x1980da}=_0x48e23f['body'];console[_0x43b8ab(0x208)]({'body':_0x48e23f[_0x43b8ab(0x20f)]});const _0x15856d=_0x48e23f[_0x43b8ab(0x222)][_0x43b8ab(0x22a)];let _0x555272;try{const [_0xca399b]=await conn[_0x43b8ab(0x211)]()['execute'](_0x43b8ab(0x1fa),[_0x15856d]);if(_0xca399b[_0x43b8ab(0x214)]>0x0){_0x555272=_0xca399b[0x0];if(!await bcrypt[_0x43b8ab(0x1de)](_0x471942,_0x555272[_0x43b8ab(0x1fd)])){_0x5262e9[_0x43b8ab(0x200)](0x191)['json']({'error':_0x43b8ab(0x219)});return;}const _0x27e071=await bcrypt[_0x43b8ab(0x1e6)](_0x1980da,0xa);await conn['promise']()['execute']('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x27e071,_0x15856d]),_0x5262e9[_0x43b8ab(0x200)](0xc8)['json']({'success':!![]});}}catch(_0x1955c8){console[_0x43b8ab(0x208)]({'err':_0x1955c8}),_0x5262e9[_0x43b8ab(0x200)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x201dad(0x207)](a1_0x201dad(0x1df),upload[a1_0x201dad(0x1f7)]('avatar'),verifyToken,async(_0x3a17f9,_0x481cb6,_0x5de2e8)=>{const _0x335dba=a1_0x201dad,{username:_0x56fc97,first_name:_0x50fdce,last_name:_0x2714c2}=_0x3a17f9['body'],_0x235ec3=_0x3a17f9[_0x335dba(0x222)][_0x335dba(0x22a)];let _0x51e154;try{const [_0x562ea5]=await conn[_0x335dba(0x211)]()[_0x335dba(0x1e9)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x235ec3]);_0x562ea5['length']>0x0&&(_0x51e154=_0x562ea5[0x0]);}catch(_0x4fca1f){console[_0x335dba(0x208)]({'err':_0x4fca1f}),_0x481cb6[_0x335dba(0x200)](0x1f4)[_0x335dba(0x21b)]({'error':_0x335dba(0x204)});return;}if(!_0x51e154){_0x481cb6[_0x335dba(0x200)](0x191)[_0x335dba(0x21b)]({'error':_0x335dba(0x20a)});return;}console[_0x335dba(0x208)]({'req':_0x3a17f9[_0x335dba(0x20f)]});let _0x38d24a=_0x51e154['avatar_url'];if(_0x3a17f9[_0x335dba(0x22b)]){const _0x4d03d6=_0x335dba(0x20c)+randomUUID()+_0x335dba(0x22c);fs['copyFileSync'](_0x3a17f9[_0x335dba(0x22b)][_0x335dba(0x1e2)],'./'+_0x4d03d6),fs['unlinkSync'](_0x3a17f9['file'][_0x335dba(0x1e2)]),_0x38d24a=config['ServerUrl']+'/'+_0x4d03d6;}try{await conn[_0x335dba(0x211)]()[_0x335dba(0x1e9)](_0x335dba(0x1dd),[_0x56fc97,_0x50fdce,_0x2714c2,_0x38d24a,_0x235ec3]);let _0x4df82;try{_0x4df82=jwt[_0x335dba(0x225)]({'userId':_0x51e154['id'],'email':_0x51e154[_0x335dba(0x22a)]},config[_0x335dba(0x216)],{'expiresIn':_0x335dba(0x1ed)});}catch(_0x816147){console[_0x335dba(0x208)](_0x816147),_0x481cb6[_0x335dba(0x200)](0x1f4)[_0x335dba(0x21b)]({'error':_0x335dba(0x204)});return;}_0x481cb6[_0x335dba(0x200)](0xc8)['json']({'success':!![],'data':{'userId':_0x51e154['id'],'username':_0x56fc97,'first_name':_0x50fdce,'last_name':_0x2714c2,'email':_0x51e154[_0x335dba(0x22a)],'avatar_url':_0x38d24a,'token':_0x4df82}});}catch(_0x17e468){console[_0x335dba(0x208)]({'err':_0x17e468}),_0x481cb6[_0x335dba(0x200)](0x1f4)[_0x335dba(0x21b)]({'error':_0x335dba(0x204)});return;}}),module['exports']=router;