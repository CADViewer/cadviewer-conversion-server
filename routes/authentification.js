const a1_0x40794d=a1_0x5ae5;(function(_0x43f035,_0x49462c){const _0x3c31a8=a1_0x5ae5,_0x31ef9c=_0x43f035();while(!![]){try{const _0x487b45=-parseInt(_0x3c31a8(0x134))/0x1+-parseInt(_0x3c31a8(0x159))/0x2*(parseInt(_0x3c31a8(0x15f))/0x3)+parseInt(_0x3c31a8(0x150))/0x4+-parseInt(_0x3c31a8(0x140))/0x5*(-parseInt(_0x3c31a8(0x168))/0x6)+-parseInt(_0x3c31a8(0x139))/0x7*(-parseInt(_0x3c31a8(0x13d))/0x8)+-parseInt(_0x3c31a8(0x166))/0x9+parseInt(_0x3c31a8(0x158))/0xa;if(_0x487b45===_0x49462c)break;else _0x31ef9c['push'](_0x31ef9c['shift']());}catch(_0x392b34){_0x31ef9c['push'](_0x31ef9c['shift']());}}}(a1_0x1fcd,0x72d92));const jwt=require(a1_0x40794d(0x138)),bcrypt=require(a1_0x40794d(0x14c)),config=require(a1_0x40794d(0x14f)),conn=require(a1_0x40794d(0x14e)),multer=require(a1_0x40794d(0x16b)),fs=require('fs'),verifyToken=require(a1_0x40794d(0x13e))[a1_0x40794d(0x142)];!fs[a1_0x40794d(0x146)](a1_0x40794d(0x136))&&fs['mkdirSync'](a1_0x40794d(0x136));function a1_0x5ae5(_0x419c24,_0x42e3d8){const _0x1fcd4d=a1_0x1fcd();return a1_0x5ae5=function(_0x5ae582,_0x1efb13){_0x5ae582=_0x5ae582-0x133;let _0x16666b=_0x1fcd4d[_0x5ae582];return _0x16666b;},a1_0x5ae5(_0x419c24,_0x42e3d8);}function a1_0x1fcd(){const _0x25dd13=['avatars','avatars/','crypto','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','bcrypt','User\x20already\x20exists','../libs/mysql.js','../CADViewer_config.json','1242340TrQpqo','hash','log','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','last_name','renameSync','email','first_name','10171180TAvxEm','6UvCVrP','crypted_password','path','Invalid\x20user','file','body','42126ARnAXu','Invalid\x20password','length','/login','diskStorage','Invalid\x20email\x20or\x20password','execute','6099282MfmtOa','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x201)','6kwMYHV','role','post','multer','insertId','user','json','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','promise','769833yCFVpo','username','./avatars','status','jsonwebtoken','77YLvwZT','single','/update-user-info','avatar_url','373528hPPqxC','../libs/jwt','sign','593855SAiSXA','Error!\x20Something\x20went\x20wrong.','verifyToken','24h','jwtSecretKey','.png','existsSync'];a1_0x1fcd=function(){return _0x25dd13;};return a1_0x1fcd();}const express=require('express'),router=express['Router'](),{randomUUID}=require(a1_0x40794d(0x149)),storage=multer[a1_0x40794d(0x163)]({'destination':function(_0x38543a,_0x81439c,_0x2c8ed4){const _0x1ef788=a1_0x40794d;_0x2c8ed4(null,_0x1ef788(0x147));}}),upload=multer({'storage':storage});router[a1_0x40794d(0x16a)](a1_0x40794d(0x162),async(_0x551585,_0x28dc6b,_0x59dbe4)=>{const _0x1df6c5=a1_0x40794d;let {email:_0x1ce40a,password:_0x578a43}=_0x551585[_0x1df6c5(0x15e)];console['log']({'email':_0x1ce40a,'password':_0x578a43});let _0xc725ef;try{const [_0x232f71]=await conn[_0x1df6c5(0x133)]()[_0x1df6c5(0x165)](_0x1df6c5(0x16f),[_0x1ce40a]);_0x232f71[_0x1df6c5(0x161)]>0x0&&(_0xc725ef=_0x232f71[0x0]);}catch(_0x1d3d62){console[_0x1df6c5(0x152)]({'err':_0x1d3d62}),_0x28dc6b['status'](0x1f4)['json']({'error':_0x1df6c5(0x141)});return;}console['log'](_0xc725ef),console[_0x1df6c5(0x152)](_0x578a43),console[_0x1df6c5(0x152)](_0xc725ef['crypted_password']);if(!_0xc725ef||!await bcrypt['compare'](_0x578a43,_0xc725ef['crypted_password'])){_0x28dc6b[_0x1df6c5(0x137)](0x191)[_0x1df6c5(0x16e)]({'error':_0x1df6c5(0x164)});return;}let _0x56582b;try{_0x56582b=jwt[_0x1df6c5(0x13f)]({'userId':_0xc725ef['id'],'email':_0xc725ef['email']},config[_0x1df6c5(0x144)],{'expiresIn':_0x1df6c5(0x143)});}catch(_0x1167b5){console[_0x1df6c5(0x152)](_0x1167b5),_0x28dc6b[_0x1df6c5(0x137)](0x1f4)[_0x1df6c5(0x16e)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x28dc6b[_0x1df6c5(0x137)](0xc8)['json']({'success':!![],'data':{'userId':_0xc725ef['id'],'username':_0xc725ef['username'],'first_name':_0xc725ef[_0x1df6c5(0x157)],'last_name':_0xc725ef[_0x1df6c5(0x154)],'email':_0xc725ef[_0x1df6c5(0x156)],'avatar_url':_0xc725ef[_0x1df6c5(0x13c)],'id':_0xc725ef['id'],'role':_0xc725ef['role'],'token':_0x56582b}});}),router[a1_0x40794d(0x16a)]('/signup',async(_0x2295fd,_0x14c776,_0x8bc310)=>{const _0x3b4e30=a1_0x40794d,{username:_0x59d759,email:_0x4f55cc,password:_0x28da06}=_0x2295fd[_0x3b4e30(0x15e)],[_0x2246c7]=await conn[_0x3b4e30(0x133)]()['execute'](_0x3b4e30(0x14a),[_0x4f55cc]);if(_0x2246c7[_0x3b4e30(0x161)]>0x0){_0x14c776[_0x3b4e30(0x137)](0x1a6)[_0x3b4e30(0x16e)]({'error':_0x3b4e30(0x14d)});return;}const _0x12172b=await bcrypt[_0x3b4e30(0x151)](_0x28da06,0xa);try{const [_0x1b489e]=await conn[_0x3b4e30(0x133)]()[_0x3b4e30(0x165)](_0x3b4e30(0x167),[_0x59d759,_0x4f55cc,_0x12172b,_0x3b4e30(0x16d)]);if(_0x1b489e[_0x3b4e30(0x16c)]){const [_0x9ea7a5]=await conn[_0x3b4e30(0x133)]()[_0x3b4e30(0x165)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x1b489e[_0x3b4e30(0x16c)]]);_0x9ea7a5[_0x3b4e30(0x161)]>0x0&&(newUser=_0x9ea7a5[0x0]);}}catch{_0x14c776[_0x3b4e30(0x137)](0x1f4)[_0x3b4e30(0x16e)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}let _0x8a0819;try{_0x8a0819=jwt['sign']({'userId':newUser['id'],'email':newUser['email']},config['jwtSecretKey'],{'expiresIn':_0x3b4e30(0x143)});}catch(_0x44d2fa){_0x14c776[_0x3b4e30(0x137)](0x1f4)[_0x3b4e30(0x16e)]({'error':_0x3b4e30(0x141)});return;}_0x14c776[_0x3b4e30(0x137)](0xc9)[_0x3b4e30(0x16e)]({'success':!![],'data':{'userId':newUser['id'],'username':newUser[_0x3b4e30(0x135)],'first_name':newUser[_0x3b4e30(0x157)],'last_name':newUser[_0x3b4e30(0x154)],'email':newUser[_0x3b4e30(0x156)],'avatar_url':newUser[_0x3b4e30(0x13c)],'id':newUser['id'],'role':newUser[_0x3b4e30(0x169)],'token':_0x8a0819}});}),router[a1_0x40794d(0x16a)]('/update-password',verifyToken,async(_0x10c8c2,_0x2f1e71,_0x299808)=>{const _0x25f10e=a1_0x40794d,{current_password:_0x3a8e7f,new_password:_0x1169ae}=_0x10c8c2[_0x25f10e(0x15e)];console[_0x25f10e(0x152)]({'body':_0x10c8c2['body']});const _0x46bf82=_0x10c8c2[_0x25f10e(0x16d)]['email'];let _0x3327b8;try{const [_0x29b9e9]=await conn['promise']()['execute'](_0x25f10e(0x14a),[_0x46bf82]);if(_0x29b9e9[_0x25f10e(0x161)]>0x0){_0x3327b8=_0x29b9e9[0x0];if(!await bcrypt['compare'](_0x3a8e7f,_0x3327b8[_0x25f10e(0x15a)])){_0x2f1e71[_0x25f10e(0x137)](0x191)['json']({'error':_0x25f10e(0x160)});return;}const _0x2977c9=await bcrypt[_0x25f10e(0x151)](_0x1169ae,0xa);await conn[_0x25f10e(0x133)]()[_0x25f10e(0x165)](_0x25f10e(0x153),[_0x2977c9,_0x46bf82]),_0x2f1e71[_0x25f10e(0x137)](0xc8)[_0x25f10e(0x16e)]({'success':!![]});}}catch(_0x11829d){console[_0x25f10e(0x152)]({'err':_0x11829d}),_0x2f1e71[_0x25f10e(0x137)](0x1f4)[_0x25f10e(0x16e)]({'error':_0x25f10e(0x141)});return;}}),router['post'](a1_0x40794d(0x13b),upload[a1_0x40794d(0x13a)]('avatar'),verifyToken,async(_0xd36591,_0x32c839,_0xf62bfd)=>{const _0x5ae85c=a1_0x40794d,{username:_0x43b590,first_name:_0x5493ab,last_name:_0xa6d24b}=_0xd36591[_0x5ae85c(0x15e)],_0x584cda=_0xd36591['user'][_0x5ae85c(0x156)];let _0x4b7517;try{const [_0x37d9fa]=await conn['promise']()[_0x5ae85c(0x165)](_0x5ae85c(0x14a),[_0x584cda]);_0x37d9fa[_0x5ae85c(0x161)]>0x0&&(_0x4b7517=_0x37d9fa[0x0]);}catch(_0x3ca735){console[_0x5ae85c(0x152)]({'err':_0x3ca735}),_0x32c839[_0x5ae85c(0x137)](0x1f4)[_0x5ae85c(0x16e)]({'error':_0x5ae85c(0x141)});return;}if(!_0x4b7517){_0x32c839[_0x5ae85c(0x137)](0x191)['json']({'error':_0x5ae85c(0x15c)});return;}console[_0x5ae85c(0x152)]({'req':_0xd36591['body']});let _0x22eecf=_0x4b7517['avatar_url'];if(_0xd36591[_0x5ae85c(0x15d)]){const _0x3389e7=_0x5ae85c(0x148)+randomUUID()+_0x5ae85c(0x145);fs[_0x5ae85c(0x155)](_0xd36591['file'][_0x5ae85c(0x15b)],'./'+_0x3389e7),_0x22eecf=config['ServerUrl']+'/'+_0x3389e7;}try{await conn['promise']()[_0x5ae85c(0x165)](_0x5ae85c(0x14b),[_0x43b590,_0x5493ab,_0xa6d24b,_0x22eecf,_0x584cda]);let _0x3394c1;try{_0x3394c1=jwt[_0x5ae85c(0x13f)]({'userId':_0x4b7517['id'],'email':_0x4b7517['email']},config['jwtSecretKey'],{'expiresIn':_0x5ae85c(0x143)});}catch(_0x186d21){console['log'](_0x186d21),_0x32c839[_0x5ae85c(0x137)](0x1f4)[_0x5ae85c(0x16e)]({'error':_0x5ae85c(0x141)});return;}_0x32c839['status'](0xc8)[_0x5ae85c(0x16e)]({'success':!![],'data':{'userId':_0x4b7517['id'],'username':_0x43b590,'first_name':_0x5493ab,'last_name':_0xa6d24b,'email':_0x4b7517[_0x5ae85c(0x156)],'avatar_url':_0x22eecf,'token':_0x3394c1}});}catch(_0x2b7b70){console[_0x5ae85c(0x152)]({'err':_0x2b7b70}),_0x32c839[_0x5ae85c(0x137)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),module['exports']=router;