const a1_0x691a5e=a1_0x109f;(function(_0x531851,_0x526dda){const _0x465a6e=a1_0x109f,_0x3591d0=_0x531851();while(!![]){try{const _0x5645b8=parseInt(_0x465a6e(0xb0))/0x1+parseInt(_0x465a6e(0x7a))/0x2*(parseInt(_0x465a6e(0xa8))/0x3)+parseInt(_0x465a6e(0x9d))/0x4+-parseInt(_0x465a6e(0x87))/0x5+parseInt(_0x465a6e(0xad))/0x6+-parseInt(_0x465a6e(0x79))/0x7+-parseInt(_0x465a6e(0x8d))/0x8;if(_0x5645b8===_0x526dda)break;else _0x3591d0['push'](_0x3591d0['shift']());}catch(_0x2b114d){_0x3591d0['push'](_0x3591d0['shift']());}}}(a1_0x19b6,0x22d98));const jwt=require('jsonwebtoken'),bcrypt=require(a1_0x691a5e(0xb5)),config=require(a1_0x691a5e(0x7f)),conn=require('../libs/mysql.js'),multer=require(a1_0x691a5e(0x88)),fs=require('fs'),verifyToken=require(a1_0x691a5e(0xa3))[a1_0x691a5e(0x84)];function a1_0x109f(_0x2904af,_0x2c68e1){const _0x19b645=a1_0x19b6();return a1_0x109f=function(_0x109f62,_0x10f10d){_0x109f62=_0x109f62-0x68;let _0x4a5db0=_0x19b645[_0x109f62];return _0x4a5db0;},a1_0x109f(_0x2904af,_0x2c68e1);}!fs[a1_0x691a5e(0x92)]('./avatars')&&fs[a1_0x691a5e(0x91)]('./avatars');const express=require('express'),router=express[a1_0x691a5e(0xb8)](),{randomUUID}=require(a1_0x691a5e(0x83)),storage=multer[a1_0x691a5e(0x9c)]({'destination':function(_0x51669c,_0x4ce4cd,_0x3fdd41){const _0x5ee924=a1_0x691a5e;_0x3fdd41(null,_0x5ee924(0x9f));}}),upload=multer({'storage':storage});function a1_0x19b6(){const _0x219116=['/validate-email/','post','crypto','verifyToken','role','\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22','260515iHYgej','multer','single','/login','path','exports','2198200QMDrMj','last_name','crypted_password','renameSync','mkdirSync','existsSync','Invalid\x20password','username','ServerUrl','user','length','User\x20already\x20exists','demo_user','jwtSecretKey','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','diskStorage','670736JpHcqt','Invalid\x20user','avatars','log','avatar','enableEmailVerification','../libs/jwt','insertId','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','email','3OrYMzj','Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','/update-user-info','hash','is_enabled','1323126dQgmei','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account','9990LNtBvs','.png','sign','stack','Welcome\x20to\x20CADViewer','bcrypt','first_name','execute','Router','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','promise','params','Invalid\x20validation\x20token','avatar_url','message','transporter','avatars/','compare','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','frontendUrl','body','file','/validate-email/:token','json','Invalid\x20email\x20or\x20password','Error!\x20Something\x20went\x20wrong.','540610zuwGle','297314akppUS','status','===================error===================','24h','Email\x20validated\x20successfully','../CADViewer_config.json','../libs/mail'];a1_0x19b6=function(){return _0x219116;};return a1_0x19b6();}router[a1_0x691a5e(0x82)](a1_0x691a5e(0x8a),async(_0x403721,_0x106d3c,_0x4ff170)=>{const _0x1501f5=a1_0x691a5e;let {email:_0x26f6d9,password:_0x2f5010}=_0x403721[_0x1501f5(0x73)];console[_0x1501f5(0xa0)]({'email':_0x26f6d9,'password':_0x2f5010});let _0x3988cf;try{const [_0x719c9e]=await conn[_0x1501f5(0x69)]()['execute'](_0x1501f5(0x68),[_0x26f6d9]);_0x719c9e[_0x1501f5(0x97)]>0x0&&(_0x3988cf=_0x719c9e[0x0]);}catch(_0x5b10ba){console[_0x1501f5(0xa0)]({'err':_0x5b10ba}),_0x106d3c['status'](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x3988cf||!await bcrypt[_0x1501f5(0x70)](_0x2f5010,_0x3988cf?.[_0x1501f5(0x8f)])){_0x106d3c[_0x1501f5(0x7b)](0x191)[_0x1501f5(0x76)]({'error':_0x1501f5(0x77)});return;}let _0x3a9863;try{_0x3a9863=jwt[_0x1501f5(0xb2)]({'userId':_0x3988cf['id'],'email':_0x3988cf['email']},config['jwtSecretKey'],{'expiresIn':_0x1501f5(0x7d)});}catch(_0x5287c4){console[_0x1501f5(0xa0)](_0x5287c4),_0x106d3c[_0x1501f5(0x7b)](0x1f4)['json']({'error':_0x1501f5(0x78)});return;}_0x106d3c[_0x1501f5(0x7b)](0xc8)[_0x1501f5(0x76)]({'success':!![],'data':{'userId':_0x3988cf['id'],'username':_0x3988cf['username'],'first_name':_0x3988cf[_0x1501f5(0xb6)],'last_name':_0x3988cf[_0x1501f5(0x8e)],'email':_0x3988cf[_0x1501f5(0xa7)],'avatar_url':_0x3988cf[_0x1501f5(0x6c)],'id':_0x3988cf['id'],'role':_0x3988cf['role'],'token':_0x3a9863}});}),router[a1_0x691a5e(0x82)]('/signup',async(_0x4ad7f7,_0x3ba603,_0x20ac9d)=>{const _0x2f350f=a1_0x691a5e,{username:_0x48ca82,email:_0x3e9731,password:_0x138aca}=_0x4ad7f7['body'],[_0x30b1e2]=await conn[_0x2f350f(0x69)]()[_0x2f350f(0xb7)](_0x2f350f(0xa6),[_0x3e9731]);if(_0x30b1e2[_0x2f350f(0x97)]>0x0){_0x3ba603[_0x2f350f(0x7b)](0x1a6)[_0x2f350f(0x76)]({'error':_0x2f350f(0x98)});return;}const _0x3a1aad=await bcrypt[_0x2f350f(0xab)](_0x138aca,0xa);let _0x216903=null,_0xd3f9d3=0x1;config[_0x2f350f(0xa2)]&&(_0x216903=randomUUID(),_0xd3f9d3=0x0);let _0x127ed1;try{const _0x50001a=randomUUID(),_0x236af5='./uploads/'+_0x50001a;fs[_0x2f350f(0x91)](_0x236af5);const [_0x57ea36]=await conn[_0x2f350f(0x69)]()['execute'](_0x2f350f(0xa5),[_0x48ca82,_0x3e9731,_0x3a1aad,_0x2f350f(0x99),_0xd3f9d3,_0x216903,_0x50001a]);if(_0x57ea36[_0x2f350f(0xa4)]){const [_0x34bbe2]=await conn['promise']()[_0x2f350f(0xb7)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x57ea36['insertId']]);_0x34bbe2['length']>0x0&&(_0x127ed1=_0x34bbe2[0x0]);}}catch{_0x3ba603[_0x2f350f(0x7b)](0x1f4)[_0x2f350f(0x76)]({'error':_0x2f350f(0x78)});return;}let _0x495939;try{_0x495939=jwt[_0x2f350f(0xb2)]({'userId':_0x127ed1['id'],'email':_0x127ed1[_0x2f350f(0xa7)]},config['jwtSecretKey'],{'expiresIn':'24h'});}catch(_0x16a93b){_0x3ba603['status'](0x1f4)['json']({'error':_0x2f350f(0x78)});return;}const _0xd0d16=require(_0x2f350f(0x80))[_0x2f350f(0x6e)];let _0x39631a='<p>Welcome\x20to\x20CADViewer</p>';if(config[_0x2f350f(0xa2)]){const _0x1cca51=config[_0x2f350f(0x72)]+_0x2f350f(0x81)+_0x216903;_0x39631a=_0x2f350f(0x86)+_0x1cca51+'\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>'+_0x1cca51+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20';const _0x14765e={'from':config['smtpFrom'],'to':_0x127ed1[_0x2f350f(0xa7)],'subject':_0x2f350f(0xb4),'text':_0x2f350f(0xb4),'html':_0x39631a};try{await _0xd0d16['sendMail'](_0x14765e);}catch(_0x234ac3){console['log'](_0x2f350f(0x7c)),console[_0x2f350f(0xa0)](_0x234ac3),_0x3ba603['status'](0x1f4)[_0x2f350f(0x76)]({'error':_0x2f350f(0xa9),'stack':_0x234ac3[_0x2f350f(0xb3)],'message':_0x234ac3[_0x2f350f(0x6d)]});return;}_0x3ba603['status'](0xc8)['json']({'success':!![],'message':_0x2f350f(0xaf)});return;}_0x3ba603[_0x2f350f(0x7b)](0xc9)['json']({'success':!![],'data':{'userId':_0x127ed1['id'],'username':_0x127ed1[_0x2f350f(0x94)],'first_name':_0x127ed1[_0x2f350f(0xb6)],'last_name':_0x127ed1['last_name'],'email':_0x127ed1[_0x2f350f(0xa7)],'avatar_url':_0x127ed1[_0x2f350f(0x6c)],'id':_0x127ed1['id'],'role':_0x127ed1[_0x2f350f(0x85)],'token':_0x495939,'is_enabled':_0x127ed1[_0x2f350f(0xac)]}});}),router[a1_0x691a5e(0x82)](a1_0x691a5e(0x75),async(_0x320ed4,_0xb649ab)=>{const _0x591499=a1_0x691a5e;try{const {token:_0x1e0bf7}=_0x320ed4[_0x591499(0x6a)],[_0x575694]=await conn[_0x591499(0x69)]()[_0x591499(0xb7)](_0x591499(0x71),[_0x1e0bf7]);if(_0x575694['length']===0x0){_0xb649ab[_0x591499(0x7b)](0x194)[_0x591499(0x76)]({'error':_0x591499(0x6b)});return;}await conn[_0x591499(0x69)]()[_0x591499(0xb7)](_0x591499(0xae),[_0x1e0bf7]);const _0x20b4ec=jwt[_0x591499(0xb2)]({'id':_0x575694[0x0]['id'],'email':_0x575694[0x0][_0x591499(0xa7)]},config[_0x591499(0x9a)],{'expiresIn':_0x591499(0x7d)});_0xb649ab[_0x591499(0x7b)](0xc8)['json']({'success':!![],'message':_0x591499(0x7e),'data':{'userId':_0x575694[0x0]['id'],'username':_0x575694[0x0][_0x591499(0x94)],'first_name':_0x575694[0x0][_0x591499(0xb6)],'last_name':_0x575694[0x0][_0x591499(0x8e)],'email':_0x575694[0x0][_0x591499(0xa7)],'avatar_url':_0x575694[0x0][_0x591499(0x6c)],'id':_0x575694[0x0]['id'],'role':_0x575694[0x0][_0x591499(0x85)],'token':_0x20b4ec,'is_enabled':0x1}});}catch(_0x1b41eb){console['log'](_0x591499(0x7c)),console[_0x591499(0xa0)](_0x1b41eb),_0xb649ab['status'](0x1f4)[_0x591499(0x76)]({'error':_0x591499(0x78),'stack':_0x1b41eb[_0x591499(0xb3)],'message':_0x1b41eb[_0x591499(0x6d)]});}}),router['post']('/update-password',verifyToken,async(_0x2cdcf0,_0xbf653a,_0x1495bc)=>{const _0x23e4f1=a1_0x691a5e,{current_password:_0x2ad81d,new_password:_0x515e32}=_0x2cdcf0['body'];console[_0x23e4f1(0xa0)]({'body':_0x2cdcf0['body']});const _0x353829=_0x2cdcf0['user'][_0x23e4f1(0xa7)];let _0x35b407;try{const [_0x56c0b0]=await conn[_0x23e4f1(0x69)]()['execute'](_0x23e4f1(0xa6),[_0x353829]);if(_0x56c0b0[_0x23e4f1(0x97)]>0x0){_0x35b407=_0x56c0b0[0x0];if(!await bcrypt['compare'](_0x2ad81d,_0x35b407['crypted_password'])){_0xbf653a['status'](0x191)[_0x23e4f1(0x76)]({'error':_0x23e4f1(0x93)});return;}const _0x4065ed=await bcrypt['hash'](_0x515e32,0xa);await conn[_0x23e4f1(0x69)]()[_0x23e4f1(0xb7)](_0x23e4f1(0x9b),[_0x4065ed,_0x353829]),_0xbf653a['status'](0xc8)[_0x23e4f1(0x76)]({'success':!![]});}}catch(_0x11b405){console[_0x23e4f1(0xa0)]({'err':_0x11b405}),_0xbf653a['status'](0x1f4)[_0x23e4f1(0x76)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x691a5e(0x82)](a1_0x691a5e(0xaa),upload[a1_0x691a5e(0x89)](a1_0x691a5e(0xa1)),verifyToken,async(_0x41abc5,_0x2568e2,_0x17d1b8)=>{const _0x494b77=a1_0x691a5e,{username:_0x4d5f16,first_name:_0xe396ce,last_name:_0x26dba3}=_0x41abc5[_0x494b77(0x73)],_0x78b351=_0x41abc5[_0x494b77(0x96)]['email'];let _0x3abdd2;try{const [_0x42a8a1]=await conn[_0x494b77(0x69)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x78b351]);_0x42a8a1['length']>0x0&&(_0x3abdd2=_0x42a8a1[0x0]);}catch(_0x1546d8){console[_0x494b77(0xa0)]({'err':_0x1546d8}),_0x2568e2[_0x494b77(0x7b)](0x1f4)[_0x494b77(0x76)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x3abdd2){_0x2568e2[_0x494b77(0x7b)](0x191)[_0x494b77(0x76)]({'error':_0x494b77(0x9e)});return;}console['log']({'req':_0x41abc5[_0x494b77(0x73)]});let _0x28b536=_0x3abdd2[_0x494b77(0x6c)];if(_0x41abc5['file']){const _0x426198=_0x494b77(0x6f)+randomUUID()+_0x494b77(0xb1);fs[_0x494b77(0x90)](_0x41abc5[_0x494b77(0x74)][_0x494b77(0x8b)],'./'+_0x426198),_0x28b536=config[_0x494b77(0x95)]+'/'+_0x426198;}try{await conn['promise']()[_0x494b77(0xb7)]('UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x4d5f16,_0xe396ce,_0x26dba3,_0x28b536,_0x78b351]);let _0x12f430;try{_0x12f430=jwt[_0x494b77(0xb2)]({'userId':_0x3abdd2['id'],'email':_0x3abdd2[_0x494b77(0xa7)]},config['jwtSecretKey'],{'expiresIn':_0x494b77(0x7d)});}catch(_0xdcbb45){console[_0x494b77(0xa0)](_0xdcbb45),_0x2568e2[_0x494b77(0x7b)](0x1f4)[_0x494b77(0x76)]({'error':_0x494b77(0x78)});return;}_0x2568e2[_0x494b77(0x7b)](0xc8)[_0x494b77(0x76)]({'success':!![],'data':{'userId':_0x3abdd2['id'],'username':_0x4d5f16,'first_name':_0xe396ce,'last_name':_0x26dba3,'email':_0x3abdd2[_0x494b77(0xa7)],'avatar_url':_0x28b536,'token':_0x12f430}});}catch(_0x17db1d){console[_0x494b77(0xa0)]({'err':_0x17db1d}),_0x2568e2['status'](0x1f4)['json']({'error':_0x494b77(0x78)});return;}}),module[a1_0x691a5e(0x8c)]=router;