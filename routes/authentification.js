const a1_0x348d1e=a1_0x4cf7;(function(_0x1bd86e,_0x561e14){const _0x191811=a1_0x4cf7,_0x3a9cd2=_0x1bd86e();while(!![]){try{const _0x83ffcd=parseInt(_0x191811(0x18e))/0x1*(parseInt(_0x191811(0x19a))/0x2)+-parseInt(_0x191811(0x15e))/0x3*(parseInt(_0x191811(0x185))/0x4)+-parseInt(_0x191811(0x19f))/0x5*(-parseInt(_0x191811(0x17c))/0x6)+parseInt(_0x191811(0x179))/0x7*(-parseInt(_0x191811(0x175))/0x8)+parseInt(_0x191811(0x16e))/0x9*(parseInt(_0x191811(0x19d))/0xa)+-parseInt(_0x191811(0x178))/0xb+parseInt(_0x191811(0x15c))/0xc*(parseInt(_0x191811(0x158))/0xd);if(_0x83ffcd===_0x561e14)break;else _0x3a9cd2['push'](_0x3a9cd2['shift']());}catch(_0x57e459){_0x3a9cd2['push'](_0x3a9cd2['shift']());}}}(a1_0x2da4,0xf1148));const jwt=require(a1_0x348d1e(0x19b)),bcrypt=require(a1_0x348d1e(0x150)),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require('multer'),fs=require('fs'),verifyToken=require(a1_0x348d1e(0x153))[a1_0x348d1e(0x172)];!fs[a1_0x348d1e(0x167)]('./avatars')&&fs[a1_0x348d1e(0x16f)](a1_0x348d1e(0x14f));function a1_0x4cf7(_0xb0caa6,_0x21f9d3){const _0x2da484=a1_0x2da4();return a1_0x4cf7=function(_0x4cf789,_0x35fe82){_0x4cf789=_0x4cf789-0x14e;let _0x22d1a1=_0x2da484[_0x4cf789];return _0x22d1a1;},a1_0x4cf7(_0xb0caa6,_0x21f9d3);}const express=require('express'),router=express[a1_0x348d1e(0x197)](),{randomUUID}=require(a1_0x348d1e(0x152)),storage=multer[a1_0x348d1e(0x182)]({'destination':function(_0x41b21d,_0x7b0cf8,_0x4e18d5){const _0x1eb45a=a1_0x348d1e;_0x4e18d5(null,_0x1eb45a(0x165));}}),upload=multer({'storage':storage});function a1_0x2da4(){const _0x54bb1f=['3OynBMt','user','json','transporter','Email\x20validated\x20successfully','jwtSecretKey','first_name','avatars','log','existsSync','message','execute','ServerUrl','avatar_url','body','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','1528749sHnatk','mkdirSync','single','smtpFrom','verifyToken','status','exports','16EuFuMH','./uploads/','crypted_password','6552348thitWv','5215161oZAPvf','Invalid\x20email\x20or\x20password','avatar','1454946ffjswL','Invalid\x20user','Welcome\x20to\x20CADViewer','/signup','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','../libs/mail','diskStorage','Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account','24h','7018460MCZRnH','stack','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','length','Invalid\x20password','<p>Welcome\x20to\x20CADViewer</p>','sendMail','insertId','/validate-email/','722PstWWp','/update-password','username','last_name','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','.png','email','sign','avatars/','Router','/validate-email/:token','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','158BvYyUl','jsonwebtoken','demo_user','30EBtnhY','role','25zcMXOW','enableEmailVerification','frontendUrl','./avatars','bcrypt','promise','crypto','../libs/jwt','post','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','compare','Invalid\x20validation\x20token','39633321HLIQXo','Error!\x20Something\x20went\x20wrong.','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','===================error===================','12URgZCa','User\x20already\x20exists'];a1_0x2da4=function(){return _0x54bb1f;};return a1_0x2da4();}router[a1_0x348d1e(0x154)]('/login',async(_0x19aed0,_0x39d45e,_0x40fa8c)=>{const _0x52cee8=a1_0x348d1e;let {email:_0xcebabf,password:_0x57e215}=_0x19aed0[_0x52cee8(0x16c)];console[_0x52cee8(0x166)]({'email':_0xcebabf,'password':_0x57e215});let _0x2441ab;try{const [_0x35dccc]=await conn[_0x52cee8(0x151)]()[_0x52cee8(0x169)](_0x52cee8(0x187),[_0xcebabf]);_0x35dccc[_0x52cee8(0x188)]>0x0&&(_0x2441ab=_0x35dccc[0x0]);}catch(_0x4218b5){console[_0x52cee8(0x166)]({'err':_0x4218b5}),_0x39d45e[_0x52cee8(0x173)](0x1f4)['json']({'error':_0x52cee8(0x159)});return;}console[_0x52cee8(0x166)](_0x2441ab),console[_0x52cee8(0x166)](_0x57e215),console[_0x52cee8(0x166)](_0x2441ab[_0x52cee8(0x177)]);if(!_0x2441ab||!await bcrypt[_0x52cee8(0x156)](_0x57e215,_0x2441ab[_0x52cee8(0x177)])){_0x39d45e['status'](0x191)['json']({'error':_0x52cee8(0x17a)});return;}let _0x2bde51;try{_0x2bde51=jwt['sign']({'userId':_0x2441ab['id'],'email':_0x2441ab[_0x52cee8(0x194)]},config[_0x52cee8(0x163)],{'expiresIn':'24h'});}catch(_0x4255a4){console[_0x52cee8(0x166)](_0x4255a4),_0x39d45e['status'](0x1f4)[_0x52cee8(0x160)]({'error':_0x52cee8(0x159)});return;}_0x39d45e[_0x52cee8(0x173)](0xc8)[_0x52cee8(0x160)]({'success':!![],'data':{'userId':_0x2441ab['id'],'username':_0x2441ab[_0x52cee8(0x190)],'first_name':_0x2441ab[_0x52cee8(0x164)],'last_name':_0x2441ab[_0x52cee8(0x191)],'email':_0x2441ab['email'],'avatar_url':_0x2441ab[_0x52cee8(0x16b)],'id':_0x2441ab['id'],'role':_0x2441ab[_0x52cee8(0x19e)],'token':_0x2bde51}});}),router[a1_0x348d1e(0x154)](a1_0x348d1e(0x17f),async(_0x3c1007,_0x3addec,_0x4712a5)=>{const _0x4c1f3c=a1_0x348d1e,{username:_0x43d042,email:_0x124406,password:_0x1e5c2a}=_0x3c1007[_0x4c1f3c(0x16c)],[_0xd3b721]=await conn[_0x4c1f3c(0x151)]()[_0x4c1f3c(0x169)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x124406]);if(_0xd3b721[_0x4c1f3c(0x188)]>0x0){_0x3addec[_0x4c1f3c(0x173)](0x1a6)[_0x4c1f3c(0x160)]({'error':_0x4c1f3c(0x15d)});return;}const _0x342bb1=await bcrypt['hash'](_0x1e5c2a,0xa);let _0xcd5189=null,_0x3075df=0x1;config['enableEmailVerification']&&(_0xcd5189=randomUUID(),_0x3075df=0x0);let _0x6b761d;try{const _0x4b1137=randomUUID(),_0x32c2a1=_0x4c1f3c(0x176)+_0x4b1137;fs['mkdirSync'](_0x32c2a1);const [_0x240eac]=await conn[_0x4c1f3c(0x151)]()[_0x4c1f3c(0x169)](_0x4c1f3c(0x192),[_0x43d042,_0x124406,_0x342bb1,_0x4c1f3c(0x19c),_0x3075df,_0xcd5189,_0x4b1137]);if(_0x240eac[_0x4c1f3c(0x18c)]){const [_0x82cd76]=await conn[_0x4c1f3c(0x151)]()[_0x4c1f3c(0x169)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x240eac[_0x4c1f3c(0x18c)]]);_0x82cd76['length']>0x0&&(_0x6b761d=_0x82cd76[0x0]);}}catch{_0x3addec['status'](0x1f4)[_0x4c1f3c(0x160)]({'error':_0x4c1f3c(0x159)});return;}let _0x1509e6;try{_0x1509e6=jwt['sign']({'userId':_0x6b761d['id'],'email':_0x6b761d['email']},config[_0x4c1f3c(0x163)],{'expiresIn':'24h'});}catch(_0x2fe9c6){_0x3addec['status'](0x1f4)[_0x4c1f3c(0x160)]({'error':_0x4c1f3c(0x159)});return;}const _0x407301=require(_0x4c1f3c(0x181))[_0x4c1f3c(0x161)];let _0x108a3a=_0x4c1f3c(0x18a);if(config[_0x4c1f3c(0x1a0)]){const _0x15c403=config[_0x4c1f3c(0x14e)]+_0x4c1f3c(0x18d)+_0xcd5189;_0x108a3a='\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22'+_0x15c403+_0x4c1f3c(0x199)+_0x15c403+_0x4c1f3c(0x180);const _0x234009={'from':config[_0x4c1f3c(0x171)],'to':_0x6b761d[_0x4c1f3c(0x194)],'subject':_0x4c1f3c(0x17e),'text':_0x4c1f3c(0x17e),'html':_0x108a3a};try{await _0x407301[_0x4c1f3c(0x18b)](_0x234009);}catch(_0x4d2df1){console[_0x4c1f3c(0x166)](_0x4c1f3c(0x15b)),console['log'](_0x4d2df1),_0x3addec[_0x4c1f3c(0x173)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0x4d2df1[_0x4c1f3c(0x186)],'message':_0x4d2df1[_0x4c1f3c(0x168)]});return;}_0x3addec[_0x4c1f3c(0x173)](0xc8)[_0x4c1f3c(0x160)]({'success':!![],'message':_0x4c1f3c(0x183)});return;}_0x3addec[_0x4c1f3c(0x173)](0xc9)[_0x4c1f3c(0x160)]({'success':!![],'data':{'userId':_0x6b761d['id'],'username':_0x6b761d[_0x4c1f3c(0x190)],'first_name':_0x6b761d['first_name'],'last_name':_0x6b761d[_0x4c1f3c(0x191)],'email':_0x6b761d[_0x4c1f3c(0x194)],'avatar_url':_0x6b761d[_0x4c1f3c(0x16b)],'id':_0x6b761d['id'],'role':_0x6b761d['role'],'token':_0x1509e6,'is_enabled':_0x6b761d['is_enabled']}});}),router[a1_0x348d1e(0x154)](a1_0x348d1e(0x198),async(_0x545b4a,_0x3ab242)=>{const _0x48daf0=a1_0x348d1e;try{const {token:_0x328d46}=_0x545b4a['params'],[_0xa76e41]=await conn[_0x48daf0(0x151)]()[_0x48daf0(0x169)](_0x48daf0(0x16d),[_0x328d46]);if(_0xa76e41[_0x48daf0(0x188)]===0x0){_0x3ab242[_0x48daf0(0x173)](0x194)[_0x48daf0(0x160)]({'error':_0x48daf0(0x157)});return;}await conn[_0x48daf0(0x151)]()[_0x48daf0(0x169)](_0x48daf0(0x155),[_0x328d46]);const _0x3768ea=jwt['sign']({'id':_0xa76e41[0x0]['id'],'email':_0xa76e41[0x0][_0x48daf0(0x194)]},config[_0x48daf0(0x163)],{'expiresIn':_0x48daf0(0x184)});_0x3ab242[_0x48daf0(0x173)](0xc8)[_0x48daf0(0x160)]({'success':!![],'message':_0x48daf0(0x162),'data':{'userId':_0xa76e41[0x0]['id'],'username':_0xa76e41[0x0]['username'],'first_name':_0xa76e41[0x0][_0x48daf0(0x164)],'last_name':_0xa76e41[0x0]['last_name'],'email':_0xa76e41[0x0][_0x48daf0(0x194)],'avatar_url':_0xa76e41[0x0][_0x48daf0(0x16b)],'id':_0xa76e41[0x0]['id'],'role':_0xa76e41[0x0][_0x48daf0(0x19e)],'token':_0x3768ea,'is_enabled':0x1}});}catch(_0x251a04){console['log'](_0x48daf0(0x15b)),console[_0x48daf0(0x166)](_0x251a04),_0x3ab242[_0x48daf0(0x173)](0x1f4)['json']({'error':_0x48daf0(0x159),'stack':_0x251a04['stack'],'message':_0x251a04[_0x48daf0(0x168)]});}}),router[a1_0x348d1e(0x154)](a1_0x348d1e(0x18f),verifyToken,async(_0x21747e,_0x1cd1f0,_0x563d26)=>{const _0xb3d575=a1_0x348d1e,{current_password:_0x230f2f,new_password:_0x56a97b}=_0x21747e[_0xb3d575(0x16c)];console[_0xb3d575(0x166)]({'body':_0x21747e[_0xb3d575(0x16c)]});const _0x26b94b=_0x21747e[_0xb3d575(0x15f)][_0xb3d575(0x194)];let _0x40e54a;try{const [_0x2acf21]=await conn[_0xb3d575(0x151)]()[_0xb3d575(0x169)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x26b94b]);if(_0x2acf21[_0xb3d575(0x188)]>0x0){_0x40e54a=_0x2acf21[0x0];if(!await bcrypt['compare'](_0x230f2f,_0x40e54a[_0xb3d575(0x177)])){_0x1cd1f0[_0xb3d575(0x173)](0x191)['json']({'error':_0xb3d575(0x189)});return;}const _0x24b982=await bcrypt['hash'](_0x56a97b,0xa);await conn[_0xb3d575(0x151)]()[_0xb3d575(0x169)]('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x24b982,_0x26b94b]),_0x1cd1f0[_0xb3d575(0x173)](0xc8)[_0xb3d575(0x160)]({'success':!![]});}}catch(_0x2a644b){console[_0xb3d575(0x166)]({'err':_0x2a644b}),_0x1cd1f0[_0xb3d575(0x173)](0x1f4)[_0xb3d575(0x160)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x348d1e(0x154)]('/update-user-info',upload[a1_0x348d1e(0x170)](a1_0x348d1e(0x17b)),verifyToken,async(_0x30d9b0,_0x12efe3,_0x3a2c65)=>{const _0x2e3439=a1_0x348d1e,{username:_0x2f8aba,first_name:_0x5260ae,last_name:_0x593b57}=_0x30d9b0[_0x2e3439(0x16c)],_0x3c40c2=_0x30d9b0['user']['email'];let _0x52db70;try{const [_0x27390c]=await conn[_0x2e3439(0x151)]()[_0x2e3439(0x169)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x3c40c2]);_0x27390c[_0x2e3439(0x188)]>0x0&&(_0x52db70=_0x27390c[0x0]);}catch(_0x2529c6){console['log']({'err':_0x2529c6}),_0x12efe3[_0x2e3439(0x173)](0x1f4)['json']({'error':_0x2e3439(0x159)});return;}if(!_0x52db70){_0x12efe3[_0x2e3439(0x173)](0x191)[_0x2e3439(0x160)]({'error':_0x2e3439(0x17d)});return;}console['log']({'req':_0x30d9b0[_0x2e3439(0x16c)]});let _0x503a88=_0x52db70[_0x2e3439(0x16b)];if(_0x30d9b0['file']){const _0x30f436=_0x2e3439(0x196)+randomUUID()+_0x2e3439(0x193);fs['renameSync'](_0x30d9b0['file']['path'],'./'+_0x30f436),_0x503a88=config[_0x2e3439(0x16a)]+'/'+_0x30f436;}try{await conn[_0x2e3439(0x151)]()['execute'](_0x2e3439(0x15a),[_0x2f8aba,_0x5260ae,_0x593b57,_0x503a88,_0x3c40c2]);let _0x3e11c0;try{_0x3e11c0=jwt[_0x2e3439(0x195)]({'userId':_0x52db70['id'],'email':_0x52db70[_0x2e3439(0x194)]},config[_0x2e3439(0x163)],{'expiresIn':_0x2e3439(0x184)});}catch(_0x4b8450){console[_0x2e3439(0x166)](_0x4b8450),_0x12efe3[_0x2e3439(0x173)](0x1f4)[_0x2e3439(0x160)]({'error':_0x2e3439(0x159)});return;}_0x12efe3[_0x2e3439(0x173)](0xc8)['json']({'success':!![],'data':{'userId':_0x52db70['id'],'username':_0x2f8aba,'first_name':_0x5260ae,'last_name':_0x593b57,'email':_0x52db70['email'],'avatar_url':_0x503a88,'token':_0x3e11c0}});}catch(_0x15320d){console[_0x2e3439(0x166)]({'err':_0x15320d}),_0x12efe3['status'](0x1f4)[_0x2e3439(0x160)]({'error':_0x2e3439(0x159)});return;}}),module[a1_0x348d1e(0x174)]=router;