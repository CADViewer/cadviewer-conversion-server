const a1_0x348c01=a1_0x56d7;function a1_0x56d7(_0x3a38b5,_0x592963){const _0x3678ce=a1_0x3678();return a1_0x56d7=function(_0x56d712,_0x56c8a7){_0x56d712=_0x56d712-0xfb;let _0x367066=_0x3678ce[_0x56d712];return _0x367066;},a1_0x56d7(_0x3a38b5,_0x592963);}function a1_0x3678(){const _0x31912c=['../libs/email-utils','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','Invalid\x20user','multer','file','insertId','24h','body','unlinkSync','avatar','crypto','params','./avatars','Invalid\x20password','promise','role','Error!\x20Something\x20went\x20wrong.','sign','name','Router','crypted_password','exports','city','path','1426185LbCBrX','.png','hash','compare','axios','data','execute','enableEmailVerification','/validate-email/:token','bcrypt','3nLpxEr','error','Error\x20parsing\x20geolocation\x20data:','single','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','recaptchaEnabled','8082725qMBUsH','is_enabled','./uploads/','Error\x20during\x20reCAPTCHA\x20verification.','copyFileSync','jwtSecretKey','avatar_url','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','248OWoehu','recaptchaSecretKey','2729604fWAXjz','success','callbackMethod_gatewayUrl','stack','Error\x20during\x20user\x20creation:','first_name','../libs/jwt','reCAPTCHA\x20verification\x20error:','post','last_name','Invalid\x20validation\x20token','===================error===================','json','languages','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','jsonwebtoken','ServerUrl','express','length','diskStorage','verifyToken','avatars','existsSync','time_zone','demo_user','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','1186115HoRbVs','../CADViewer_config.json','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','mkdirSync','log','username','email','558981yAYqXl','country_name','user','1635874kqwJYd','code','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','Email\x20validated\x20successfully','2798860gKDshm','status','message'];a1_0x3678=function(){return _0x31912c;};return a1_0x3678();}(function(_0x262668,_0x4662e7){const _0x38762c=a1_0x56d7,_0x1c12af=_0x262668();while(!![]){try{const _0x394462=-parseInt(_0x38762c(0x125))/0x1+-parseInt(_0x38762c(0x128))/0x2*(parseInt(_0x38762c(0x151))/0x3)+-parseInt(_0x38762c(0x12c))/0x4+-parseInt(_0x38762c(0x157))/0x5+-parseInt(_0x38762c(0x103))/0x6+parseInt(_0x38762c(0x11e))/0x7+-parseInt(_0x38762c(0x101))/0x8*(-parseInt(_0x38762c(0x147))/0x9);if(_0x394462===_0x4662e7)break;else _0x1c12af['push'](_0x1c12af['shift']());}catch(_0x18e9e9){_0x1c12af['push'](_0x1c12af['shift']());}}}(a1_0x3678,0xe3f74));const jwt=require(a1_0x348c01(0x113)),bcrypt=require(a1_0x348c01(0x150)),config=require(a1_0x348c01(0x11f)),conn=require('../libs/mysql.js'),multer=require(a1_0x348c01(0x132)),fs=require('fs'),verifyToken=require(a1_0x348c01(0x109))[a1_0x348c01(0x118)],{sendWelcomeEmail}=require(a1_0x348c01(0x12f)),axios=require(a1_0x348c01(0x14b));!fs[a1_0x348c01(0x11a)](a1_0x348c01(0x13b))&&fs['mkdirSync']('./avatars');const express=require(a1_0x348c01(0x115)),router=express[a1_0x348c01(0x142)](),{randomUUID}=require(a1_0x348c01(0x139)),storage=multer[a1_0x348c01(0x117)]({'destination':function(_0x309944,_0x2f5823,_0x44408f){const _0x183922=a1_0x348c01;_0x44408f(null,_0x183922(0x119));}}),upload=multer({'storage':storage});router['post']('/login',async(_0x3dd127,_0x248b4d,_0x21f763)=>{const _0x2a9917=a1_0x348c01;let {email:_0x11d689,password:_0x2e6275}=_0x3dd127[_0x2a9917(0x136)];console[_0x2a9917(0x122)]({'email':_0x11d689,'password':_0x2e6275});let _0x5160d9;try{const [_0x398524]=await conn['promise']()['execute'](_0x2a9917(0x12a),[_0x11d689]);_0x398524['length']>0x0&&(_0x5160d9=_0x398524[0x0]);}catch(_0x474a6a){console[_0x2a9917(0x122)]({'err':_0x474a6a}),_0x248b4d[_0x2a9917(0x12d)](0x1f4)['json']({'error':_0x2a9917(0x13f)});return;}if(!_0x5160d9||!await bcrypt[_0x2a9917(0x14a)](_0x2e6275,_0x5160d9?.[_0x2a9917(0x143)])){_0x248b4d[_0x2a9917(0x12d)](0x191)['json']({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x1c5904;try{_0x1c5904=jwt[_0x2a9917(0x140)]({'userId':_0x5160d9['id'],'email':_0x5160d9[_0x2a9917(0x124)]},config['jwtSecretKey'],{'expiresIn':_0x2a9917(0x135)});}catch(_0x2c19e2){console[_0x2a9917(0x122)](_0x2c19e2),_0x248b4d[_0x2a9917(0x12d)](0x1f4)[_0x2a9917(0x10f)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x248b4d[_0x2a9917(0x12d)](0xc8)['json']({'success':!![],'data':{'userId':_0x5160d9['id'],'username':_0x5160d9[_0x2a9917(0x123)],'first_name':_0x5160d9[_0x2a9917(0x108)],'last_name':_0x5160d9[_0x2a9917(0x10c)],'email':_0x5160d9['email'],'avatar_url':_0x5160d9['avatar_url'],'id':_0x5160d9['id'],'role':_0x5160d9[_0x2a9917(0x13e)],'token':_0x1c5904}});}),router[a1_0x348c01(0x10b)]('/signup',async(_0x184d95,_0x428af0,_0x205e85)=>{const _0x36bf60=a1_0x348c01,{username:_0x2a7cb2,email:_0xc1acb1,password:_0x66e15e,geolocation:_0x9dffab,recaptchaToken:_0x474bfb}=_0x184d95['body'];if(config[_0x36bf60(0x156)]){if(!_0x474bfb)return _0x428af0['status'](0x190)['json']({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.'});try{const _0x180284=await axios['post']('https://www.google.com/recaptcha/api/siteverify',null,{'params':{'secret':config[_0x36bf60(0x102)],'response':_0x474bfb}});if(!_0x180284[_0x36bf60(0x14c)][_0x36bf60(0x104)])return _0x428af0[_0x36bf60(0x12d)](0x190)[_0x36bf60(0x10f)]({'error':_0x36bf60(0x130),'recaptchaErrors':_0x180284[_0x36bf60(0x14c)]['error-codes']});}catch(_0x52678e){return console[_0x36bf60(0x152)](_0x36bf60(0x10a),_0x52678e),_0x428af0[_0x36bf60(0x12d)](0x1f4)[_0x36bf60(0x10f)]({'error':_0x36bf60(0xfc)});}}const [_0x50a043]=await conn[_0x36bf60(0x13d)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0xc1acb1]);if(_0x50a043[_0x36bf60(0x116)]>0x0){_0x428af0['status'](0x1a6)[_0x36bf60(0x10f)]({'error':'User\x20already\x20exists'});return;}const _0x22713f=await bcrypt[_0x36bf60(0x149)](_0x66e15e,0xa);let _0x1d51f4=null,_0x4bfd79=0x1;config[_0x36bf60(0x14e)]&&(_0x1d51f4=randomUUID(),_0x4bfd79=0x0);let _0x125b39=null,_0x5930e7=null,_0x266007=null,_0x46011b=null,_0x57a7f4=null,_0x294af7=null;if(_0x9dffab)try{const _0x6b4b73=_0x9dffab;_0x125b39=_0x6b4b73[_0x36bf60(0x145)]||null,_0x5930e7=_0x6b4b73['region']||null,_0x266007=_0x6b4b73[_0x36bf60(0x126)]||null,_0x6b4b73['languages']&&_0x6b4b73[_0x36bf60(0x110)]['length']>0x0&&(_0x46011b=_0x6b4b73[_0x36bf60(0x110)][0x0][_0x36bf60(0x129)]||null,_0x57a7f4=_0x6b4b73['languages'][0x0][_0x36bf60(0x141)]||null),_0x6b4b73[_0x36bf60(0x11b)]&&(_0x294af7=_0x6b4b73['time_zone'][_0x36bf60(0x141)]||null);}catch(_0x164587){console[_0x36bf60(0x122)](_0x36bf60(0x153),_0x164587);}let _0x554e28;try{const _0x2ff4f1=randomUUID(),_0x2e8c70=_0x36bf60(0xfb)+_0x2ff4f1;fs[_0x36bf60(0x121)](_0x2e8c70);const [_0x1a8551]=await conn[_0x36bf60(0x13d)]()[_0x36bf60(0x14d)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x2a7cb2,_0xc1acb1,_0x22713f,_0x36bf60(0x11c),_0x4bfd79,_0x1d51f4,_0x2ff4f1,_0x125b39,_0x5930e7,_0x266007,_0x46011b,_0x57a7f4,_0x294af7]);if(_0x1a8551[_0x36bf60(0x134)]){const [_0x20f35d]=await conn[_0x36bf60(0x13d)]()[_0x36bf60(0x14d)](_0x36bf60(0x112),[_0x1a8551[_0x36bf60(0x134)]]);_0x20f35d[_0x36bf60(0x116)]>0x0&&(_0x554e28=_0x20f35d[0x0]);}}catch(_0x341c5b){console[_0x36bf60(0x122)](_0x36bf60(0x107),_0x341c5b),_0x428af0[_0x36bf60(0x12d)](0x1f4)[_0x36bf60(0x10f)]({'error':_0x36bf60(0x13f)});return;}let _0x4bda76;try{_0x4bda76=jwt[_0x36bf60(0x140)]({'userId':_0x554e28['id'],'email':_0x554e28[_0x36bf60(0x124)]},config[_0x36bf60(0xfe)],{'expiresIn':'24h'});}catch(_0x2d33a1){_0x428af0[_0x36bf60(0x12d)](0x1f4)[_0x36bf60(0x10f)]({'error':_0x36bf60(0x13f)});return;}if(config['enableEmailVerification']){try{await sendWelcomeEmail(_0x554e28,_0x1d51f4);}catch(_0x14db3e){console[_0x36bf60(0x122)](_0x36bf60(0x10e)),console['log'](_0x14db3e);}_0x428af0['status'](0xc8)[_0x36bf60(0x10f)]({'success':!![],'message':_0x36bf60(0x120)});return;}_0x428af0['status'](0xc9)[_0x36bf60(0x10f)]({'success':!![],'data':{'userId':_0x554e28['id'],'username':_0x554e28[_0x36bf60(0x123)],'first_name':_0x554e28[_0x36bf60(0x108)],'last_name':_0x554e28['last_name'],'email':_0x554e28['email'],'avatar_url':_0x554e28['avatar_url'],'id':_0x554e28['id'],'role':_0x554e28[_0x36bf60(0x13e)],'token':_0x4bda76,'is_enabled':_0x554e28[_0x36bf60(0x158)]}});}),router[a1_0x348c01(0x10b)](a1_0x348c01(0x14f),async(_0xd7b4c3,_0x560cd8)=>{const _0x5ec401=a1_0x348c01;try{const {token:_0x1f8c4d}=_0xd7b4c3[_0x5ec401(0x13a)],[_0x4cec61]=await conn['promise']()[_0x5ec401(0x14d)](_0x5ec401(0x11d),[_0x1f8c4d]);if(_0x4cec61[_0x5ec401(0x116)]===0x0){_0x560cd8['status'](0x194)[_0x5ec401(0x10f)]({'error':_0x5ec401(0x10d)});return;}await conn[_0x5ec401(0x13d)]()[_0x5ec401(0x14d)](_0x5ec401(0x100),[_0x1f8c4d]);const _0x1cf159=jwt[_0x5ec401(0x140)]({'id':_0x4cec61[0x0]['id'],'email':_0x4cec61[0x0][_0x5ec401(0x124)]},config[_0x5ec401(0xfe)],{'expiresIn':_0x5ec401(0x135)});_0x560cd8[_0x5ec401(0x12d)](0xc8)[_0x5ec401(0x10f)]({'success':!![],'message':_0x5ec401(0x12b),'data':{'userId':_0x4cec61[0x0]['id'],'username':_0x4cec61[0x0][_0x5ec401(0x123)],'first_name':_0x4cec61[0x0]['first_name'],'last_name':_0x4cec61[0x0][_0x5ec401(0x10c)],'email':_0x4cec61[0x0][_0x5ec401(0x124)],'avatar_url':_0x4cec61[0x0][_0x5ec401(0xff)],'id':_0x4cec61[0x0]['id'],'role':_0x4cec61[0x0]['role'],'token':_0x1cf159,'is_enabled':0x1}});}catch(_0x2b7090){console[_0x5ec401(0x122)](_0x5ec401(0x10e)),console[_0x5ec401(0x122)](_0x2b7090),_0x560cd8[_0x5ec401(0x12d)](0x1f4)[_0x5ec401(0x10f)]({'error':_0x5ec401(0x13f),'stack':_0x2b7090[_0x5ec401(0x106)],'message':_0x2b7090[_0x5ec401(0x12e)]});}}),router[a1_0x348c01(0x10b)]('/update-password',verifyToken,async(_0x44e542,_0x19e448,_0x3322c1)=>{const _0x30632d=a1_0x348c01,{current_password:_0x45308c,new_password:_0x4d7a47}=_0x44e542['body'];console[_0x30632d(0x122)]({'body':_0x44e542[_0x30632d(0x136)]});const _0x2479fd=_0x44e542[_0x30632d(0x127)][_0x30632d(0x124)];let _0x8a8ba4;try{const [_0x355930]=await conn[_0x30632d(0x13d)]()[_0x30632d(0x14d)](_0x30632d(0x155),[_0x2479fd]);if(_0x355930[_0x30632d(0x116)]>0x0){_0x8a8ba4=_0x355930[0x0];if(!await bcrypt[_0x30632d(0x14a)](_0x45308c,_0x8a8ba4[_0x30632d(0x143)])){_0x19e448[_0x30632d(0x12d)](0x191)['json']({'error':_0x30632d(0x13c)});return;}const _0x19d2cd=await bcrypt[_0x30632d(0x149)](_0x4d7a47,0xa);await conn['promise']()[_0x30632d(0x14d)]('UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?',[_0x19d2cd,_0x2479fd]),_0x19e448[_0x30632d(0x12d)](0xc8)[_0x30632d(0x10f)]({'success':!![]});}}catch(_0x4fb373){console[_0x30632d(0x122)]({'err':_0x4fb373}),_0x19e448['status'](0x1f4)['json']({'error':_0x30632d(0x13f)});return;}}),router['post']('/update-user-info',upload[a1_0x348c01(0x154)](a1_0x348c01(0x138)),verifyToken,async(_0x509cf3,_0x428ef2,_0x24179f)=>{const _0x4db3ea=a1_0x348c01,{username:_0x21bbd0,first_name:_0x5e04ff,last_name:_0x281024}=_0x509cf3['body'],_0x2c0fd4=_0x509cf3['user'][_0x4db3ea(0x124)];let _0x54ad5e;try{const [_0x1c787b]=await conn[_0x4db3ea(0x13d)]()['execute'](_0x4db3ea(0x155),[_0x2c0fd4]);_0x1c787b['length']>0x0&&(_0x54ad5e=_0x1c787b[0x0]);}catch(_0x585a50){console['log']({'err':_0x585a50}),_0x428ef2[_0x4db3ea(0x12d)](0x1f4)[_0x4db3ea(0x10f)]({'error':_0x4db3ea(0x13f)});return;}if(!_0x54ad5e){_0x428ef2[_0x4db3ea(0x12d)](0x191)[_0x4db3ea(0x10f)]({'error':_0x4db3ea(0x131)});return;}console[_0x4db3ea(0x122)]({'req':_0x509cf3[_0x4db3ea(0x136)]});let _0x3a843f=_0x54ad5e[_0x4db3ea(0xff)];if(_0x509cf3[_0x4db3ea(0x133)]){const _0x268354='avatars/'+randomUUID()+_0x4db3ea(0x148);fs[_0x4db3ea(0xfd)](_0x509cf3[_0x4db3ea(0x133)][_0x4db3ea(0x146)],'./'+_0x268354),fs[_0x4db3ea(0x137)](_0x509cf3['file'][_0x4db3ea(0x146)]),config['callbackMethod_gatewayUrl_flag']?_0x3a843f=config[_0x4db3ea(0x105)]+'/'+_0x268354:_0x3a843f=config[_0x4db3ea(0x114)]+'/'+_0x268354;}try{await conn[_0x4db3ea(0x13d)]()[_0x4db3ea(0x14d)](_0x4db3ea(0x111),[_0x21bbd0,_0x5e04ff,_0x281024,_0x3a843f,_0x2c0fd4]);let _0x536a87;try{_0x536a87=jwt[_0x4db3ea(0x140)]({'userId':_0x54ad5e['id'],'email':_0x54ad5e[_0x4db3ea(0x124)]},config[_0x4db3ea(0xfe)],{'expiresIn':'24h'});}catch(_0x526131){console[_0x4db3ea(0x122)](_0x526131),_0x428ef2[_0x4db3ea(0x12d)](0x1f4)['json']({'error':_0x4db3ea(0x13f)});return;}_0x428ef2['status'](0xc8)[_0x4db3ea(0x10f)]({'success':!![],'data':{'userId':_0x54ad5e['id'],'username':_0x21bbd0,'first_name':_0x5e04ff,'last_name':_0x281024,'email':_0x54ad5e[_0x4db3ea(0x124)],'avatar_url':_0x3a843f,'token':_0x536a87}});}catch(_0x52a4eb){console[_0x4db3ea(0x122)]({'err':_0x52a4eb}),_0x428ef2[_0x4db3ea(0x12d)](0x1f4)['json']({'error':_0x4db3ea(0x13f)});return;}}),module[a1_0x348c01(0x144)]=router;