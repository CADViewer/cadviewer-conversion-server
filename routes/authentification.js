const a1_0x58d753=a1_0x1c87;(function(_0x41554a,_0x4e3bd0){const _0x2d66ed=a1_0x1c87,_0x26b811=_0x41554a();while(!![]){try{const _0x376188=parseInt(_0x2d66ed(0x206))/0x1*(-parseInt(_0x2d66ed(0x1e5))/0x2)+-parseInt(_0x2d66ed(0x203))/0x3*(parseInt(_0x2d66ed(0x1be))/0x4)+parseInt(_0x2d66ed(0x1cf))/0x5+parseInt(_0x2d66ed(0x201))/0x6*(parseInt(_0x2d66ed(0x208))/0x7)+parseInt(_0x2d66ed(0x1d7))/0x8+-parseInt(_0x2d66ed(0x1bf))/0x9+parseInt(_0x2d66ed(0x1bd))/0xa;if(_0x376188===_0x4e3bd0)break;else _0x26b811['push'](_0x26b811['shift']());}catch(_0x475e04){_0x26b811['push'](_0x26b811['shift']());}}}(a1_0x2a9e,0x9b860));function a1_0x1c87(_0x383246,_0x166635){const _0x2a9e60=a1_0x2a9e();return a1_0x1c87=function(_0x1c87ed,_0x52a2f6){_0x1c87ed=_0x1c87ed-0x1b2;let _0x241b09=_0x2a9e60[_0x1c87ed];return _0x241b09;},a1_0x1c87(_0x383246,_0x166635);}const jwt=require(a1_0x58d753(0x205)),bcrypt=require(a1_0x58d753(0x1e8)),config=require(a1_0x58d753(0x1fe)),conn=require(a1_0x58d753(0x1fa)),multer=require(a1_0x58d753(0x1cd)),fs=require('fs'),verifyToken=require('../libs/jwt')[a1_0x58d753(0x1ff)],{sendWelcomeEmail}=require(a1_0x58d753(0x1f8)),axios=require(a1_0x58d753(0x1cb));!fs[a1_0x58d753(0x1e0)](a1_0x58d753(0x1ba))&&fs[a1_0x58d753(0x1e4)](a1_0x58d753(0x1ba));function a1_0x2a9e(){const _0x31841e=['/validate-email/:token','crypto','existsSync','/update-user-info','Invalid\x20user','country_name','mkdirSync','314IcSBLd','name','Invalid\x20validation\x20token','bcrypt','Error\x20during\x20reCAPTCHA\x20verification.','enableEmailVerification','success','first_name','insertId','file','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','24h','stack','recaptchaSecretKey','Error!\x20Something\x20went\x20wrong.','path','./uploads/','/update-password','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','../libs/email-utils','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','../libs/mysql.js','role','express','recaptchaEnabled','../CADViewer_config.json','verifyToken','Email\x20validated\x20successfully','1974mqygZH','body','3552WVLioA','User\x20already\x20exists','jsonwebtoken','7513hiWbST','diskStorage','581arvEZt','data','===================error===================','city','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','crypted_password','post','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','reCAPTCHA\x20verification\x20error:','callbackMethod_gatewayUrl','languages','Error\x20during\x20user\x20creation:','json','avatars/','./avatars','promise','message','15941180LBDGin','744vqPxZR','10792107eRMZCf','avatar_url','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','hash','sign','region','length','user','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','username','jwtSecretKey','Error\x20parsing\x20geolocation\x20data:','axios','status','multer','.png','4929760SbltMd','execute','avatar','Invalid\x20password','log','params','unlinkSync','error','5028280BXXCSF','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','compare','last_name','code','callbackMethod_gatewayUrl_flag','email'];a1_0x2a9e=function(){return _0x31841e;};return a1_0x2a9e();}const express=require(a1_0x58d753(0x1fc)),router=express['Router'](),{randomUUID}=require(a1_0x58d753(0x1df)),storage=multer[a1_0x58d753(0x207)]({'destination':function(_0x26762b,_0x28a0a3,_0x1fb31a){_0x1fb31a(null,'avatars');}}),upload=multer({'storage':storage});router[a1_0x58d753(0x1b2)]('/login',async(_0x5cd996,_0x3f377f,_0x14c6cf)=>{const _0x31778f=a1_0x58d753;let {email:_0xc87326,password:_0x27bf79}=_0x5cd996[_0x31778f(0x202)];console[_0x31778f(0x1d3)]({'email':_0xc87326,'password':_0x27bf79});let _0xf836fa;try{const [_0x1bf2e1]=await conn[_0x31778f(0x1bb)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0xc87326]);_0x1bf2e1[_0x31778f(0x1c5)]>0x0&&(_0xf836fa=_0x1bf2e1[0x0]);}catch(_0x1d0f64){console[_0x31778f(0x1d3)]({'err':_0x1d0f64}),_0x3f377f[_0x31778f(0x1cc)](0x1f4)[_0x31778f(0x1b8)]({'error':_0x31778f(0x1f3)});return;}if(!_0xf836fa||!await bcrypt[_0x31778f(0x1d9)](_0x27bf79,_0xf836fa?.[_0x31778f(0x20d)])){_0x3f377f[_0x31778f(0x1cc)](0x191)[_0x31778f(0x1b8)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x1d8e9b;try{_0x1d8e9b=jwt[_0x31778f(0x1c3)]({'userId':_0xf836fa['id'],'email':_0xf836fa[_0x31778f(0x1dd)]},config[_0x31778f(0x1c9)],{'expiresIn':_0x31778f(0x1f0)});}catch(_0xa14f33){console[_0x31778f(0x1d3)](_0xa14f33),_0x3f377f[_0x31778f(0x1cc)](0x1f4)[_0x31778f(0x1b8)]({'error':_0x31778f(0x1f3)});return;}_0x3f377f[_0x31778f(0x1cc)](0xc8)['json']({'success':!![],'data':{'userId':_0xf836fa['id'],'username':_0xf836fa['username'],'first_name':_0xf836fa[_0x31778f(0x1ec)],'last_name':_0xf836fa[_0x31778f(0x1da)],'email':_0xf836fa[_0x31778f(0x1dd)],'avatar_url':_0xf836fa[_0x31778f(0x1c0)],'id':_0xf836fa['id'],'role':_0xf836fa['role'],'token':_0x1d8e9b}});}),router[a1_0x58d753(0x1b2)]('/signup',async(_0xc4cb37,_0x5c02b5,_0x14f847)=>{const _0x50ae7c=a1_0x58d753,{username:_0x393c5b,email:_0x57c494,password:_0x47af65,geolocation:_0x124236,recaptchaToken:_0x21b2eb}=_0xc4cb37[_0x50ae7c(0x202)];if(config[_0x50ae7c(0x1fd)]){if(!_0x21b2eb)return _0x5c02b5[_0x50ae7c(0x1cc)](0x190)[_0x50ae7c(0x1b8)]({'error':_0x50ae7c(0x1f7)});try{const _0x541dd1=await axios['post']('https://www.google.com/recaptcha/api/siteverify',null,{'params':{'secret':config[_0x50ae7c(0x1f2)],'response':_0x21b2eb}});if(!_0x541dd1[_0x50ae7c(0x209)][_0x50ae7c(0x1eb)])return _0x5c02b5['status'](0x190)[_0x50ae7c(0x1b8)]({'error':_0x50ae7c(0x1f7),'recaptchaErrors':_0x541dd1[_0x50ae7c(0x209)]['error-codes']});}catch(_0x62c593){return console[_0x50ae7c(0x1d6)](_0x50ae7c(0x1b4),_0x62c593),_0x5c02b5[_0x50ae7c(0x1cc)](0x1f4)[_0x50ae7c(0x1b8)]({'error':_0x50ae7c(0x1e9)});}}const [_0x1e2b10]=await conn[_0x50ae7c(0x1bb)]()[_0x50ae7c(0x1d0)](_0x50ae7c(0x1b3),[_0x57c494]);if(_0x1e2b10['length']>0x0){_0x5c02b5[_0x50ae7c(0x1cc)](0x1a6)[_0x50ae7c(0x1b8)]({'error':_0x50ae7c(0x204)});return;}const _0x3e9ab1=await bcrypt[_0x50ae7c(0x1c2)](_0x47af65,0xa);let _0x426ff3=null,_0xa9bb37=0x1;config[_0x50ae7c(0x1ea)]&&(_0x426ff3=randomUUID(),_0xa9bb37=0x0);let _0x4815bb=null,_0x495299=null,_0x39d7e1=null,_0x56ab2a=null,_0x4ac760=null,_0x436d37=null;if(_0x124236)try{const _0xf3346=_0x124236;_0x4815bb=_0xf3346[_0x50ae7c(0x20b)]||null,_0x495299=_0xf3346[_0x50ae7c(0x1c4)]||null,_0x39d7e1=_0xf3346[_0x50ae7c(0x1e3)]||null,_0xf3346[_0x50ae7c(0x1b6)]&&_0xf3346['languages'][_0x50ae7c(0x1c5)]>0x0&&(_0x56ab2a=_0xf3346['languages'][0x0][_0x50ae7c(0x1db)]||null,_0x4ac760=_0xf3346[_0x50ae7c(0x1b6)][0x0][_0x50ae7c(0x1e6)]||null),_0xf3346['time_zone']&&(_0x436d37=_0xf3346['time_zone'][_0x50ae7c(0x1e6)]||null);}catch(_0x21ffe7){console[_0x50ae7c(0x1d3)](_0x50ae7c(0x1ca),_0x21ffe7);}let _0x3512a5;try{const _0x8db14=randomUUID(),_0x20cf1e=_0x50ae7c(0x1f5)+_0x8db14;fs[_0x50ae7c(0x1e4)](_0x20cf1e);const [_0x1e2e21]=await conn[_0x50ae7c(0x1bb)]()[_0x50ae7c(0x1d0)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x393c5b,_0x57c494,_0x3e9ab1,'demo_user',_0xa9bb37,_0x426ff3,_0x8db14,_0x4815bb,_0x495299,_0x39d7e1,_0x56ab2a,_0x4ac760,_0x436d37]);if(_0x1e2e21[_0x50ae7c(0x1ed)]){const [_0x13aff6]=await conn[_0x50ae7c(0x1bb)]()[_0x50ae7c(0x1d0)](_0x50ae7c(0x1ef),[_0x1e2e21[_0x50ae7c(0x1ed)]]);_0x13aff6[_0x50ae7c(0x1c5)]>0x0&&(_0x3512a5=_0x13aff6[0x0]);}}catch(_0x2ff44c){console[_0x50ae7c(0x1d3)](_0x50ae7c(0x1b7),_0x2ff44c),_0x5c02b5[_0x50ae7c(0x1cc)](0x1f4)[_0x50ae7c(0x1b8)]({'error':_0x50ae7c(0x1f3)});return;}let _0x44dbb6;try{_0x44dbb6=jwt['sign']({'userId':_0x3512a5['id'],'email':_0x3512a5[_0x50ae7c(0x1dd)]},config[_0x50ae7c(0x1c9)],{'expiresIn':_0x50ae7c(0x1f0)});}catch(_0x3edaef){_0x5c02b5[_0x50ae7c(0x1cc)](0x1f4)[_0x50ae7c(0x1b8)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(config[_0x50ae7c(0x1ea)]){try{await sendWelcomeEmail(_0x3512a5,_0x426ff3);}catch(_0x20cda){console[_0x50ae7c(0x1d3)](_0x50ae7c(0x20a)),console[_0x50ae7c(0x1d3)](_0x20cda);}_0x5c02b5[_0x50ae7c(0x1cc)](0xc8)[_0x50ae7c(0x1b8)]({'success':!![],'message':_0x50ae7c(0x20c)});return;}_0x5c02b5[_0x50ae7c(0x1cc)](0xc9)[_0x50ae7c(0x1b8)]({'success':!![],'data':{'userId':_0x3512a5['id'],'username':_0x3512a5[_0x50ae7c(0x1c8)],'first_name':_0x3512a5[_0x50ae7c(0x1ec)],'last_name':_0x3512a5['last_name'],'email':_0x3512a5[_0x50ae7c(0x1dd)],'avatar_url':_0x3512a5[_0x50ae7c(0x1c0)],'id':_0x3512a5['id'],'role':_0x3512a5[_0x50ae7c(0x1fb)],'token':_0x44dbb6,'is_enabled':_0x3512a5['is_enabled']}});}),router[a1_0x58d753(0x1b2)](a1_0x58d753(0x1de),async(_0x1908ea,_0x523061)=>{const _0x37d209=a1_0x58d753;try{const {token:_0x3904ee}=_0x1908ea[_0x37d209(0x1d4)],[_0x12c48a]=await conn[_0x37d209(0x1bb)]()[_0x37d209(0x1d0)](_0x37d209(0x1f9),[_0x3904ee]);if(_0x12c48a[_0x37d209(0x1c5)]===0x0){_0x523061[_0x37d209(0x1cc)](0x194)[_0x37d209(0x1b8)]({'error':_0x37d209(0x1e7)});return;}await conn[_0x37d209(0x1bb)]()[_0x37d209(0x1d0)](_0x37d209(0x1c7),[_0x3904ee]);const _0x502512=jwt[_0x37d209(0x1c3)]({'id':_0x12c48a[0x0]['id'],'email':_0x12c48a[0x0][_0x37d209(0x1dd)]},config['jwtSecretKey'],{'expiresIn':'24h'});_0x523061['status'](0xc8)[_0x37d209(0x1b8)]({'success':!![],'message':_0x37d209(0x200),'data':{'userId':_0x12c48a[0x0]['id'],'username':_0x12c48a[0x0][_0x37d209(0x1c8)],'first_name':_0x12c48a[0x0]['first_name'],'last_name':_0x12c48a[0x0]['last_name'],'email':_0x12c48a[0x0][_0x37d209(0x1dd)],'avatar_url':_0x12c48a[0x0][_0x37d209(0x1c0)],'id':_0x12c48a[0x0]['id'],'role':_0x12c48a[0x0]['role'],'token':_0x502512,'is_enabled':0x1}});}catch(_0x233ec5){console[_0x37d209(0x1d3)]('===================error==================='),console[_0x37d209(0x1d3)](_0x233ec5),_0x523061[_0x37d209(0x1cc)](0x1f4)['json']({'error':_0x37d209(0x1f3),'stack':_0x233ec5[_0x37d209(0x1f1)],'message':_0x233ec5[_0x37d209(0x1bc)]});}}),router[a1_0x58d753(0x1b2)](a1_0x58d753(0x1f6),verifyToken,async(_0x170c21,_0x6a6ba3,_0x24981d)=>{const _0x1853ff=a1_0x58d753,{current_password:_0x32d84c,new_password:_0x341443}=_0x170c21['body'];console[_0x1853ff(0x1d3)]({'body':_0x170c21['body']});const _0x4b61c5=_0x170c21['user'][_0x1853ff(0x1dd)];let _0xbd3ec2;try{const [_0x402897]=await conn[_0x1853ff(0x1bb)]()[_0x1853ff(0x1d0)](_0x1853ff(0x1b3),[_0x4b61c5]);if(_0x402897[_0x1853ff(0x1c5)]>0x0){_0xbd3ec2=_0x402897[0x0];if(!await bcrypt[_0x1853ff(0x1d9)](_0x32d84c,_0xbd3ec2[_0x1853ff(0x20d)])){_0x6a6ba3['status'](0x191)[_0x1853ff(0x1b8)]({'error':_0x1853ff(0x1d2)});return;}const _0x250430=await bcrypt['hash'](_0x341443,0xa);await conn['promise']()[_0x1853ff(0x1d0)](_0x1853ff(0x1d8),[_0x250430,_0x4b61c5]),_0x6a6ba3['status'](0xc8)[_0x1853ff(0x1b8)]({'success':!![]});}}catch(_0x33fabc){console[_0x1853ff(0x1d3)]({'err':_0x33fabc}),_0x6a6ba3[_0x1853ff(0x1cc)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x58d753(0x1b2)](a1_0x58d753(0x1e1),upload['single'](a1_0x58d753(0x1d1)),verifyToken,async(_0x31b687,_0x58e776,_0x287b13)=>{const _0xc51f91=a1_0x58d753,{username:_0x3d853d,first_name:_0x4197a0,last_name:_0x408dac}=_0x31b687[_0xc51f91(0x202)],_0x152f9c=_0x31b687[_0xc51f91(0x1c6)]['email'];let _0x302588;try{const [_0x2988e5]=await conn[_0xc51f91(0x1bb)]()[_0xc51f91(0x1d0)](_0xc51f91(0x1b3),[_0x152f9c]);_0x2988e5[_0xc51f91(0x1c5)]>0x0&&(_0x302588=_0x2988e5[0x0]);}catch(_0x5d597c){console[_0xc51f91(0x1d3)]({'err':_0x5d597c}),_0x58e776['status'](0x1f4)[_0xc51f91(0x1b8)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x302588){_0x58e776[_0xc51f91(0x1cc)](0x191)[_0xc51f91(0x1b8)]({'error':_0xc51f91(0x1e2)});return;}console[_0xc51f91(0x1d3)]({'req':_0x31b687[_0xc51f91(0x202)]});let _0x410b65=_0x302588[_0xc51f91(0x1c0)];if(_0x31b687[_0xc51f91(0x1ee)]){const _0x6b69ec=_0xc51f91(0x1b9)+randomUUID()+_0xc51f91(0x1ce);fs['copyFileSync'](_0x31b687[_0xc51f91(0x1ee)][_0xc51f91(0x1f4)],'./'+_0x6b69ec),fs[_0xc51f91(0x1d5)](_0x31b687['file'][_0xc51f91(0x1f4)]),config[_0xc51f91(0x1dc)]?_0x410b65=config[_0xc51f91(0x1b5)]+'/'+_0x6b69ec:_0x410b65=config['ServerUrl']+'/'+_0x6b69ec;}try{await conn[_0xc51f91(0x1bb)]()[_0xc51f91(0x1d0)](_0xc51f91(0x1c1),[_0x3d853d,_0x4197a0,_0x408dac,_0x410b65,_0x152f9c]);let _0x5f2b84;try{_0x5f2b84=jwt[_0xc51f91(0x1c3)]({'userId':_0x302588['id'],'email':_0x302588[_0xc51f91(0x1dd)]},config[_0xc51f91(0x1c9)],{'expiresIn':_0xc51f91(0x1f0)});}catch(_0x2934b5){console[_0xc51f91(0x1d3)](_0x2934b5),_0x58e776[_0xc51f91(0x1cc)](0x1f4)['json']({'error':_0xc51f91(0x1f3)});return;}_0x58e776[_0xc51f91(0x1cc)](0xc8)[_0xc51f91(0x1b8)]({'success':!![],'data':{'userId':_0x302588['id'],'username':_0x3d853d,'first_name':_0x4197a0,'last_name':_0x408dac,'email':_0x302588[_0xc51f91(0x1dd)],'avatar_url':_0x410b65,'token':_0x5f2b84}});}catch(_0x3a492f){console['log']({'err':_0x3a492f}),_0x58e776['status'](0x1f4)[_0xc51f91(0x1b8)]({'error':_0xc51f91(0x1f3)});return;}}),module['exports']=router;