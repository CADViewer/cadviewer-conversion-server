const a1_0x267921=a1_0x5983;(function(_0x3e1938,_0x5a72ed){const _0x60d71=a1_0x5983,_0x4e9f9f=_0x3e1938();while(!![]){try{const _0xe09929=parseInt(_0x60d71(0x1f0))/0x1*(-parseInt(_0x60d71(0x1cb))/0x2)+parseInt(_0x60d71(0x1d2))/0x3*(parseInt(_0x60d71(0x1ff))/0x4)+parseInt(_0x60d71(0x207))/0x5+parseInt(_0x60d71(0x1ef))/0x6+parseInt(_0x60d71(0x20e))/0x7+parseInt(_0x60d71(0x1e5))/0x8+parseInt(_0x60d71(0x1d9))/0x9*(-parseInt(_0x60d71(0x215))/0xa);if(_0xe09929===_0x5a72ed)break;else _0x4e9f9f['push'](_0x4e9f9f['shift']());}catch(_0x32d719){_0x4e9f9f['push'](_0x4e9f9f['shift']());}}}(a1_0x65ed,0x26bfb));const jwt=require(a1_0x267921(0x1d1)),bcrypt=require('bcrypt'),config=require(a1_0x267921(0x1cf)),conn=require(a1_0x267921(0x1f4)),multer=require('multer'),fs=require('fs'),verifyToken=require(a1_0x267921(0x203))[a1_0x267921(0x20d)],{sendWelcomeEmail}=require('../libs/email-utils'),axios=require('axios');function a1_0x5983(_0x5c0c23,_0x23795a){const _0x65ed0f=a1_0x65ed();return a1_0x5983=function(_0x5983db,_0x5e1e85){_0x5983db=_0x5983db-0x1be;let _0x27812f=_0x65ed0f[_0x5983db];return _0x27812f;},a1_0x5983(_0x5c0c23,_0x23795a);}function a1_0x65ed(){const _0x50f331=['role','error','avatar','execute','https://www.google.com/recaptcha/api/siteverify','avatars','avatar_url','Invalid\x20password','Error\x20during\x20reCAPTCHA\x20verification.','1691272xANfzm','enableEmailVerification','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','email','Error!\x20Something\x20went\x20wrong.','demo_user','sign','existsSync','Email\x20validated\x20successfully','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','1709232YGVAia','5403sWaizK','Invalid\x20email\x20or\x20password','User\x20already\x20exists','.png','../libs/mysql.js','hash','promise','status','first_name','crypted_password','log','user','name','post','Router','60mDXiTs','reCAPTCHA\x20verification\x20error:','time_zone','stack','../libs/jwt','/login','length','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','1257050CytQIm','data','./uploads/','exports','username','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','verifyToken','1554735lfQoHR','insertId','success','/signup','ServerUrl','unlinkSync','./avatars','10VyrmdJ','===================error===================','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','message','Error\x20parsing\x20geolocation\x20data:','crypto','path','/validate-email/:token','json','body','/update-user-info','error-codes','code','Invalid\x20validation\x20token','file','66zjMnjv','callbackMethod_gatewayUrl','languages','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','../CADViewer_config.json','copyFileSync','jsonwebtoken','2619fDjzVd','is_enabled','last_name','avatars/','mkdirSync','recaptchaSecretKey','jwtSecretKey','5812893RAUwrX','24h','compare'];a1_0x65ed=function(){return _0x50f331;};return a1_0x65ed();}!fs[a1_0x267921(0x1ec)](a1_0x267921(0x214))&&fs[a1_0x267921(0x1d6)](a1_0x267921(0x214));const express=require('express'),router=express[a1_0x267921(0x1fe)](),{randomUUID}=require(a1_0x267921(0x1c1)),storage=multer['diskStorage']({'destination':function(_0x57dbb9,_0x358d8d,_0x480153){const _0xa8f941=a1_0x267921;_0x480153(null,_0xa8f941(0x1e1));}}),upload=multer({'storage':storage});router['post'](a1_0x267921(0x204),async(_0x2b52f2,_0x2b2f0b,_0x3c059d)=>{const _0x4d1d60=a1_0x267921;let {email:_0x52f3ce,password:_0xfe0ca1}=_0x2b52f2['body'];console[_0x4d1d60(0x1fa)]({'email':_0x52f3ce,'password':_0xfe0ca1});let _0x2abab4;try{const [_0x526f61]=await conn['promise']()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x52f3ce]);_0x526f61[_0x4d1d60(0x205)]>0x0&&(_0x2abab4=_0x526f61[0x0]);}catch(_0xcc1631){console[_0x4d1d60(0x1fa)]({'err':_0xcc1631}),_0x2b2f0b[_0x4d1d60(0x1f7)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x2abab4||!await bcrypt[_0x4d1d60(0x1db)](_0xfe0ca1,_0x2abab4?.[_0x4d1d60(0x1f9)])){_0x2b2f0b[_0x4d1d60(0x1f7)](0x191)[_0x4d1d60(0x1c4)]({'error':_0x4d1d60(0x1f1)});return;}let _0x47c4d3;try{_0x47c4d3=jwt[_0x4d1d60(0x1eb)]({'userId':_0x2abab4['id'],'email':_0x2abab4[_0x4d1d60(0x1e8)]},config[_0x4d1d60(0x1d8)],{'expiresIn':_0x4d1d60(0x1da)});}catch(_0x46ca8d){console['log'](_0x46ca8d),_0x2b2f0b[_0x4d1d60(0x1f7)](0x1f4)[_0x4d1d60(0x1c4)]({'error':_0x4d1d60(0x1e9)});return;}_0x2b2f0b[_0x4d1d60(0x1f7)](0xc8)[_0x4d1d60(0x1c4)]({'success':!![],'data':{'userId':_0x2abab4['id'],'username':_0x2abab4[_0x4d1d60(0x20b)],'first_name':_0x2abab4[_0x4d1d60(0x1f8)],'last_name':_0x2abab4[_0x4d1d60(0x1d4)],'email':_0x2abab4[_0x4d1d60(0x1e8)],'avatar_url':_0x2abab4[_0x4d1d60(0x1e2)],'id':_0x2abab4['id'],'role':_0x2abab4['role'],'token':_0x47c4d3}});}),router['post'](a1_0x267921(0x211),async(_0x2b6432,_0x4bcdf1,_0x3dd3ff)=>{const _0xeefb4a=a1_0x267921,{username:_0x20db61,email:_0x19b315,password:_0x226ea7,geolocation:_0x109796,recaptchaToken:_0x2ccc39}=_0x2b6432[_0xeefb4a(0x1c5)];if(config['recaptchaEnabled']){if(!_0x2ccc39)return _0x4bcdf1[_0xeefb4a(0x1f7)](0x190)['json']({'error':_0xeefb4a(0x1e7)});try{const _0x1848cb=await axios['post'](_0xeefb4a(0x1e0),null,{'params':{'secret':config[_0xeefb4a(0x1d7)],'response':_0x2ccc39}});if(!_0x1848cb[_0xeefb4a(0x208)][_0xeefb4a(0x210)])return _0x4bcdf1[_0xeefb4a(0x1f7)](0x190)[_0xeefb4a(0x1c4)]({'error':_0xeefb4a(0x1e7),'recaptchaErrors':_0x1848cb['data'][_0xeefb4a(0x1c7)]});}catch(_0x95a962){return console[_0xeefb4a(0x1dd)](_0xeefb4a(0x200),_0x95a962),_0x4bcdf1[_0xeefb4a(0x1f7)](0x1f4)['json']({'error':_0xeefb4a(0x1e4)});}}const [_0x49891c]=await conn[_0xeefb4a(0x1f6)]()[_0xeefb4a(0x1df)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x19b315]);if(_0x49891c[_0xeefb4a(0x205)]>0x0){_0x4bcdf1[_0xeefb4a(0x1f7)](0x1a6)[_0xeefb4a(0x1c4)]({'error':_0xeefb4a(0x1f2)});return;}const _0x120dde=await bcrypt[_0xeefb4a(0x1f5)](_0x226ea7,0xa);let _0x29f9a2=null,_0x5c76c1=0x1;config[_0xeefb4a(0x1e6)]&&(_0x29f9a2=randomUUID(),_0x5c76c1=0x0);let _0x2a4a0d=null,_0x1c822=null,_0x4324e7=null,_0x5e149d=null,_0xfdebae=null,_0x4fec3b=null;if(_0x109796)try{const _0x4b684a=_0x109796;_0x2a4a0d=_0x4b684a['city']||null,_0x1c822=_0x4b684a['region']||null,_0x4324e7=_0x4b684a['country_name']||null,_0x4b684a[_0xeefb4a(0x1cd)]&&_0x4b684a['languages']['length']>0x0&&(_0x5e149d=_0x4b684a[_0xeefb4a(0x1cd)][0x0][_0xeefb4a(0x1c8)]||null,_0xfdebae=_0x4b684a[_0xeefb4a(0x1cd)][0x0][_0xeefb4a(0x1fc)]||null),_0x4b684a['time_zone']&&(_0x4fec3b=_0x4b684a[_0xeefb4a(0x201)][_0xeefb4a(0x1fc)]||null);}catch(_0x402356){console['log'](_0xeefb4a(0x1c0),_0x402356);}let _0x3e9811;try{const _0x50ef87=randomUUID(),_0x54726f=_0xeefb4a(0x209)+_0x50ef87;fs[_0xeefb4a(0x1d6)](_0x54726f);const [_0x30f7ff]=await conn['promise']()[_0xeefb4a(0x1df)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x20db61,_0x19b315,_0x120dde,_0xeefb4a(0x1ea),_0x5c76c1,_0x29f9a2,_0x50ef87,_0x2a4a0d,_0x1c822,_0x4324e7,_0x5e149d,_0xfdebae,_0x4fec3b]);if(_0x30f7ff[_0xeefb4a(0x20f)]){const [_0x41c094]=await conn[_0xeefb4a(0x1f6)]()[_0xeefb4a(0x1df)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x30f7ff['insertId']]);_0x41c094[_0xeefb4a(0x205)]>0x0&&(_0x3e9811=_0x41c094[0x0]);}}catch(_0xdfce88){console[_0xeefb4a(0x1fa)]('Error\x20during\x20user\x20creation:',_0xdfce88),_0x4bcdf1['status'](0x1f4)[_0xeefb4a(0x1c4)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}let _0x542395;try{_0x542395=jwt[_0xeefb4a(0x1eb)]({'userId':_0x3e9811['id'],'email':_0x3e9811[_0xeefb4a(0x1e8)]},config['jwtSecretKey'],{'expiresIn':_0xeefb4a(0x1da)});}catch(_0x4e3821){_0x4bcdf1['status'](0x1f4)['json']({'error':_0xeefb4a(0x1e9)});return;}if(config[_0xeefb4a(0x1e6)]){try{await sendWelcomeEmail(_0x3e9811,_0x29f9a2);}catch(_0x200200){console[_0xeefb4a(0x1fa)](_0xeefb4a(0x216)),console['log'](_0x200200);}_0x4bcdf1[_0xeefb4a(0x1f7)](0xc8)['json']({'success':!![],'message':_0xeefb4a(0x1ce)});return;}_0x4bcdf1[_0xeefb4a(0x1f7)](0xc9)[_0xeefb4a(0x1c4)]({'success':!![],'data':{'userId':_0x3e9811['id'],'username':_0x3e9811[_0xeefb4a(0x20b)],'first_name':_0x3e9811[_0xeefb4a(0x1f8)],'last_name':_0x3e9811[_0xeefb4a(0x1d4)],'email':_0x3e9811[_0xeefb4a(0x1e8)],'avatar_url':_0x3e9811[_0xeefb4a(0x1e2)],'id':_0x3e9811['id'],'role':_0x3e9811['role'],'token':_0x542395,'is_enabled':_0x3e9811[_0xeefb4a(0x1d3)]}});}),router[a1_0x267921(0x1fd)](a1_0x267921(0x1c3),async(_0x4b74de,_0x10de6a)=>{const _0x2de1b1=a1_0x267921;try{const {token:_0x217b43}=_0x4b74de['params'],[_0x3c5b4e]=await conn[_0x2de1b1(0x1f6)]()[_0x2de1b1(0x1df)](_0x2de1b1(0x1ee),[_0x217b43]);if(_0x3c5b4e['length']===0x0){_0x10de6a[_0x2de1b1(0x1f7)](0x194)['json']({'error':_0x2de1b1(0x1c9)});return;}await conn['promise']()[_0x2de1b1(0x1df)](_0x2de1b1(0x206),[_0x217b43]);const _0x343c0b=jwt['sign']({'id':_0x3c5b4e[0x0]['id'],'email':_0x3c5b4e[0x0]['email']},config[_0x2de1b1(0x1d8)],{'expiresIn':_0x2de1b1(0x1da)});_0x10de6a[_0x2de1b1(0x1f7)](0xc8)['json']({'success':!![],'message':_0x2de1b1(0x1ed),'data':{'userId':_0x3c5b4e[0x0]['id'],'username':_0x3c5b4e[0x0][_0x2de1b1(0x20b)],'first_name':_0x3c5b4e[0x0]['first_name'],'last_name':_0x3c5b4e[0x0][_0x2de1b1(0x1d4)],'email':_0x3c5b4e[0x0][_0x2de1b1(0x1e8)],'avatar_url':_0x3c5b4e[0x0][_0x2de1b1(0x1e2)],'id':_0x3c5b4e[0x0]['id'],'role':_0x3c5b4e[0x0][_0x2de1b1(0x1dc)],'token':_0x343c0b,'is_enabled':0x1}});}catch(_0x580d57){console[_0x2de1b1(0x1fa)](_0x2de1b1(0x216)),console[_0x2de1b1(0x1fa)](_0x580d57),_0x10de6a[_0x2de1b1(0x1f7)](0x1f4)[_0x2de1b1(0x1c4)]({'error':_0x2de1b1(0x1e9),'stack':_0x580d57[_0x2de1b1(0x202)],'message':_0x580d57[_0x2de1b1(0x1bf)]});}}),router['post']('/update-password',verifyToken,async(_0x32bbf3,_0x2f8b69,_0x1616a8)=>{const _0x1b79e2=a1_0x267921,{current_password:_0x1f7b56,new_password:_0x13817c}=_0x32bbf3['body'];console['log']({'body':_0x32bbf3['body']});const _0x35a616=_0x32bbf3[_0x1b79e2(0x1fb)][_0x1b79e2(0x1e8)];let _0x1667b7;try{const [_0xcd413e]=await conn[_0x1b79e2(0x1f6)]()[_0x1b79e2(0x1df)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x35a616]);if(_0xcd413e[_0x1b79e2(0x205)]>0x0){_0x1667b7=_0xcd413e[0x0];if(!await bcrypt['compare'](_0x1f7b56,_0x1667b7[_0x1b79e2(0x1f9)])){_0x2f8b69['status'](0x191)[_0x1b79e2(0x1c4)]({'error':_0x1b79e2(0x1e3)});return;}const _0x5df86c=await bcrypt[_0x1b79e2(0x1f5)](_0x13817c,0xa);await conn[_0x1b79e2(0x1f6)]()[_0x1b79e2(0x1df)](_0x1b79e2(0x20c),[_0x5df86c,_0x35a616]),_0x2f8b69[_0x1b79e2(0x1f7)](0xc8)[_0x1b79e2(0x1c4)]({'success':!![]});}}catch(_0x502e55){console['log']({'err':_0x502e55}),_0x2f8b69[_0x1b79e2(0x1f7)](0x1f4)[_0x1b79e2(0x1c4)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x267921(0x1fd)](a1_0x267921(0x1c6),upload['single'](a1_0x267921(0x1de)),verifyToken,async(_0x3d6b16,_0x5d0320,_0x552555)=>{const _0x9bbab2=a1_0x267921,{username:_0x2b3ac4,first_name:_0x5799d3,last_name:_0x382893}=_0x3d6b16['body'],_0x102c43=_0x3d6b16[_0x9bbab2(0x1fb)][_0x9bbab2(0x1e8)];let _0x3125e2;try{const [_0x286482]=await conn[_0x9bbab2(0x1f6)]()[_0x9bbab2(0x1df)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x102c43]);_0x286482['length']>0x0&&(_0x3125e2=_0x286482[0x0]);}catch(_0x113089){console[_0x9bbab2(0x1fa)]({'err':_0x113089}),_0x5d0320[_0x9bbab2(0x1f7)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x3125e2){_0x5d0320[_0x9bbab2(0x1f7)](0x191)[_0x9bbab2(0x1c4)]({'error':'Invalid\x20user'});return;}console[_0x9bbab2(0x1fa)]({'req':_0x3d6b16[_0x9bbab2(0x1c5)]});let _0x3a0f37=_0x3125e2[_0x9bbab2(0x1e2)];if(_0x3d6b16[_0x9bbab2(0x1ca)]){const _0xb9294=_0x9bbab2(0x1d5)+randomUUID()+_0x9bbab2(0x1f3);fs[_0x9bbab2(0x1d0)](_0x3d6b16[_0x9bbab2(0x1ca)]['path'],'./'+_0xb9294),fs[_0x9bbab2(0x213)](_0x3d6b16[_0x9bbab2(0x1ca)][_0x9bbab2(0x1c2)]),config['callbackMethod_gatewayUrl_flag']?_0x3a0f37=config[_0x9bbab2(0x1cc)]+'/'+_0xb9294:_0x3a0f37=config[_0x9bbab2(0x212)]+'/'+_0xb9294;}try{await conn[_0x9bbab2(0x1f6)]()['execute'](_0x9bbab2(0x1be),[_0x2b3ac4,_0x5799d3,_0x382893,_0x3a0f37,_0x102c43]);let _0x5965ea;try{_0x5965ea=jwt[_0x9bbab2(0x1eb)]({'userId':_0x3125e2['id'],'email':_0x3125e2['email']},config[_0x9bbab2(0x1d8)],{'expiresIn':'24h'});}catch(_0x3204d4){console['log'](_0x3204d4),_0x5d0320[_0x9bbab2(0x1f7)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x5d0320[_0x9bbab2(0x1f7)](0xc8)[_0x9bbab2(0x1c4)]({'success':!![],'data':{'userId':_0x3125e2['id'],'username':_0x2b3ac4,'first_name':_0x5799d3,'last_name':_0x382893,'email':_0x3125e2[_0x9bbab2(0x1e8)],'avatar_url':_0x3a0f37,'token':_0x5965ea}});}catch(_0x8a444c){console[_0x9bbab2(0x1fa)]({'err':_0x8a444c}),_0x5d0320['status'](0x1f4)[_0x9bbab2(0x1c4)]({'error':_0x9bbab2(0x1e9)});return;}}),module[a1_0x267921(0x20a)]=router;