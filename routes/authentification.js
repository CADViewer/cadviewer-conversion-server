const a1_0xdf1edf=a1_0xefee;(function(_0x96392,_0x407d3c){const _0x421b68=a1_0xefee,_0x1f0121=_0x96392();while(!![]){try{const _0x2a6762=-parseInt(_0x421b68(0xe2))/0x1+parseInt(_0x421b68(0xe6))/0x2+parseInt(_0x421b68(0x106))/0x3+parseInt(_0x421b68(0x10b))/0x4*(-parseInt(_0x421b68(0xf8))/0x5)+parseInt(_0x421b68(0x116))/0x6+parseInt(_0x421b68(0x100))/0x7*(parseInt(_0x421b68(0xe8))/0x8)+-parseInt(_0x421b68(0xeb))/0x9;if(_0x2a6762===_0x407d3c)break;else _0x1f0121['push'](_0x1f0121['shift']());}catch(_0x13f6a2){_0x1f0121['push'](_0x1f0121['shift']());}}}(a1_0x2735,0xdee84));const jwt=require(a1_0xdf1edf(0x109)),bcrypt=require(a1_0xdf1edf(0x121)),config=require(a1_0xdf1edf(0xdb)),conn=require(a1_0xdf1edf(0x122)),multer=require(a1_0xdf1edf(0x11a)),fs=require('fs'),verifyToken=require('../libs/jwt')[a1_0xdf1edf(0x123)];!fs[a1_0xdf1edf(0x114)]('./avatars')&&fs[a1_0xdf1edf(0x12d)](a1_0xdf1edf(0x101));function a1_0xefee(_0x12f52a,_0x1b8292){const _0x27357c=a1_0x2735();return a1_0xefee=function(_0xefee8f,_0x3984f0){_0xefee8f=_0xefee8f-0xda;let _0x18ec86=_0x27357c[_0xefee8f];return _0x18ec86;},a1_0xefee(_0x12f52a,_0x1b8292);}const express=require(a1_0xdf1edf(0x124)),router=express[a1_0xdf1edf(0xf3)](),{randomUUID}=require(a1_0xdf1edf(0x10a)),storage=multer[a1_0xdf1edf(0xdc)]({'destination':function(_0x836978,_0x2f7da9,_0x3d62c9){_0x3d62c9(null,'avatars');}}),upload=multer({'storage':storage});function a1_0x2735(){const _0x27fe5b=['first_name','4653528FuVxQb','compare','Invalid\x20password','jsonwebtoken','crypto','4qpaURL','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','/update-password','ServerUrl','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','post','<p>Welcome\x20to\x20CADViewer</p>','enableEmailVerification','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','existsSync','params','2738040MKZJJp','avatars/','sendMail','body','multer','frontendUrl','promise','status','avatar','/validate-email/:token','file','bcrypt','../libs/mysql.js','verifyToken','express','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','hash','log','./uploads/','execute','Error!\x20Something\x20went\x20wrong.','role','Invalid\x20validation\x20token','mkdirSync','24h','../CADViewer_config.json','diskStorage','user','transporter','username','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','/signup','941774haFqle','insertId','Email\x20validated\x20successfully','Invalid\x20email\x20or\x20password','1568242ZXpgas','Welcome\x20to\x20CADViewer','13771928tJMkXz','demo_user','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','12913731GPwLjp','message','.png','last_name','smtpFrom','is_enabled','path','avatar_url','Router','json','stack','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','/login','6117335FowmcF','sign','===================error===================','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','/validate-email/','crypted_password','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20','length','7qBlnUi','./avatars','jwtSecretKey','single','email'];a1_0x2735=function(){return _0x27fe5b;};return a1_0x2735();}router[a1_0xdf1edf(0x110)](a1_0xdf1edf(0xf7),async(_0x3d46ea,_0x95764b,_0x1e8282)=>{const _0x3d27bf=a1_0xdf1edf;let {email:_0x4e0f83,password:_0x2924b6}=_0x3d46ea[_0x3d27bf(0x119)];console[_0x3d27bf(0x127)]({'email':_0x4e0f83,'password':_0x2924b6});let _0x52ace8;try{const [_0x4e1228]=await conn[_0x3d27bf(0x11c)]()[_0x3d27bf(0x129)](_0x3d27bf(0x10f),[_0x4e0f83]);_0x4e1228[_0x3d27bf(0xff)]>0x0&&(_0x52ace8=_0x4e1228[0x0]);}catch(_0x47a608){console[_0x3d27bf(0x127)]({'err':_0x47a608}),_0x95764b[_0x3d27bf(0x11d)](0x1f4)[_0x3d27bf(0xf4)]({'error':_0x3d27bf(0x12a)});return;}if(!_0x52ace8||!await bcrypt[_0x3d27bf(0x107)](_0x2924b6,_0x52ace8?.[_0x3d27bf(0xfd)])){_0x95764b[_0x3d27bf(0x11d)](0x191)[_0x3d27bf(0xf4)]({'error':_0x3d27bf(0xe5)});return;}let _0xc9592b;try{_0xc9592b=jwt[_0x3d27bf(0xf9)]({'userId':_0x52ace8['id'],'email':_0x52ace8['email']},config[_0x3d27bf(0x102)],{'expiresIn':_0x3d27bf(0xda)});}catch(_0x4aa06a){console['log'](_0x4aa06a),_0x95764b['status'](0x1f4)[_0x3d27bf(0xf4)]({'error':_0x3d27bf(0x12a)});return;}_0x95764b[_0x3d27bf(0x11d)](0xc8)[_0x3d27bf(0xf4)]({'success':!![],'data':{'userId':_0x52ace8['id'],'username':_0x52ace8[_0x3d27bf(0xdf)],'first_name':_0x52ace8[_0x3d27bf(0x105)],'last_name':_0x52ace8[_0x3d27bf(0xee)],'email':_0x52ace8[_0x3d27bf(0x104)],'avatar_url':_0x52ace8[_0x3d27bf(0xf2)],'id':_0x52ace8['id'],'role':_0x52ace8['role'],'token':_0xc9592b}});}),router['post'](a1_0xdf1edf(0xe1),async(_0x16052a,_0x178ba9,_0x41ad0a)=>{const _0x18ceb7=a1_0xdf1edf,{username:_0x176701,email:_0x39794e,password:_0x2bb460}=_0x16052a[_0x18ceb7(0x119)],[_0x25843a]=await conn[_0x18ceb7(0x11c)]()[_0x18ceb7(0x129)](_0x18ceb7(0x125),[_0x39794e]);if(_0x25843a[_0x18ceb7(0xff)]>0x0){_0x178ba9[_0x18ceb7(0x11d)](0x1a6)['json']({'error':'User\x20already\x20exists'});return;}const _0x9db2fe=await bcrypt[_0x18ceb7(0x126)](_0x2bb460,0xa);let _0x10eea7=null,_0x37c124=0x1;config[_0x18ceb7(0x112)]&&(_0x10eea7=randomUUID(),_0x37c124=0x0);let _0x1a2c55;try{const _0x292c1a=randomUUID(),_0x4d5d6c=_0x18ceb7(0x128)+_0x292c1a;fs[_0x18ceb7(0x12d)](_0x4d5d6c);const [_0x56ef9b]=await conn['promise']()[_0x18ceb7(0x129)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)',[_0x176701,_0x39794e,_0x9db2fe,_0x18ceb7(0xe9),_0x37c124,_0x10eea7,_0x292c1a]);if(_0x56ef9b[_0x18ceb7(0xe3)]){const [_0x37812e]=await conn['promise']()['execute'](_0x18ceb7(0xfb),[_0x56ef9b['insertId']]);_0x37812e[_0x18ceb7(0xff)]>0x0&&(_0x1a2c55=_0x37812e[0x0]);}}catch{_0x178ba9[_0x18ceb7(0x11d)](0x1f4)['json']({'error':_0x18ceb7(0x12a)});return;}let _0x54542f;try{_0x54542f=jwt['sign']({'userId':_0x1a2c55['id'],'email':_0x1a2c55[_0x18ceb7(0x104)]},config[_0x18ceb7(0x102)],{'expiresIn':_0x18ceb7(0xda)});}catch(_0x944318){_0x178ba9[_0x18ceb7(0x11d)](0x1f4)[_0x18ceb7(0xf4)]({'error':_0x18ceb7(0x12a)});return;}const _0x44d659=require('../libs/mail')[_0x18ceb7(0xde)];let _0x3c3d29=_0x18ceb7(0x111);if(config[_0x18ceb7(0x112)]){const _0x39ea4b=config[_0x18ceb7(0x11b)]+_0x18ceb7(0xfc)+_0x10eea7;_0x3c3d29='\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22'+_0x39ea4b+_0x18ceb7(0xf6)+_0x39ea4b+_0x18ceb7(0xfe);const _0x146028={'from':config[_0x18ceb7(0xef)],'to':_0x1a2c55[_0x18ceb7(0x104)],'subject':_0x18ceb7(0xe7),'text':_0x18ceb7(0xe7),'html':_0x3c3d29};try{await _0x44d659[_0x18ceb7(0x118)](_0x146028);}catch(_0xf1070a){console['log'](_0x18ceb7(0xfa)),console['log'](_0xf1070a),_0x178ba9['status'](0x1f4)[_0x18ceb7(0xf4)]({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0xf1070a[_0x18ceb7(0xf5)],'message':_0xf1070a[_0x18ceb7(0xec)]});return;}_0x178ba9[_0x18ceb7(0x11d)](0xc8)['json']({'success':!![],'message':'Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account'});return;}_0x178ba9[_0x18ceb7(0x11d)](0xc9)[_0x18ceb7(0xf4)]({'success':!![],'data':{'userId':_0x1a2c55['id'],'username':_0x1a2c55[_0x18ceb7(0xdf)],'first_name':_0x1a2c55[_0x18ceb7(0x105)],'last_name':_0x1a2c55[_0x18ceb7(0xee)],'email':_0x1a2c55[_0x18ceb7(0x104)],'avatar_url':_0x1a2c55[_0x18ceb7(0xf2)],'id':_0x1a2c55['id'],'role':_0x1a2c55[_0x18ceb7(0x12b)],'token':_0x54542f,'is_enabled':_0x1a2c55[_0x18ceb7(0xf0)]}});}),router['post'](a1_0xdf1edf(0x11f),async(_0x5de1f8,_0x2722a0)=>{const _0x8b7ccf=a1_0xdf1edf;try{const {token:_0x47bb23}=_0x5de1f8[_0x8b7ccf(0x115)],[_0x1774b5]=await conn[_0x8b7ccf(0x11c)]()['execute'](_0x8b7ccf(0x10c),[_0x47bb23]);if(_0x1774b5['length']===0x0){_0x2722a0[_0x8b7ccf(0x11d)](0x194)['json']({'error':_0x8b7ccf(0x12c)});return;}await conn['promise']()[_0x8b7ccf(0x129)](_0x8b7ccf(0xe0),[_0x47bb23]);const _0x5d381d=jwt[_0x8b7ccf(0xf9)]({'id':_0x1774b5[0x0]['id'],'email':_0x1774b5[0x0][_0x8b7ccf(0x104)]},config['jwtSecretKey'],{'expiresIn':_0x8b7ccf(0xda)});_0x2722a0[_0x8b7ccf(0x11d)](0xc8)[_0x8b7ccf(0xf4)]({'success':!![],'message':_0x8b7ccf(0xe4),'data':{'userId':_0x1774b5[0x0]['id'],'username':_0x1774b5[0x0]['username'],'first_name':_0x1774b5[0x0][_0x8b7ccf(0x105)],'last_name':_0x1774b5[0x0]['last_name'],'email':_0x1774b5[0x0]['email'],'avatar_url':_0x1774b5[0x0][_0x8b7ccf(0xf2)],'id':_0x1774b5[0x0]['id'],'role':_0x1774b5[0x0][_0x8b7ccf(0x12b)],'token':_0x5d381d,'is_enabled':0x1}});}catch(_0x477d6a){console[_0x8b7ccf(0x127)](_0x8b7ccf(0xfa)),console[_0x8b7ccf(0x127)](_0x477d6a),_0x2722a0['status'](0x1f4)[_0x8b7ccf(0xf4)]({'error':_0x8b7ccf(0x12a),'stack':_0x477d6a[_0x8b7ccf(0xf5)],'message':_0x477d6a[_0x8b7ccf(0xec)]});}}),router['post'](a1_0xdf1edf(0x10d),verifyToken,async(_0x5210be,_0x43806e,_0x4b96b3)=>{const _0x22bfec=a1_0xdf1edf,{current_password:_0x47de27,new_password:_0x21f0bf}=_0x5210be[_0x22bfec(0x119)];console[_0x22bfec(0x127)]({'body':_0x5210be['body']});const _0xff20fe=_0x5210be[_0x22bfec(0xdd)]['email'];let _0x3ddcd0;try{const [_0x167572]=await conn[_0x22bfec(0x11c)]()[_0x22bfec(0x129)](_0x22bfec(0x125),[_0xff20fe]);if(_0x167572[_0x22bfec(0xff)]>0x0){_0x3ddcd0=_0x167572[0x0];if(!await bcrypt[_0x22bfec(0x107)](_0x47de27,_0x3ddcd0[_0x22bfec(0xfd)])){_0x43806e['status'](0x191)[_0x22bfec(0xf4)]({'error':_0x22bfec(0x108)});return;}const _0x70eafe=await bcrypt['hash'](_0x21f0bf,0xa);await conn[_0x22bfec(0x11c)]()[_0x22bfec(0x129)](_0x22bfec(0xea),[_0x70eafe,_0xff20fe]),_0x43806e[_0x22bfec(0x11d)](0xc8)['json']({'success':!![]});}}catch(_0x483b5f){console[_0x22bfec(0x127)]({'err':_0x483b5f}),_0x43806e[_0x22bfec(0x11d)](0x1f4)['json']({'error':_0x22bfec(0x12a)});return;}}),router['post']('/update-user-info',upload[a1_0xdf1edf(0x103)](a1_0xdf1edf(0x11e)),verifyToken,async(_0x16a828,_0x512d9e,_0xf54ab)=>{const _0x26973c=a1_0xdf1edf,{username:_0x98d022,first_name:_0x44cf20,last_name:_0x2ee261}=_0x16a828[_0x26973c(0x119)],_0x4ec704=_0x16a828[_0x26973c(0xdd)][_0x26973c(0x104)];let _0x3c7c81;try{const [_0x2f512c]=await conn[_0x26973c(0x11c)]()['execute'](_0x26973c(0x125),[_0x4ec704]);_0x2f512c[_0x26973c(0xff)]>0x0&&(_0x3c7c81=_0x2f512c[0x0]);}catch(_0x5d415a){console['log']({'err':_0x5d415a}),_0x512d9e['status'](0x1f4)[_0x26973c(0xf4)]({'error':_0x26973c(0x12a)});return;}if(!_0x3c7c81){_0x512d9e[_0x26973c(0x11d)](0x191)[_0x26973c(0xf4)]({'error':'Invalid\x20user'});return;}console[_0x26973c(0x127)]({'req':_0x16a828[_0x26973c(0x119)]});let _0x19e4d5=_0x3c7c81[_0x26973c(0xf2)];if(_0x16a828[_0x26973c(0x120)]){const _0x4785f7=_0x26973c(0x117)+randomUUID()+_0x26973c(0xed);fs['renameSync'](_0x16a828[_0x26973c(0x120)][_0x26973c(0xf1)],'./'+_0x4785f7),_0x19e4d5=config[_0x26973c(0x10e)]+'/'+_0x4785f7;}try{await conn[_0x26973c(0x11c)]()[_0x26973c(0x129)](_0x26973c(0x113),[_0x98d022,_0x44cf20,_0x2ee261,_0x19e4d5,_0x4ec704]);let _0x3f9717;try{_0x3f9717=jwt[_0x26973c(0xf9)]({'userId':_0x3c7c81['id'],'email':_0x3c7c81[_0x26973c(0x104)]},config['jwtSecretKey'],{'expiresIn':'24h'});}catch(_0x386844){console[_0x26973c(0x127)](_0x386844),_0x512d9e[_0x26973c(0x11d)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x512d9e[_0x26973c(0x11d)](0xc8)[_0x26973c(0xf4)]({'success':!![],'data':{'userId':_0x3c7c81['id'],'username':_0x98d022,'first_name':_0x44cf20,'last_name':_0x2ee261,'email':_0x3c7c81[_0x26973c(0x104)],'avatar_url':_0x19e4d5,'token':_0x3f9717}});}catch(_0x3fe2e5){console[_0x26973c(0x127)]({'err':_0x3fe2e5}),_0x512d9e[_0x26973c(0x11d)](0x1f4)[_0x26973c(0xf4)]({'error':_0x26973c(0x12a)});return;}}),module['exports']=router;