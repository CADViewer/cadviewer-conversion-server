const a1_0x4f954f=a1_0x3727;(function(_0x5ee754,_0x3631a0){const _0x4439e3=a1_0x3727,_0xed4b0=_0x5ee754();while(!![]){try{const _0x77703f=parseInt(_0x4439e3(0x1c2))/0x1+parseInt(_0x4439e3(0x1ff))/0x2+-parseInt(_0x4439e3(0x1c7))/0x3*(-parseInt(_0x4439e3(0x208))/0x4)+-parseInt(_0x4439e3(0x1f7))/0x5*(-parseInt(_0x4439e3(0x1d5))/0x6)+-parseInt(_0x4439e3(0x1ec))/0x7*(parseInt(_0x4439e3(0x1eb))/0x8)+-parseInt(_0x4439e3(0x1d3))/0x9*(parseInt(_0x4439e3(0x20a))/0xa)+parseInt(_0x4439e3(0x1d9))/0xb*(-parseInt(_0x4439e3(0x1e8))/0xc);if(_0x77703f===_0x3631a0)break;else _0xed4b0['push'](_0xed4b0['shift']());}catch(_0x83d3e7){_0xed4b0['push'](_0xed4b0['shift']());}}}(a1_0x1627,0x71833));const jwt=require(a1_0x4f954f(0x1df)),bcrypt=require('bcrypt'),config=require(a1_0x4f954f(0x200)),conn=require('../libs/mysql.js'),multer=require('multer'),fs=require('fs'),verifyToken=require(a1_0x4f954f(0x202))[a1_0x4f954f(0x1d8)];function a1_0x3727(_0x1635c6,_0x51fe14){const _0x1627ff=a1_0x1627();return a1_0x3727=function(_0x37275c,_0x10874c){_0x37275c=_0x37275c-0x1bf;let _0x256a07=_0x1627ff[_0x37275c];return _0x256a07;},a1_0x3727(_0x1635c6,_0x51fe14);}!fs[a1_0x4f954f(0x1fb)](a1_0x4f954f(0x1c6))&&fs[a1_0x4f954f(0x1e3)](a1_0x4f954f(0x1c6));function a1_0x1627(){const _0x3794d4=['execute','ServerUrl','length','/validate-email/:token','diskStorage','40840WlzyXG','last_name','renameSync','log','existsSync','user','<p>Welcome\x20to\x20CADViewer</p>','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','1766530JQexxP','../CADViewer_config.json','/validate-email/','../libs/jwt','body','is_enabled','Router','avatar_url','email','81644iQhJms','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','1367240CXTSBu','Please\x20check\x20your\x20email\x20to\x20validate\x20your\x20account','json','24h','status','66241lioVLe','crypted_password','===================error===================','enableEmailVerification','./avatars','129LBNTgf','User\x20already\x20exists','/update-user-info','../libs/mail','express','params','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','role','/update-password','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','username','\x22\x20class=\x22button\x22>Validate\x20my\x20email\x20address</a>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20the\x20button\x20doesn\x27t\x20work,\x20you\x20can\x20copy\x20and\x20paste\x20this\x20link\x20in\x20your\x20browser:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22word-break:\x20break-all;\x22>','18CRVeDv','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','396BRJsNW','crypto','Error!\x20Something\x20went\x20wrong.','verifyToken','502370Hhmyxp','message','post','smtpFrom','sign','exports','jsonwebtoken','frontendUrl','Email\x20validated\x20successfully','jwtSecretKey','mkdirSync','promise','Invalid\x20user','.png','avatars/','228gIhFEE','path','insertId','6081136PzcFFw','7JtmNFp','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?)','first_name','Invalid\x20password','demo_user','stack'];a1_0x1627=function(){return _0x3794d4;};return a1_0x1627();}const express=require(a1_0x4f954f(0x1cb)),router=express[a1_0x4f954f(0x205)](),{randomUUID}=require(a1_0x4f954f(0x1d6)),storage=multer[a1_0x4f954f(0x1f6)]({'destination':function(_0x1e926c,_0x20469b,_0x4cd1e6){_0x4cd1e6(null,'avatars');}}),upload=multer({'storage':storage});router[a1_0x4f954f(0x1db)]('/login',async(_0x1749b7,_0x354484,_0x596b16)=>{const _0x350a49=a1_0x4f954f;let {email:_0x236f0f,password:_0x58caeb}=_0x1749b7[_0x350a49(0x203)];console['log']({'email':_0x236f0f,'password':_0x58caeb});let _0x284c74;try{const [_0x126869]=await conn[_0x350a49(0x1e4)]()['execute']('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x236f0f]);_0x126869[_0x350a49(0x1f4)]>0x0&&(_0x284c74=_0x126869[0x0]);}catch(_0x3726a8){console[_0x350a49(0x1fa)]({'err':_0x3726a8}),_0x354484[_0x350a49(0x1c1)](0x1f4)[_0x350a49(0x1bf)]({'error':_0x350a49(0x1d7)});return;}console[_0x350a49(0x1fa)](_0x284c74),console['log'](_0x58caeb),console[_0x350a49(0x1fa)](_0x284c74[_0x350a49(0x1c3)]);if(!_0x284c74||!await bcrypt['compare'](_0x58caeb,_0x284c74['crypted_password'])){_0x354484[_0x350a49(0x1c1)](0x191)[_0x350a49(0x1bf)]({'error':'Invalid\x20email\x20or\x20password'});return;}let _0x58b83c;try{_0x58b83c=jwt[_0x350a49(0x1dd)]({'userId':_0x284c74['id'],'email':_0x284c74['email']},config[_0x350a49(0x1e2)],{'expiresIn':_0x350a49(0x1c0)});}catch(_0x44a4ba){console[_0x350a49(0x1fa)](_0x44a4ba),_0x354484[_0x350a49(0x1c1)](0x1f4)[_0x350a49(0x1bf)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x354484[_0x350a49(0x1c1)](0xc8)['json']({'success':!![],'data':{'userId':_0x284c74['id'],'username':_0x284c74[_0x350a49(0x1d1)],'first_name':_0x284c74[_0x350a49(0x1ee)],'last_name':_0x284c74[_0x350a49(0x1f8)],'email':_0x284c74['email'],'avatar_url':_0x284c74['avatar_url'],'id':_0x284c74['id'],'role':_0x284c74['role'],'token':_0x58b83c}});}),router[a1_0x4f954f(0x1db)]('/signup',async(_0x3a4a49,_0x49de71,_0x41e47c)=>{const _0x4b1302=a1_0x4f954f,{username:_0x11df6a,email:_0x1139c9,password:_0x3611b8}=_0x3a4a49[_0x4b1302(0x203)],[_0x14e984]=await conn['promise']()[_0x4b1302(0x1f2)](_0x4b1302(0x209),[_0x1139c9]);if(_0x14e984[_0x4b1302(0x1f4)]>0x0){_0x49de71['status'](0x1a6)[_0x4b1302(0x1bf)]({'error':_0x4b1302(0x1c8)});return;}const _0x4c7ee8=await bcrypt['hash'](_0x3611b8,0xa);let _0x2d7515=null,_0x450591=0x1;config[_0x4b1302(0x1c5)]&&(_0x2d7515=randomUUID(),_0x450591=0x0);let _0x44185d;try{const _0x21973c=randomUUID(),_0x3ddf9c='./uploads/'+_0x21973c;fs[_0x4b1302(0x1e3)](_0x3ddf9c);const [_0x4a91a8]=await conn[_0x4b1302(0x1e4)]()[_0x4b1302(0x1f2)](_0x4b1302(0x1ed),[_0x11df6a,_0x1139c9,_0x4c7ee8,_0x4b1302(0x1f0),_0x450591,_0x2d7515,_0x21973c]);if(_0x4a91a8[_0x4b1302(0x1ea)]){const [_0x559b19]=await conn[_0x4b1302(0x1e4)]()['execute'](_0x4b1302(0x1d0),[_0x4a91a8['insertId']]);_0x559b19[_0x4b1302(0x1f4)]>0x0&&(_0x44185d=_0x559b19[0x0]);}}catch{_0x49de71[_0x4b1302(0x1c1)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}let _0x5aa8fe;try{_0x5aa8fe=jwt[_0x4b1302(0x1dd)]({'userId':_0x44185d['id'],'email':_0x44185d['email']},config[_0x4b1302(0x1e2)],{'expiresIn':'24h'});}catch(_0x34ee28){_0x49de71['status'](0x1f4)[_0x4b1302(0x1bf)]({'error':_0x4b1302(0x1d7)});return;}const _0x4cc628=require(_0x4b1302(0x1ca))['transporter'];let _0x54c4fe=_0x4b1302(0x1fd);if(config['enableEmailVerification']){const _0x59933c=config[_0x4b1302(0x1e0)]+_0x4b1302(0x201)+_0x2d7515;_0x54c4fe='\x0a\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.header\x20{\x20text-align:\x20center;\x20padding:\x2020px;\x20background:\x20#ea580c;\x20color:\x20white;\x20border-radius:\x205px\x205px\x200\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.content\x20{\x20padding:\x2020px;\x20background:\x20#f9f9f9;\x20border:\x201px\x20solid\x20#ddd;\x20border-radius:\x200\x200\x205px\x205px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button\x20{\x20display:\x20inline-block;\x20padding:\x2012px\x2024px;\x20background:\x20#ea580c;\x20color:\x20white\x20!important;\x20text-decoration:\x20none;\x20border-radius:\x205px;\x20margin:\x2020px\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.button:hover\x20{\x20background:\x20#f97316;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.footer\x20{\x20text-align:\x20center;\x20margin-top:\x2020px;\x20color:\x20#666;\x20font-size:\x2012px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20CADViewer!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x20are\x20delighted\x20to\x20welcome\x20you\x20to\x20our\x20community.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>To\x20start\x20using\x20CADViewer\x20Visual\x20Query,\x20please\x20validate\x20your\x20email\x20address\x20by\x20clicking\x20the\x20button\x20below:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22text-align:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22'+_0x59933c+_0x4b1302(0x1d2)+_0x59933c+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>This\x20email\x20was\x20sent\x20automatically,\x20please\x20do\x20not\x20reply.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20';const _0x524011={'from':config[_0x4b1302(0x1dc)],'to':_0x44185d[_0x4b1302(0x207)],'subject':'Welcome\x20to\x20CADViewer','text':'Welcome\x20to\x20CADViewer','html':_0x54c4fe};try{await _0x4cc628['sendMail'](_0x524011);}catch(_0x503180){console['log'](_0x4b1302(0x1c4)),console[_0x4b1302(0x1fa)](_0x503180),_0x49de71[_0x4b1302(0x1c1)](0x1f4)[_0x4b1302(0x1bf)]({'error':'Error!\x20Something\x20went\x20wrong\x20while\x20sending\x20the\x20email','stack':_0x503180[_0x4b1302(0x1f1)],'message':_0x503180[_0x4b1302(0x1da)]});return;}_0x49de71[_0x4b1302(0x1c1)](0xc8)['json']({'success':!![],'message':_0x4b1302(0x20b)});return;}_0x49de71['status'](0xc9)[_0x4b1302(0x1bf)]({'success':!![],'data':{'userId':_0x44185d['id'],'username':_0x44185d[_0x4b1302(0x1d1)],'first_name':_0x44185d[_0x4b1302(0x1ee)],'last_name':_0x44185d[_0x4b1302(0x1f8)],'email':_0x44185d[_0x4b1302(0x207)],'avatar_url':_0x44185d[_0x4b1302(0x206)],'id':_0x44185d['id'],'role':_0x44185d[_0x4b1302(0x1ce)],'token':_0x5aa8fe,'is_enabled':_0x44185d[_0x4b1302(0x204)]}});}),router['post'](a1_0x4f954f(0x1f5),async(_0x31e22d,_0x3026a2)=>{const _0x2cd4ed=a1_0x4f954f;try{const {token:_0x483ee0}=_0x31e22d[_0x2cd4ed(0x1cc)],[_0x595595]=await conn[_0x2cd4ed(0x1e4)]()[_0x2cd4ed(0x1f2)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?',[_0x483ee0]);if(_0x595595[_0x2cd4ed(0x1f4)]===0x0){_0x3026a2[_0x2cd4ed(0x1c1)](0x194)['json']({'error':'Invalid\x20validation\x20token'});return;}await conn[_0x2cd4ed(0x1e4)]()[_0x2cd4ed(0x1f2)](_0x2cd4ed(0x1fe),[_0x483ee0]);const _0x4278b1=jwt[_0x2cd4ed(0x1dd)]({'id':_0x595595[0x0]['id'],'email':_0x595595[0x0][_0x2cd4ed(0x207)]},config[_0x2cd4ed(0x1e2)],{'expiresIn':_0x2cd4ed(0x1c0)});_0x3026a2[_0x2cd4ed(0x1c1)](0xc8)[_0x2cd4ed(0x1bf)]({'success':!![],'message':_0x2cd4ed(0x1e1),'data':{'userId':_0x595595[0x0]['id'],'username':_0x595595[0x0][_0x2cd4ed(0x1d1)],'first_name':_0x595595[0x0]['first_name'],'last_name':_0x595595[0x0][_0x2cd4ed(0x1f8)],'email':_0x595595[0x0][_0x2cd4ed(0x207)],'avatar_url':_0x595595[0x0][_0x2cd4ed(0x206)],'id':_0x595595[0x0]['id'],'role':_0x595595[0x0]['role'],'token':_0x4278b1,'is_enabled':0x1}});}catch(_0x1224d8){console[_0x2cd4ed(0x1fa)](_0x2cd4ed(0x1c4)),console['log'](_0x1224d8),_0x3026a2['status'](0x1f4)['json']({'error':_0x2cd4ed(0x1d7),'stack':_0x1224d8[_0x2cd4ed(0x1f1)],'message':_0x1224d8[_0x2cd4ed(0x1da)]});}}),router[a1_0x4f954f(0x1db)](a1_0x4f954f(0x1cf),verifyToken,async(_0x3a5308,_0x18b60d,_0x3bdb25)=>{const _0x51343e=a1_0x4f954f,{current_password:_0x4fa7ef,new_password:_0x559e70}=_0x3a5308[_0x51343e(0x203)];console[_0x51343e(0x1fa)]({'body':_0x3a5308['body']});const _0x5bfeef=_0x3a5308[_0x51343e(0x1fc)]['email'];let _0x5b5171;try{const [_0x57329d]=await conn[_0x51343e(0x1e4)]()[_0x51343e(0x1f2)](_0x51343e(0x209),[_0x5bfeef]);if(_0x57329d[_0x51343e(0x1f4)]>0x0){_0x5b5171=_0x57329d[0x0];if(!await bcrypt['compare'](_0x4fa7ef,_0x5b5171[_0x51343e(0x1c3)])){_0x18b60d[_0x51343e(0x1c1)](0x191)[_0x51343e(0x1bf)]({'error':_0x51343e(0x1ef)});return;}const _0x53e1db=await bcrypt['hash'](_0x559e70,0xa);await conn[_0x51343e(0x1e4)]()[_0x51343e(0x1f2)](_0x51343e(0x1cd),[_0x53e1db,_0x5bfeef]),_0x18b60d[_0x51343e(0x1c1)](0xc8)[_0x51343e(0x1bf)]({'success':!![]});}}catch(_0x3ea364){console[_0x51343e(0x1fa)]({'err':_0x3ea364}),_0x18b60d['status'](0x1f4)[_0x51343e(0x1bf)]({'error':_0x51343e(0x1d7)});return;}}),router[a1_0x4f954f(0x1db)](a1_0x4f954f(0x1c9),upload['single']('avatar'),verifyToken,async(_0x2f548d,_0x5752dc,_0x4d8fc9)=>{const _0x5ccb04=a1_0x4f954f,{username:_0x3cb570,first_name:_0x3b79c6,last_name:_0x3a4876}=_0x2f548d[_0x5ccb04(0x203)],_0x4e0a0c=_0x2f548d[_0x5ccb04(0x1fc)][_0x5ccb04(0x207)];let _0x49a44a;try{const [_0x56f1db]=await conn[_0x5ccb04(0x1e4)]()[_0x5ccb04(0x1f2)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x4e0a0c]);_0x56f1db[_0x5ccb04(0x1f4)]>0x0&&(_0x49a44a=_0x56f1db[0x0]);}catch(_0x3b1d67){console[_0x5ccb04(0x1fa)]({'err':_0x3b1d67}),_0x5752dc['status'](0x1f4)[_0x5ccb04(0x1bf)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x49a44a){_0x5752dc[_0x5ccb04(0x1c1)](0x191)['json']({'error':_0x5ccb04(0x1e5)});return;}console['log']({'req':_0x2f548d[_0x5ccb04(0x203)]});let _0x8e2b6d=_0x49a44a[_0x5ccb04(0x206)];if(_0x2f548d['file']){const _0xd127c5=_0x5ccb04(0x1e7)+randomUUID()+_0x5ccb04(0x1e6);fs[_0x5ccb04(0x1f9)](_0x2f548d['file'][_0x5ccb04(0x1e9)],'./'+_0xd127c5),_0x8e2b6d=config[_0x5ccb04(0x1f3)]+'/'+_0xd127c5;}try{await conn[_0x5ccb04(0x1e4)]()[_0x5ccb04(0x1f2)](_0x5ccb04(0x1d4),[_0x3cb570,_0x3b79c6,_0x3a4876,_0x8e2b6d,_0x4e0a0c]);let _0x54b54a;try{_0x54b54a=jwt['sign']({'userId':_0x49a44a['id'],'email':_0x49a44a[_0x5ccb04(0x207)]},config[_0x5ccb04(0x1e2)],{'expiresIn':_0x5ccb04(0x1c0)});}catch(_0x493347){console[_0x5ccb04(0x1fa)](_0x493347),_0x5752dc['status'](0x1f4)['json']({'error':_0x5ccb04(0x1d7)});return;}_0x5752dc['status'](0xc8)[_0x5ccb04(0x1bf)]({'success':!![],'data':{'userId':_0x49a44a['id'],'username':_0x3cb570,'first_name':_0x3b79c6,'last_name':_0x3a4876,'email':_0x49a44a[_0x5ccb04(0x207)],'avatar_url':_0x8e2b6d,'token':_0x54b54a}});}catch(_0x4c266b){console['log']({'err':_0x4c266b}),_0x5752dc[_0x5ccb04(0x1c1)](0x1f4)[_0x5ccb04(0x1bf)]({'error':_0x5ccb04(0x1d7)});return;}}),module[a1_0x4f954f(0x1de)]=router;