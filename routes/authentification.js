const a1_0x31c80b=a1_0x33ff;(function(_0x5320f3,_0x2c94b2){const _0x35d9ea=a1_0x33ff,_0x12534c=_0x5320f3();while(!![]){try{const _0x56880f=parseInt(_0x35d9ea(0xb7))/0x1*(parseInt(_0x35d9ea(0xc0))/0x2)+-parseInt(_0x35d9ea(0xcc))/0x3*(-parseInt(_0x35d9ea(0xba))/0x4)+-parseInt(_0x35d9ea(0xc4))/0x5+parseInt(_0x35d9ea(0x95))/0x6+parseInt(_0x35d9ea(0xce))/0x7+parseInt(_0x35d9ea(0xa4))/0x8+-parseInt(_0x35d9ea(0xae))/0x9*(parseInt(_0x35d9ea(0xe0))/0xa);if(_0x56880f===_0x2c94b2)break;else _0x12534c['push'](_0x12534c['shift']());}catch(_0x34ab91){_0x12534c['push'](_0x12534c['shift']());}}}(a1_0x1284,0x75788));function a1_0x1284(){const _0x59aacb=['username','UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?','error-codes','mkdirSync','exports','10shvsWy','recaptchaSecretKey','https://www.google.com/recaptcha/api/siteverify','length','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','email','/update-password','name','user','params','ServerUrl','crypted_password','role','Invalid\x20validation\x20token','===================error===================','2885586gbUuNB','promise','bcrypt','../libs/email-utils','/validate-email/:token','first_name','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','code','Router','execute','file','languages','enableEmailVerification','crypto','../libs/jwt','681328PYSXQa','compare','single','success','json','is_enabled','last_name','Error\x20during\x20reCAPTCHA\x20verification.','demo_user','User\x20already\x20exists','3337983AxSMUO','avatars/','log','city','Invalid\x20user','express','path','status','country_name','1eXCcrW','sign','post','4DaEjIV','reCAPTCHA\x20verification\x20error:','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','avatar','axios','insertId','849038PDRfRm','Invalid\x20email\x20or\x20password','jsonwebtoken','error','4804920TnuUeX','multer','unlinkSync','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','diskStorage','body','24h','callbackMethod_gatewayUrl_flag','938577WTHuYd','Error\x20parsing\x20geolocation\x20data:','3566892jfINwi','jwtSecretKey','./uploads/','/login','Error!\x20Something\x20went\x20wrong.','./avatars','existsSync','/update-user-info','time_zone','hash','avatar_url','data','recaptchaEnabled'];a1_0x1284=function(){return _0x59aacb;};return a1_0x1284();}const jwt=require(a1_0x31c80b(0xc2)),bcrypt=require(a1_0x31c80b(0x97)),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x31c80b(0xc5)),fs=require('fs'),verifyToken=require(a1_0x31c80b(0xa3))['verifyToken'],{sendWelcomeEmail}=require(a1_0x31c80b(0x98)),axios=require(a1_0x31c80b(0xbe));!fs[a1_0x31c80b(0xd4)](a1_0x31c80b(0xd3))&&fs[a1_0x31c80b(0xde)](a1_0x31c80b(0xd3));const express=require(a1_0x31c80b(0xb3)),router=express[a1_0x31c80b(0x9d)](),{randomUUID}=require(a1_0x31c80b(0xa2)),storage=multer[a1_0x31c80b(0xc8)]({'destination':function(_0x466b2e,_0x4e10f0,_0xd67e2d){_0xd67e2d(null,'avatars');}}),upload=multer({'storage':storage});function a1_0x33ff(_0x12984c,_0x438720){const _0x1284a9=a1_0x1284();return a1_0x33ff=function(_0x33ff49,_0x342883){_0x33ff49=_0x33ff49-0x8c;let _0x2fdd5f=_0x1284a9[_0x33ff49];return _0x2fdd5f;},a1_0x33ff(_0x12984c,_0x438720);}router[a1_0x31c80b(0xb9)](a1_0x31c80b(0xd1),async(_0x5509e0,_0x2ae403,_0x57c56b)=>{const _0x402aaa=a1_0x31c80b;let {email:_0x490ffa,password:_0x5701f0}=_0x5509e0[_0x402aaa(0xc9)];console[_0x402aaa(0xb0)]({'email':_0x490ffa,'password':_0x5701f0});let _0x2a4676;try{const [_0x5a32de]=await conn['promise']()[_0x402aaa(0x9e)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x490ffa]);_0x5a32de[_0x402aaa(0xe3)]>0x0&&(_0x2a4676=_0x5a32de[0x0]);}catch(_0x42b315){console['log']({'err':_0x42b315}),_0x2ae403[_0x402aaa(0xb5)](0x1f4)['json']({'error':_0x402aaa(0xd2)});return;}if(!_0x2a4676||!await bcrypt['compare'](_0x5701f0,_0x2a4676?.[_0x402aaa(0x91)])){_0x2ae403[_0x402aaa(0xb5)](0x191)[_0x402aaa(0xa8)]({'error':_0x402aaa(0xc1)});return;}let _0x2347e3;try{_0x2347e3=jwt[_0x402aaa(0xb8)]({'userId':_0x2a4676['id'],'email':_0x2a4676[_0x402aaa(0xe5)]},config[_0x402aaa(0xcf)],{'expiresIn':_0x402aaa(0xca)});}catch(_0x467738){console[_0x402aaa(0xb0)](_0x467738),_0x2ae403[_0x402aaa(0xb5)](0x1f4)[_0x402aaa(0xa8)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x2ae403[_0x402aaa(0xb5)](0xc8)[_0x402aaa(0xa8)]({'success':!![],'data':{'userId':_0x2a4676['id'],'username':_0x2a4676['username'],'first_name':_0x2a4676['first_name'],'last_name':_0x2a4676[_0x402aaa(0xaa)],'email':_0x2a4676['email'],'avatar_url':_0x2a4676['avatar_url'],'id':_0x2a4676['id'],'role':_0x2a4676['role'],'token':_0x2347e3}});}),router['post']('/signup',async(_0x2b98d4,_0xc1ed76,_0x372178)=>{const _0xa41a32=a1_0x31c80b,{username:_0x2e4cae,email:_0x369c53,password:_0x5a8a44,geolocation:_0x4ee4a8,recaptchaToken:_0x3b8fec}=_0x2b98d4[_0xa41a32(0xc9)];if(config[_0xa41a32(0xda)]){if(!_0x3b8fec)return _0xc1ed76[_0xa41a32(0xb5)](0x190)['json']({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.'});try{const _0x1ded4e=await axios['post'](_0xa41a32(0xe2),null,{'params':{'secret':config[_0xa41a32(0xe1)],'response':_0x3b8fec}});if(!_0x1ded4e[_0xa41a32(0xd9)][_0xa41a32(0xa7)])return _0xc1ed76[_0xa41a32(0xb5)](0x190)['json']({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','recaptchaErrors':_0x1ded4e[_0xa41a32(0xd9)][_0xa41a32(0xdd)]});}catch(_0x388568){return console[_0xa41a32(0xc3)](_0xa41a32(0xbb),_0x388568),_0xc1ed76[_0xa41a32(0xb5)](0x1f4)['json']({'error':_0xa41a32(0xab)});}}const [_0x134be8]=await conn[_0xa41a32(0x96)]()[_0xa41a32(0x9e)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x369c53]);if(_0x134be8[_0xa41a32(0xe3)]>0x0){_0xc1ed76[_0xa41a32(0xb5)](0x1a6)[_0xa41a32(0xa8)]({'error':_0xa41a32(0xad)});return;}const _0x4ca066=await bcrypt[_0xa41a32(0xd7)](_0x5a8a44,0xa);let _0x5da18c=null,_0x1e3d4b=0x1;config[_0xa41a32(0xa1)]&&(_0x5da18c=randomUUID(),_0x1e3d4b=0x0);let _0x544e29=null,_0x31d8eb=null,_0x5a9747=null,_0x536cf1=null,_0x5ce507=null,_0x3026b0=null;if(_0x4ee4a8)try{const _0x436ba1=_0x4ee4a8;_0x544e29=_0x436ba1[_0xa41a32(0xb1)]||null,_0x31d8eb=_0x436ba1['region']||null,_0x5a9747=_0x436ba1[_0xa41a32(0xb6)]||null,_0x436ba1['languages']&&_0x436ba1[_0xa41a32(0xa0)][_0xa41a32(0xe3)]>0x0&&(_0x536cf1=_0x436ba1[_0xa41a32(0xa0)][0x0][_0xa41a32(0x9c)]||null,_0x5ce507=_0x436ba1[_0xa41a32(0xa0)][0x0][_0xa41a32(0x8d)]||null),_0x436ba1[_0xa41a32(0xd6)]&&(_0x3026b0=_0x436ba1[_0xa41a32(0xd6)][_0xa41a32(0x8d)]||null);}catch(_0x1c487c){console['log'](_0xa41a32(0xcd),_0x1c487c);}let _0x48a4c6;try{const _0x14898f=randomUUID(),_0x49b34a=_0xa41a32(0xd0)+_0x14898f;fs[_0xa41a32(0xde)](_0x49b34a);const [_0x8a8c87]=await conn[_0xa41a32(0x96)]()[_0xa41a32(0x9e)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x2e4cae,_0x369c53,_0x4ca066,_0xa41a32(0xac),_0x1e3d4b,_0x5da18c,_0x14898f,_0x544e29,_0x31d8eb,_0x5a9747,_0x536cf1,_0x5ce507,_0x3026b0]);if(_0x8a8c87[_0xa41a32(0xbf)]){const [_0x323628]=await conn[_0xa41a32(0x96)]()[_0xa41a32(0x9e)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x8a8c87[_0xa41a32(0xbf)]]);_0x323628[_0xa41a32(0xe3)]>0x0&&(_0x48a4c6=_0x323628[0x0]);}}catch(_0x95bfa3){console[_0xa41a32(0xb0)]('Error\x20during\x20user\x20creation:',_0x95bfa3),_0xc1ed76[_0xa41a32(0xb5)](0x1f4)['json']({'error':_0xa41a32(0xd2)});return;}let _0x6dd91b;try{_0x6dd91b=jwt[_0xa41a32(0xb8)]({'userId':_0x48a4c6['id'],'email':_0x48a4c6[_0xa41a32(0xe5)]},config['jwtSecretKey'],{'expiresIn':_0xa41a32(0xca)});}catch(_0x1b6a2c){_0xc1ed76[_0xa41a32(0xb5)](0x1f4)['json']({'error':_0xa41a32(0xd2)});return;}if(config['enableEmailVerification']){try{await sendWelcomeEmail(_0x48a4c6,_0x5da18c);}catch(_0x4bf04b){console[_0xa41a32(0xb0)](_0xa41a32(0x94)),console[_0xa41a32(0xb0)](_0x4bf04b);}_0xc1ed76[_0xa41a32(0xb5)](0xc8)[_0xa41a32(0xa8)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.'});return;}_0xc1ed76[_0xa41a32(0xb5)](0xc9)[_0xa41a32(0xa8)]({'success':!![],'data':{'userId':_0x48a4c6['id'],'username':_0x48a4c6[_0xa41a32(0xdb)],'first_name':_0x48a4c6[_0xa41a32(0x9a)],'last_name':_0x48a4c6[_0xa41a32(0xaa)],'email':_0x48a4c6[_0xa41a32(0xe5)],'avatar_url':_0x48a4c6[_0xa41a32(0xd8)],'id':_0x48a4c6['id'],'role':_0x48a4c6[_0xa41a32(0x92)],'token':_0x6dd91b,'is_enabled':_0x48a4c6[_0xa41a32(0xa9)]}});}),router[a1_0x31c80b(0xb9)](a1_0x31c80b(0x99),async(_0x3545a9,_0x1a7c1f)=>{const _0x2ee01b=a1_0x31c80b;try{const {token:_0x1f6392}=_0x3545a9[_0x2ee01b(0x8f)],[_0x565678]=await conn[_0x2ee01b(0x96)]()['execute'](_0x2ee01b(0xe4),[_0x1f6392]);if(_0x565678[_0x2ee01b(0xe3)]===0x0){_0x1a7c1f[_0x2ee01b(0xb5)](0x194)['json']({'error':_0x2ee01b(0x93)});return;}await conn[_0x2ee01b(0x96)]()[_0x2ee01b(0x9e)](_0x2ee01b(0xdc),[_0x1f6392]);const _0x16ed52=jwt[_0x2ee01b(0xb8)]({'id':_0x565678[0x0]['id'],'email':_0x565678[0x0]['email']},config['jwtSecretKey'],{'expiresIn':_0x2ee01b(0xca)});_0x1a7c1f['status'](0xc8)[_0x2ee01b(0xa8)]({'success':!![],'message':'Email\x20validated\x20successfully','data':{'userId':_0x565678[0x0]['id'],'username':_0x565678[0x0][_0x2ee01b(0xdb)],'first_name':_0x565678[0x0][_0x2ee01b(0x9a)],'last_name':_0x565678[0x0][_0x2ee01b(0xaa)],'email':_0x565678[0x0][_0x2ee01b(0xe5)],'avatar_url':_0x565678[0x0][_0x2ee01b(0xd8)],'id':_0x565678[0x0]['id'],'role':_0x565678[0x0][_0x2ee01b(0x92)],'token':_0x16ed52,'is_enabled':0x1}});}catch(_0x6fd86b){console[_0x2ee01b(0xb0)](_0x2ee01b(0x94)),console[_0x2ee01b(0xb0)](_0x6fd86b),_0x1a7c1f[_0x2ee01b(0xb5)](0x1f4)[_0x2ee01b(0xa8)]({'error':_0x2ee01b(0xd2),'stack':_0x6fd86b['stack'],'message':_0x6fd86b['message']});}}),router[a1_0x31c80b(0xb9)](a1_0x31c80b(0x8c),verifyToken,async(_0x553f86,_0x1b4171,_0x49897c)=>{const _0x49e2f4=a1_0x31c80b,{current_password:_0x468dec,new_password:_0x47fb1b}=_0x553f86[_0x49e2f4(0xc9)];console['log']({'body':_0x553f86[_0x49e2f4(0xc9)]});const _0x4dd8c4=_0x553f86[_0x49e2f4(0x8e)][_0x49e2f4(0xe5)];let _0x1405e;try{const [_0x4d7af2]=await conn['promise']()[_0x49e2f4(0x9e)](_0x49e2f4(0xc7),[_0x4dd8c4]);if(_0x4d7af2['length']>0x0){_0x1405e=_0x4d7af2[0x0];if(!await bcrypt[_0x49e2f4(0xa5)](_0x468dec,_0x1405e[_0x49e2f4(0x91)])){_0x1b4171[_0x49e2f4(0xb5)](0x191)[_0x49e2f4(0xa8)]({'error':'Invalid\x20password'});return;}const _0x1f68ca=await bcrypt[_0x49e2f4(0xd7)](_0x47fb1b,0xa);await conn['promise']()[_0x49e2f4(0x9e)](_0x49e2f4(0xbc),[_0x1f68ca,_0x4dd8c4]),_0x1b4171[_0x49e2f4(0xb5)](0xc8)[_0x49e2f4(0xa8)]({'success':!![]});}}catch(_0xf39d7c){console[_0x49e2f4(0xb0)]({'err':_0xf39d7c}),_0x1b4171[_0x49e2f4(0xb5)](0x1f4)[_0x49e2f4(0xa8)]({'error':_0x49e2f4(0xd2)});return;}}),router[a1_0x31c80b(0xb9)](a1_0x31c80b(0xd5),upload[a1_0x31c80b(0xa6)](a1_0x31c80b(0xbd)),verifyToken,async(_0x2c487d,_0x51db21,_0x479edb)=>{const _0x10b64f=a1_0x31c80b,{username:_0x3f6e43,first_name:_0x366688,last_name:_0xaca55}=_0x2c487d[_0x10b64f(0xc9)],_0x227b9c=_0x2c487d['user'][_0x10b64f(0xe5)];let _0x426f0c;try{const [_0x2fa3f0]=await conn[_0x10b64f(0x96)]()['execute'](_0x10b64f(0xc7),[_0x227b9c]);_0x2fa3f0['length']>0x0&&(_0x426f0c=_0x2fa3f0[0x0]);}catch(_0x4773c2){console[_0x10b64f(0xb0)]({'err':_0x4773c2}),_0x51db21[_0x10b64f(0xb5)](0x1f4)[_0x10b64f(0xa8)]({'error':_0x10b64f(0xd2)});return;}if(!_0x426f0c){_0x51db21[_0x10b64f(0xb5)](0x191)['json']({'error':_0x10b64f(0xb2)});return;}console[_0x10b64f(0xb0)]({'req':_0x2c487d[_0x10b64f(0xc9)]});let _0x3e7c3d=_0x426f0c[_0x10b64f(0xd8)];if(_0x2c487d[_0x10b64f(0x9f)]){const _0x2bdec0=_0x10b64f(0xaf)+randomUUID()+'.png';fs['copyFileSync'](_0x2c487d[_0x10b64f(0x9f)][_0x10b64f(0xb4)],'./'+_0x2bdec0),fs[_0x10b64f(0xc6)](_0x2c487d['file'][_0x10b64f(0xb4)]),config[_0x10b64f(0xcb)]?_0x3e7c3d=config['callbackMethod_gatewayUrl']+'/'+_0x2bdec0:_0x3e7c3d=config[_0x10b64f(0x90)]+'/'+_0x2bdec0;}try{await conn[_0x10b64f(0x96)]()[_0x10b64f(0x9e)](_0x10b64f(0x9b),[_0x3f6e43,_0x366688,_0xaca55,_0x3e7c3d,_0x227b9c]);let _0x4be18f;try{_0x4be18f=jwt[_0x10b64f(0xb8)]({'userId':_0x426f0c['id'],'email':_0x426f0c[_0x10b64f(0xe5)]},config[_0x10b64f(0xcf)],{'expiresIn':_0x10b64f(0xca)});}catch(_0x421059){console[_0x10b64f(0xb0)](_0x421059),_0x51db21['status'](0x1f4)[_0x10b64f(0xa8)]({'error':_0x10b64f(0xd2)});return;}_0x51db21[_0x10b64f(0xb5)](0xc8)[_0x10b64f(0xa8)]({'success':!![],'data':{'userId':_0x426f0c['id'],'username':_0x3f6e43,'first_name':_0x366688,'last_name':_0xaca55,'email':_0x426f0c[_0x10b64f(0xe5)],'avatar_url':_0x3e7c3d,'token':_0x4be18f}});}catch(_0x1838c9){console[_0x10b64f(0xb0)]({'err':_0x1838c9}),_0x51db21[_0x10b64f(0xb5)](0x1f4)[_0x10b64f(0xa8)]({'error':_0x10b64f(0xd2)});return;}}),module[a1_0x31c80b(0xdf)]=router;