const a1_0x3a0fce=a1_0x2789;(function(_0x22327f,_0x116866){const _0x1cb000=a1_0x2789,_0x33b0a4=_0x22327f();while(!![]){try{const _0x4c2078=parseInt(_0x1cb000(0x184))/0x1*(-parseInt(_0x1cb000(0x176))/0x2)+parseInt(_0x1cb000(0x178))/0x3+parseInt(_0x1cb000(0x170))/0x4+-parseInt(_0x1cb000(0x18c))/0x5+-parseInt(_0x1cb000(0x1a3))/0x6+-parseInt(_0x1cb000(0x17a))/0x7+parseInt(_0x1cb000(0x198))/0x8;if(_0x4c2078===_0x116866)break;else _0x33b0a4['push'](_0x33b0a4['shift']());}catch(_0x4c754e){_0x33b0a4['push'](_0x33b0a4['shift']());}}}(a1_0x1c55,0x3c14d));function a1_0x2789(_0x18def3,_0x4a222c){const _0x1c558a=a1_0x1c55();return a1_0x2789=function(_0x2789b0,_0x25b758){_0x2789b0=_0x2789b0-0x16c;let _0x425c87=_0x1c558a[_0x2789b0];return _0x425c87;},a1_0x2789(_0x18def3,_0x4a222c);}const jwt=require(a1_0x3a0fce(0x174)),bcrypt=require(a1_0x3a0fce(0x192)),config=require(a1_0x3a0fce(0x187)),conn=require(a1_0x3a0fce(0x16f)),multer=require(a1_0x3a0fce(0x173)),fs=require('fs'),verifyToken=require(a1_0x3a0fce(0x199))[a1_0x3a0fce(0x19d)];!fs['existsSync'](a1_0x3a0fce(0x181))&&fs['mkdirSync']('./avatars');const express=require(a1_0x3a0fce(0x1a4)),router=express['Router'](),{randomUUID}=require('crypto'),storage=multer[a1_0x3a0fce(0x18d)]({'destination':function(_0xbb94cb,_0x60fef8,_0xe6b7c8){const _0x56e880=a1_0x3a0fce;_0xe6b7c8(null,_0x56e880(0x1a5));}}),upload=multer({'storage':storage});function a1_0x1c55(){const _0x2f5538=['exports','avatar','last_name','post','4757848uSyLwM','../libs/jwt','User\x20already\x20exists','file','sign','verifyToken','/signup','jwtSecretKey','role','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','avatar_url','1964658IRvAqH','express','avatars','Invalid\x20email\x20or\x20password','/login','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','Error!\x20Something\x20went\x20wrong.','length','Invalid\x20password','compare','../libs/mysql.js','1186176nBLexx','body','status','multer','jsonwebtoken','user','362506jpOSak','first_name','1164786tzykpa','json','467089tHzaJT','crypted_password','.png','username','single','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','renameSync','./avatars','Invalid\x20user','path','2WjYZvO','ServerUrl','email','../CADViewer_config.json','24h','execute','promise','hash','1383840nFfJSR','diskStorage','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','/update-password','insertId','log','bcrypt','avatars/'];a1_0x1c55=function(){return _0x2f5538;};return a1_0x1c55();}router[a1_0x3a0fce(0x197)](a1_0x3a0fce(0x1a7),async(_0x189b9a,_0x2cf011,_0x77a52)=>{const _0x183565=a1_0x3a0fce;let {email:_0x5eddb3,password:_0x3373cd}=_0x189b9a[_0x183565(0x171)];console['log']({'email':_0x5eddb3,'password':_0x3373cd});let _0x3ea684;try{const [_0x46a5aa]=await conn['promise']()[_0x183565(0x189)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x5eddb3]);_0x46a5aa[_0x183565(0x16c)]>0x0&&(_0x3ea684=_0x46a5aa[0x0]);}catch(_0x381001){console[_0x183565(0x191)]({'err':_0x381001}),_0x2cf011[_0x183565(0x172)](0x1f4)['json']({'error':'Error!\x20Something\x20went\x20wrong.'});return;}console[_0x183565(0x191)](_0x3ea684),console[_0x183565(0x191)](_0x3373cd),console['log'](_0x3ea684[_0x183565(0x17b)]);if(!_0x3ea684||!await bcrypt['compare'](_0x3373cd,_0x3ea684[_0x183565(0x17b)])){_0x2cf011[_0x183565(0x172)](0x191)[_0x183565(0x179)]({'error':_0x183565(0x1a6)});return;}let _0x2234e8;try{_0x2234e8=jwt[_0x183565(0x19c)]({'userId':_0x3ea684['id'],'email':_0x3ea684[_0x183565(0x186)]},config['jwtSecretKey'],{'expiresIn':_0x183565(0x188)});}catch(_0x411e8f){console['log'](_0x411e8f),_0x2cf011[_0x183565(0x172)](0x1f4)[_0x183565(0x179)]({'error':_0x183565(0x1a9)});return;}_0x2cf011[_0x183565(0x172)](0xc8)[_0x183565(0x179)]({'success':!![],'data':{'userId':_0x3ea684['id'],'username':_0x3ea684[_0x183565(0x17d)],'first_name':_0x3ea684[_0x183565(0x177)],'last_name':_0x3ea684['last_name'],'email':_0x3ea684[_0x183565(0x186)],'avatar_url':_0x3ea684[_0x183565(0x1a2)],'id':_0x3ea684['id'],'role':_0x3ea684[_0x183565(0x1a0)],'token':_0x2234e8}});}),router[a1_0x3a0fce(0x197)](a1_0x3a0fce(0x19e),async(_0x18f73e,_0x54467b,_0x1b6b6f)=>{const _0x2a69b1=a1_0x3a0fce,{username:_0x39f445,email:_0x9f6730,password:_0x55dcdb}=_0x18f73e['body'],[_0x38822f]=await conn[_0x2a69b1(0x18a)]()[_0x2a69b1(0x189)](_0x2a69b1(0x1a8),[_0x9f6730]);if(_0x38822f['length']>0x0){_0x54467b['status'](0x1a6)[_0x2a69b1(0x179)]({'error':_0x2a69b1(0x19a)});return;}const _0x47440c=await bcrypt[_0x2a69b1(0x18b)](_0x55dcdb,0xa);try{const [_0x104439]=await conn[_0x2a69b1(0x18a)]()[_0x2a69b1(0x189)]('INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x201)',[_0x39f445,_0x9f6730,_0x47440c,_0x2a69b1(0x175)]);if(_0x104439[_0x2a69b1(0x190)]){const [_0x53de48]=await conn[_0x2a69b1(0x18a)]()['execute'](_0x2a69b1(0x18e),[_0x104439['insertId']]);_0x53de48['length']>0x0&&(newUser=_0x53de48[0x0]);}}catch{_0x54467b['status'](0x1f4)[_0x2a69b1(0x179)]({'error':_0x2a69b1(0x1a9)});return;}let _0xec66b8;try{_0xec66b8=jwt[_0x2a69b1(0x19c)]({'userId':newUser['id'],'email':newUser[_0x2a69b1(0x186)]},config['jwtSecretKey'],{'expiresIn':'24h'});}catch(_0x139a2c){_0x54467b[_0x2a69b1(0x172)](0x1f4)[_0x2a69b1(0x179)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x54467b[_0x2a69b1(0x172)](0xc9)[_0x2a69b1(0x179)]({'success':!![],'data':{'userId':newUser['id'],'username':newUser[_0x2a69b1(0x17d)],'first_name':newUser[_0x2a69b1(0x177)],'last_name':newUser[_0x2a69b1(0x196)],'email':newUser['email'],'avatar_url':newUser[_0x2a69b1(0x1a2)],'id':newUser['id'],'role':newUser['role'],'token':_0xec66b8}});}),router[a1_0x3a0fce(0x197)](a1_0x3a0fce(0x18f),verifyToken,async(_0x551a78,_0x124228,_0x10f2a7)=>{const _0x14c1d2=a1_0x3a0fce,{current_password:_0x19572f,new_password:_0x2228ec}=_0x551a78[_0x14c1d2(0x171)];console[_0x14c1d2(0x191)]({'body':_0x551a78[_0x14c1d2(0x171)]});const _0x3cf030=_0x551a78[_0x14c1d2(0x175)]['email'];let _0x11cfb8;try{const [_0x17bc94]=await conn[_0x14c1d2(0x18a)]()[_0x14c1d2(0x189)](_0x14c1d2(0x1a8),[_0x3cf030]);if(_0x17bc94[_0x14c1d2(0x16c)]>0x0){_0x11cfb8=_0x17bc94[0x0];if(!await bcrypt[_0x14c1d2(0x16e)](_0x19572f,_0x11cfb8[_0x14c1d2(0x17b)])){_0x124228[_0x14c1d2(0x172)](0x191)[_0x14c1d2(0x179)]({'error':_0x14c1d2(0x16d)});return;}const _0x1ee8f1=await bcrypt[_0x14c1d2(0x18b)](_0x2228ec,0xa);await conn[_0x14c1d2(0x18a)]()['execute'](_0x14c1d2(0x17f),[_0x1ee8f1,_0x3cf030]),_0x124228['status'](0xc8)['json']({'success':!![]});}}catch(_0xe3a82f){console[_0x14c1d2(0x191)]({'err':_0xe3a82f}),_0x124228[_0x14c1d2(0x172)](0x1f4)[_0x14c1d2(0x179)]({'error':_0x14c1d2(0x1a9)});return;}}),router[a1_0x3a0fce(0x197)]('/update-user-info',upload[a1_0x3a0fce(0x17e)](a1_0x3a0fce(0x195)),verifyToken,async(_0x2bac7b,_0x4d69c0,_0x53959d)=>{const _0x2025d1=a1_0x3a0fce,{username:_0x7b0b14,first_name:_0x4dfdce,last_name:_0x2247a1}=_0x2bac7b[_0x2025d1(0x171)],_0x20647b=_0x2bac7b['user']['email'];let _0x562811;try{const [_0x37c69e]=await conn[_0x2025d1(0x18a)]()[_0x2025d1(0x189)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x20647b]);_0x37c69e[_0x2025d1(0x16c)]>0x0&&(_0x562811=_0x37c69e[0x0]);}catch(_0x5c9d01){console[_0x2025d1(0x191)]({'err':_0x5c9d01}),_0x4d69c0['status'](0x1f4)[_0x2025d1(0x179)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(!_0x562811){_0x4d69c0[_0x2025d1(0x172)](0x191)['json']({'error':_0x2025d1(0x182)});return;}console[_0x2025d1(0x191)]({'req':_0x2bac7b[_0x2025d1(0x171)]});let _0x481f14=_0x562811[_0x2025d1(0x1a2)];if(_0x2bac7b[_0x2025d1(0x19b)]){const _0x20cfda=_0x2025d1(0x193)+randomUUID()+_0x2025d1(0x17c);fs[_0x2025d1(0x180)](_0x2bac7b[_0x2025d1(0x19b)][_0x2025d1(0x183)],'./'+_0x20cfda),_0x481f14=config[_0x2025d1(0x185)]+'/'+_0x20cfda;}try{await conn[_0x2025d1(0x18a)]()[_0x2025d1(0x189)](_0x2025d1(0x1a1),[_0x7b0b14,_0x4dfdce,_0x2247a1,_0x481f14,_0x20647b]);let _0x2563dd;try{_0x2563dd=jwt[_0x2025d1(0x19c)]({'userId':_0x562811['id'],'email':_0x562811['email']},config[_0x2025d1(0x19f)],{'expiresIn':_0x2025d1(0x188)});}catch(_0xe25bb9){console[_0x2025d1(0x191)](_0xe25bb9),_0x4d69c0[_0x2025d1(0x172)](0x1f4)[_0x2025d1(0x179)]({'error':_0x2025d1(0x1a9)});return;}_0x4d69c0[_0x2025d1(0x172)](0xc8)[_0x2025d1(0x179)]({'success':!![],'data':{'userId':_0x562811['id'],'username':_0x7b0b14,'first_name':_0x4dfdce,'last_name':_0x2247a1,'email':_0x562811[_0x2025d1(0x186)],'avatar_url':_0x481f14,'token':_0x2563dd}});}catch(_0x3f8f61){console['log']({'err':_0x3f8f61}),_0x4d69c0[_0x2025d1(0x172)](0x1f4)[_0x2025d1(0x179)]({'error':_0x2025d1(0x1a9)});return;}}),module[a1_0x3a0fce(0x194)]=router;